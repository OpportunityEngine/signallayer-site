<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload MLA Contracts - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0f1a 0%, #0d1321 50%, #0a0f1a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      line-height: 1.6;
    }

    .page-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(ellipse at top left, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at bottom right, rgba(30, 58, 138, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 24px;
      position: relative;
      z-index: 1;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      text-decoration: none;
      margin-bottom: 32px;
      font-size: 14px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #fbbf24;
    }

    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .subtitle {
      color: #94a3b8;
    }

    .download-template {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 10px;
      color: #fbbf24;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .download-template:hover {
      background: rgba(251, 191, 36, 0.2);
      border-color: #fbbf24;
    }

    /* Main Upload Card */
    .upload-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 24px;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed rgba(251, 191, 36, 0.3);
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(15, 23, 42, 0.4);
    }

    .drop-zone:hover {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.05);
    }

    .drop-zone.dragover {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
      transform: scale(1.02);
    }

    .drop-zone.has-file {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.05);
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      color: #fbbf24;
    }

    .drop-zone h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .drop-zone p {
      color: #94a3b8;
      font-size: 14px;
    }

    .file-types {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .file-type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(251, 191, 36, 0.1);
      border-radius: 6px;
      font-size: 12px;
      color: #fbbf24;
      font-weight: 500;
    }

    .file-input {
      display: none;
    }

    /* Selected File Display */
    .selected-file {
      display: none;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      margin-top: 20px;
    }

    .selected-file.show {
      display: flex;
    }

    .file-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(34, 197, 94, 0.2);
      border-radius: 10px;
      color: #22c55e;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .file-size {
      font-size: 13px;
      color: #94a3b8;
    }

    .remove-file {
      padding: 8px;
      background: rgba(239, 68, 68, 0.1);
      border: none;
      border-radius: 8px;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.2s;
    }

    .remove-file:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Upload Options */
    .upload-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .option-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .option-group label {
      font-size: 13px;
      font-weight: 500;
      color: #94a3b8;
    }

    .option-group select {
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-group select:hover {
      border-color: rgba(251, 191, 36, 0.3);
    }

    .option-group select:focus {
      outline: none;
      border-color: #fbbf24;
    }

    /* Upload Button */
    .upload-btn {
      width: 100%;
      padding: 16px 32px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: none;
      border-radius: 12px;
      color: #0a0f1a;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 24px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
    }

    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .upload-btn .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: #0a0f1a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .upload-btn.loading .spinner {
      display: block;
    }

    .upload-btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Card */
    .progress-card {
      display: none;
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .progress-card.show {
      display: block;
    }

    .progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .progress-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .progress-status {
      font-size: 14px;
      color: #fbbf24;
    }

    .progress-bar-container {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .progress-stat {
      text-align: center;
      padding: 12px;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 10px;
    }

    .progress-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .progress-stat-label {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Results Card */
    .results-card {
      display: none;
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .results-card.show {
      display: block;
    }

    .results-card.error {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .results-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .results-icon {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(34, 197, 94, 0.2);
      border-radius: 14px;
      color: #22c55e;
    }

    .results-card.error .results-icon {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .results-title {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .results-subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    .results-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .result-stat {
      padding: 20px;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 12px;
      text-align: center;
    }

    .result-stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .result-stat-value.success {
      color: #22c55e;
    }

    .result-stat-value.warning {
      color: #f59e0b;
    }

    .result-stat-value.error {
      color: #ef4444;
    }

    .result-stat-value.money {
      color: #fbbf24;
    }

    .result-stat-label {
      font-size: 13px;
      color: #94a3b8;
    }

    /* Preview Table */
    .preview-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .preview-title {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
    }

    .preview-badge {
      padding: 4px 12px;
      background: rgba(251, 191, 36, 0.1);
      border-radius: 20px;
      font-size: 12px;
      color: #fbbf24;
    }

    .preview-table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .preview-table th {
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.6);
      color: #94a3b8;
      font-weight: 500;
      text-align: left;
      white-space: nowrap;
    }

    .preview-table td {
      padding: 12px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
    }

    .preview-table tr:hover td {
      background: rgba(251, 191, 36, 0.05);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status-badge.expiring {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .status-badge.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .action-btn {
      flex: 1;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: none;
      color: #0a0f1a;
    }

    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3);
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
    }

    .action-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* Template Info */
    .template-info {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .template-info h3 {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .template-columns {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .column-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 10px;
    }

    .column-item .required {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
    }

    .column-item .optional {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #64748b;
    }

    .column-name {
      font-weight: 500;
      color: #e2e8f0;
      font-size: 13px;
    }

    .column-type {
      font-size: 11px;
      color: #64748b;
      margin-left: auto;
    }

    .legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #94a3b8;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .legend-dot.required {
      background: #ef4444;
    }

    .legend-dot.optional {
      background: #64748b;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
        gap: 16px;
      }

      .upload-options {
        grid-template-columns: 1fr;
      }

      .progress-stats,
      .results-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .template-columns {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="page-bg"></div>

  <div class="container">
    <a href="/dashboard/" class="back-link">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Dashboard
    </a>

    <div class="page-header">
      <div>
        <h1>Upload MLA Contracts</h1>
        <p class="subtitle">Import your Master License Agreements via Excel or CSV</p>
      </div>
      <a href="#" class="download-template" id="downloadTemplate">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg>
        Download Template
      </a>
    </div>

    <!-- Template Info -->
    <div class="template-info">
      <h3>
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Expected Columns
      </h3>
      <div class="template-columns">
        <div class="column-item">
          <span class="required"></span>
          <span class="column-name">Account Name</span>
          <span class="column-type">text</span>
        </div>
        <div class="column-item">
          <span class="required"></span>
          <span class="column-name">Contract Number</span>
          <span class="column-type">text</span>
        </div>
        <div class="column-item">
          <span class="required"></span>
          <span class="column-name">Start Date</span>
          <span class="column-type">date</span>
        </div>
        <div class="column-item">
          <span class="required"></span>
          <span class="column-name">End Date</span>
          <span class="column-type">date</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Vendor Name</span>
          <span class="column-type">text</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Contract Value</span>
          <span class="column-type">currency</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Status</span>
          <span class="column-type">active/expiring/expired</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Renewal Likelihood</span>
          <span class="column-type">percentage</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Contact Name</span>
          <span class="column-type">text</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Contact Email</span>
          <span class="column-type">email</span>
        </div>
        <div class="column-item">
          <span class="optional"></span>
          <span class="column-name">Notes</span>
          <span class="column-type">text</span>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item">
          <span class="legend-dot required"></span>
          Required
        </div>
        <div class="legend-item">
          <span class="legend-dot optional"></span>
          Optional
        </div>
      </div>
    </div>

    <!-- Upload Card -->
    <div class="upload-card">
      <div class="drop-zone" id="dropZone">
        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <h3>Drop your MLA spreadsheet here</h3>
        <p>or click to browse files</p>
        <div class="file-types">
          <span class="file-type">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            </svg>
            .xlsx
          </span>
          <span class="file-type">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            </svg>
            .xls
          </span>
          <span class="file-type">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            </svg>
            .csv
          </span>
        </div>
        <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls,.csv">
      </div>

      <div class="selected-file" id="selectedFile">
        <div class="file-icon">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div class="file-info">
          <div class="file-name" id="fileName">contract-data.xlsx</div>
          <div class="file-size" id="fileSize">245 KB</div>
        </div>
        <button class="remove-file" id="removeFile">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="upload-options">
        <div class="option-group">
          <label>Duplicate Handling</label>
          <select id="duplicateHandling">
            <option value="skip">Skip duplicates</option>
            <option value="update">Update existing records</option>
            <option value="create">Create new records always</option>
          </select>
        </div>
        <div class="option-group">
          <label>Date Format</label>
          <select id="dateFormat">
            <option value="auto">Auto-detect</option>
            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
          </select>
        </div>
      </div>

      <button class="upload-btn" id="uploadBtn" disabled>
        <span class="spinner"></span>
        <span class="btn-text">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          Upload & Process
        </span>
      </button>
    </div>

    <!-- Progress Card -->
    <div class="progress-card" id="progressCard">
      <div class="progress-header">
        <span class="progress-title">Processing MLA Data...</span>
        <span class="progress-status" id="progressStatus">Validating...</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-stats">
        <div class="progress-stat">
          <div class="progress-stat-value" id="totalRows">0</div>
          <div class="progress-stat-label">Total Rows</div>
        </div>
        <div class="progress-stat">
          <div class="progress-stat-value" id="processedRows">0</div>
          <div class="progress-stat-label">Processed</div>
        </div>
        <div class="progress-stat">
          <div class="progress-stat-value" id="validRows">0</div>
          <div class="progress-stat-label">Valid</div>
        </div>
        <div class="progress-stat">
          <div class="progress-stat-value" id="errorRows">0</div>
          <div class="progress-stat-label">Errors</div>
        </div>
      </div>
    </div>

    <!-- Results Card -->
    <div class="results-card" id="resultsCard">
      <div class="results-header">
        <div class="results-icon" id="resultsIcon">
          <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <div>
          <div class="results-title" id="resultsTitle">Upload Complete!</div>
          <div class="results-subtitle" id="resultsSubtitle">Your MLA contracts have been imported successfully</div>
        </div>
      </div>

      <div class="results-stats">
        <div class="result-stat">
          <div class="result-stat-value success" id="resultImported">0</div>
          <div class="result-stat-label">Contracts Imported</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value warning" id="resultUpdated">0</div>
          <div class="result-stat-label">Records Updated</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value error" id="resultSkipped">0</div>
          <div class="result-stat-label">Rows Skipped</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value money" id="resultValue">$0</div>
          <div class="result-stat-label">Total Contract Value</div>
        </div>
      </div>

      <!-- Preview of imported data -->
      <div class="preview-section" id="previewSection">
        <div class="preview-header">
          <span class="preview-title">Imported Contracts</span>
          <span class="preview-badge" id="previewBadge">Showing 5 of 0</span>
        </div>
        <div class="preview-table-container">
          <table class="preview-table">
            <thead>
              <tr>
                <th>Account Name</th>
                <th>Contract #</th>
                <th>Vendor</th>
                <th>Value</th>
                <th>End Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="previewTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="action-buttons">
        <button class="action-btn secondary" id="uploadAnotherBtn">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          Upload Another File
        </button>
        <a href="/dashboard/" class="action-btn primary">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          View All Contracts
        </a>
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script>
    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFile = document.getElementById('selectedFile');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressCard = document.getElementById('progressCard');
    const resultsCard = document.getElementById('resultsCard');
    const downloadTemplate = document.getElementById('downloadTemplate');
    const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');

    let selectedFileData = null;
    let authToken = localStorage.getItem('authToken');

    // Check auth
    if (!authToken) {
      window.location.href = '/dashboard/login.html';
    }

    // Drag and drop handlers
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    removeFile.addEventListener('click', () => {
      clearFile();
    });

    function handleFile(file) {
      const validTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel',
        'text/csv'
      ];
      const validExtensions = ['.xlsx', '.xls', '.csv'];
      const ext = '.' + file.name.split('.').pop().toLowerCase();

      if (!validExtensions.includes(ext)) {
        alert('Please upload an Excel (.xlsx, .xls) or CSV file');
        return;
      }

      selectedFileData = file;
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      selectedFile.classList.add('show');
      dropZone.classList.add('has-file');
      uploadBtn.disabled = false;
    }

    function clearFile() {
      selectedFileData = null;
      fileInput.value = '';
      selectedFile.classList.remove('show');
      dropZone.classList.remove('has-file');
      uploadBtn.disabled = true;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Download template
    downloadTemplate.addEventListener('click', (e) => {
      e.preventDefault();
      generateTemplate();
    });

    function generateTemplate() {
      const templateData = [
        {
          'Account Name': 'Acme Corporation',
          'Contract Number': 'MLA-2024-001',
          'Vendor Name': 'Tech Solutions Inc',
          'Contract Value': 150000,
          'Start Date': '2024-01-01',
          'End Date': '2025-12-31',
          'Status': 'active',
          'Renewal Likelihood': 85,
          'Contact Name': 'John Smith',
          'Contact Email': 'john@acme.com',
          'Notes': 'Key strategic account'
        },
        {
          'Account Name': 'Global Industries',
          'Contract Number': 'MLA-2024-002',
          'Vendor Name': 'Office Supplies Co',
          'Contract Value': 75000,
          'Start Date': '2023-06-01',
          'End Date': '2024-05-31',
          'Status': 'expiring',
          'Renewal Likelihood': 60,
          'Contact Name': 'Jane Doe',
          'Contact Email': 'jane@global.com',
          'Notes': 'Renewal discussion needed'
        }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'MLA Contracts');

      // Set column widths
      ws['!cols'] = [
        { wch: 20 }, // Account Name
        { wch: 18 }, // Contract Number
        { wch: 20 }, // Vendor Name
        { wch: 15 }, // Contract Value
        { wch: 12 }, // Start Date
        { wch: 12 }, // End Date
        { wch: 10 }, // Status
        { wch: 18 }, // Renewal Likelihood
        { wch: 15 }, // Contact Name
        { wch: 25 }, // Contact Email
        { wch: 30 }  // Notes
      ];

      XLSX.writeFile(wb, 'mla_contracts_template.xlsx');
    }

    // Upload handler
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFileData) return;

      uploadBtn.classList.add('loading');
      uploadBtn.disabled = true;
      progressCard.classList.add('show');
      resultsCard.classList.remove('show');

      try {
        // Read file with SheetJS
        const data = await readFileAsArrayBuffer(selectedFileData);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        // Update progress
        document.getElementById('totalRows').textContent = jsonData.length;

        // Process and validate data
        const processedData = await processMLAData(jsonData);

        // Show results
        showResults(processedData);
      } catch (error) {
        console.error('Upload error:', error);
        showError(error.message);
      } finally {
        uploadBtn.classList.remove('loading');
        uploadBtn.disabled = false;
      }
    });

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function processMLAData(data) {
      const duplicateHandling = document.getElementById('duplicateHandling').value;
      const dateFormat = document.getElementById('dateFormat').value;

      const results = {
        imported: 0,
        updated: 0,
        skipped: 0,
        errors: [],
        contracts: [],
        totalValue: 0
      };

      let processed = 0;
      const total = data.length;

      for (const row of data) {
        processed++;
        updateProgress(processed, total);

        // Validate required fields
        const accountName = row['Account Name'] || row['account_name'] || row['AccountName'];
        const contractNumber = row['Contract Number'] || row['contract_number'] || row['ContractNumber'];
        const startDate = parseDate(row['Start Date'] || row['start_date'] || row['StartDate'], dateFormat);
        const endDate = parseDate(row['End Date'] || row['end_date'] || row['EndDate'], dateFormat);

        if (!accountName || !contractNumber) {
          results.skipped++;
          results.errors.push(`Row ${processed}: Missing required fields (Account Name or Contract Number)`);
          continue;
        }

        if (!startDate || !endDate) {
          results.skipped++;
          results.errors.push(`Row ${processed}: Invalid date format`);
          continue;
        }

        // Parse optional fields
        const vendorName = row['Vendor Name'] || row['vendor_name'] || row['VendorName'] || null;
        const contractValue = parseNumber(row['Contract Value'] || row['contract_value'] || row['ContractValue']);
        const status = parseStatus(row['Status'] || row['status']);
        const renewalLikelihood = parseNumber(row['Renewal Likelihood'] || row['renewal_likelihood'] || row['RenewalLikelihood']);
        const contactName = row['Contact Name'] || row['contact_name'] || row['ContactName'] || null;
        const contactEmail = row['Contact Email'] || row['contact_email'] || row['ContactEmail'] || null;
        const notes = row['Notes'] || row['notes'] || null;

        const contract = {
          account_name: accountName,
          contract_number: contractNumber,
          vendor_name: vendorName,
          contract_value_cents: contractValue ? Math.round(contractValue * 100) : null,
          start_date: startDate,
          end_date: endDate,
          status: status,
          renewal_likelihood_pct: renewalLikelihood,
          contact_name: contactName,
          contact_email: contactEmail,
          notes: notes
        };

        results.contracts.push(contract);
        if (contractValue) {
          results.totalValue += contractValue;
        }
      }

      // Send to server
      try {
        const response = await fetch('/api/mla/bulk-import', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            contracts: results.contracts,
            duplicateHandling: duplicateHandling
          })
        });

        if (response.ok) {
          const serverResult = await response.json();
          results.imported = serverResult.imported || results.contracts.length;
          results.updated = serverResult.updated || 0;
          results.skipped += serverResult.skipped || 0;
        } else {
          // Even if server fails, we still show what we parsed
          results.imported = results.contracts.length;
        }
      } catch (error) {
        console.error('Server error:', error);
        results.imported = results.contracts.length;
      }

      return results;
    }

    function parseDate(value, format) {
      if (!value) return null;

      // If it's already a Date object from Excel
      if (value instanceof Date) {
        return value.toISOString().split('T')[0];
      }

      // If it's an Excel serial number
      if (typeof value === 'number') {
        const date = XLSX.SSF.parse_date_code(value);
        if (date) {
          return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
        }
      }

      // String parsing
      const str = String(value).trim();

      if (format === 'auto' || !format) {
        // Try common formats
        const formats = [
          /^(\d{4})-(\d{2})-(\d{2})$/, // YYYY-MM-DD
          /^(\d{2})\/(\d{2})\/(\d{4})$/, // MM/DD/YYYY or DD/MM/YYYY
          /^(\d{2})-(\d{2})-(\d{4})$/, // MM-DD-YYYY or DD-MM-YYYY
        ];

        for (const regex of formats) {
          const match = str.match(regex);
          if (match) {
            if (regex.source.includes('^(\\d{4})')) {
              return str;
            } else {
              // Assume MM/DD/YYYY for US format
              return `${match[3]}-${match[1]}-${match[2]}`;
            }
          }
        }
      }

      return null;
    }

    function parseNumber(value) {
      if (!value) return null;
      if (typeof value === 'number') return value;

      // Remove currency symbols and commas
      const cleaned = String(value).replace(/[$,]/g, '').trim();
      const num = parseFloat(cleaned);
      return isNaN(num) ? null : num;
    }

    function parseStatus(value) {
      if (!value) return 'active';
      const lower = String(value).toLowerCase().trim();
      if (['active', 'expiring', 'expired', 'renewed'].includes(lower)) {
        return lower;
      }
      return 'active';
    }

    function updateProgress(processed, total) {
      const percent = Math.round((processed / total) * 100);
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('processedRows').textContent = processed;
      document.getElementById('validRows').textContent = processed;
      document.getElementById('progressStatus').textContent = `${percent}% complete`;
    }

    function showResults(results) {
      progressCard.classList.remove('show');
      resultsCard.classList.remove('error');
      resultsCard.classList.add('show');

      document.getElementById('resultImported').textContent = results.imported;
      document.getElementById('resultUpdated').textContent = results.updated;
      document.getElementById('resultSkipped').textContent = results.skipped;
      document.getElementById('resultValue').textContent = formatCurrency(results.totalValue);

      // Update preview table
      const tbody = document.getElementById('previewTableBody');
      tbody.innerHTML = '';

      const previewContracts = results.contracts.slice(0, 5);
      document.getElementById('previewBadge').textContent = `Showing ${previewContracts.length} of ${results.contracts.length}`;

      previewContracts.forEach(contract => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(contract.account_name)}</td>
          <td>${escapeHtml(contract.contract_number)}</td>
          <td>${escapeHtml(contract.vendor_name || '-')}</td>
          <td>${contract.contract_value_cents ? formatCurrency(contract.contract_value_cents / 100) : '-'}</td>
          <td>${contract.end_date || '-'}</td>
          <td><span class="status-badge ${contract.status}">${contract.status}</span></td>
        `;
        tbody.appendChild(row);
      });

      if (results.contracts.length === 0) {
        document.getElementById('previewSection').style.display = 'none';
      } else {
        document.getElementById('previewSection').style.display = 'block';
      }
    }

    function showError(message) {
      progressCard.classList.remove('show');
      resultsCard.classList.add('show');
      resultsCard.classList.add('error');

      document.getElementById('resultsIcon').innerHTML = `
        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      `;
      document.getElementById('resultsTitle').textContent = 'Upload Failed';
      document.getElementById('resultsSubtitle').textContent = message;

      document.getElementById('resultImported').textContent = '0';
      document.getElementById('resultUpdated').textContent = '0';
      document.getElementById('resultSkipped').textContent = '-';
      document.getElementById('resultValue').textContent = '$0';
      document.getElementById('previewSection').style.display = 'none';
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Upload another file
    uploadAnotherBtn.addEventListener('click', () => {
      clearFile();
      resultsCard.classList.remove('show');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
