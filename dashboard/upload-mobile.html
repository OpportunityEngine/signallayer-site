<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Snap Invoice - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0f1a;
      color: #e2e8f0;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }

    html {
      height: -webkit-fill-available;
    }

    /* Header */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid rgba(251, 191, 36, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-title {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
    }

    .header-subtitle {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .back-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 20px;
    }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 80px 20px 20px;
      gap: 20px;
    }

    /* Camera Capture Zone */
    .capture-zone {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 2px dashed rgba(251, 191, 36, 0.3);
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 300px;
    }

    .capture-zone.active {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.05);
    }

    .capture-zone.processing {
      pointer-events: none;
    }

    .camera-icon {
      font-size: 72px;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }

    .capture-title {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .capture-subtitle {
      color: #94a3b8;
      font-size: 14px;
      max-width: 280px;
      margin: 0 auto 20px;
    }

    .format-tags {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .format-tag {
      padding: 6px 12px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 50px;
      font-size: 11px;
      font-weight: 600;
      color: #fbbf24;
    }

    .file-input {
      display: none;
    }

    /* Preview */
    .preview-container {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
    }

    .preview-container.visible {
      display: flex;
    }

    .preview-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 12px;
      object-fit: contain;
      border: 2px solid rgba(251, 191, 36, 0.3);
    }

    .preview-actions {
      display: flex;
      gap: 12px;
      width: 100%;
    }

    .preview-btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .preview-btn.retake {
      background: rgba(100, 116, 139, 0.3);
      color: #e2e8f0;
      border: 1px solid rgba(100, 116, 139, 0.5);
    }

    .preview-btn.submit {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #0f172a;
    }

    .preview-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Processing State */
    .processing-overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 15, 26, 0.95);
      border-radius: 18px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .processing-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(251, 191, 36, 0.2);
      border-top-color: #fbbf24;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .processing-text {
      font-size: 16px;
      color: #fbbf24;
      font-weight: 600;
    }

    .processing-step {
      font-size: 13px;
      color: #94a3b8;
    }

    /* Result */
    .result-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 16px;
      padding: 20px;
      display: none;
    }

    .result-card.visible {
      display: block;
    }

    .result-card.error {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .result-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .result-icon {
      font-size: 32px;
    }

    .result-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }

    .result-subtitle {
      font-size: 13px;
      color: #94a3b8;
    }

    .result-details {
      display: grid;
      gap: 12px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(100, 116, 139, 0.2);
    }

    .result-row:last-child {
      border-bottom: none;
    }

    .result-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .result-value {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .result-value.highlight {
      color: #22c55e;
      font-size: 18px;
    }

    .result-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      text-decoration: none;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #0f172a;
    }

    .action-btn.secondary {
      background: rgba(100, 116, 139, 0.3);
      color: #e2e8f0;
      border: 1px solid rgba(100, 116, 139, 0.5);
    }

    /* Tips */
    .tips {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 16px;
    }

    .tips-title {
      font-size: 13px;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tips-list {
      list-style: none;
      display: grid;
      gap: 6px;
    }

    .tips-list li {
      font-size: 12px;
      color: #94a3b8;
      padding-left: 16px;
      position: relative;
    }

    .tips-list li::before {
      content: '\u2022';
      position: absolute;
      left: 0;
      color: #60a5fa;
    }

    /* Quality Indicator */
    .quality-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      display: none;
    }

    .quality-badge.good {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      display: block;
    }

    .quality-badge.warning {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      display: block;
    }

    .quality-badge.poor {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      display: block;
    }

    /* Confidence Meter */
    .confidence-meter {
      height: 6px;
      background: rgba(100, 116, 139, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .confidence-fill.high {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .confidence-fill.medium {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .confidence-fill.low {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/dashboard/my-invoices.html" class="back-btn">&larr;</a>
    <div style="text-align: center;">
      <div class="header-title">Snap Invoice</div>
      <div class="header-subtitle">Take a photo to extract data</div>
    </div>
    <div style="width: 40px;"></div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Capture Zone -->
    <div class="capture-zone" id="captureZone">
      <div class="processing-overlay" id="processingOverlay">
        <div class="spinner"></div>
        <div class="processing-text">Processing Invoice...</div>
        <div class="processing-step" id="processingStep">Optimizing image</div>
      </div>

      <div id="captureContent">
        <div class="camera-icon">&#128247;</div>
        <h2 class="capture-title">Tap to Capture</h2>
        <p class="capture-subtitle">Take a photo of your invoice or receipt to instantly extract data</p>
        <div class="format-tags">
          <span class="format-tag">JPEG</span>
          <span class="format-tag">PNG</span>
          <span class="format-tag">HEIC</span>
        </div>
      </div>

      <div class="preview-container" id="previewContainer">
        <img id="previewImage" class="preview-image" src="" alt="Invoice preview">
        <div class="quality-badge" id="qualityBadge"></div>
        <div class="preview-actions">
          <button class="preview-btn retake" id="retakeBtn">Retake</button>
          <button class="preview-btn submit" id="submitBtn">Process Invoice</button>
        </div>
      </div>

      <input type="file" id="fileInput" class="file-input" accept="image/*" capture="environment">
    </div>

    <!-- Result Card -->
    <div class="result-card" id="resultCard">
      <div class="result-header">
        <span class="result-icon" id="resultIcon">&#9989;</span>
        <div>
          <div class="result-title" id="resultTitle">Invoice Processed</div>
          <div class="result-subtitle" id="resultSubtitle">Extracted in 2.3 seconds</div>
        </div>
      </div>
      <div class="result-details" id="resultDetails">
        <!-- Dynamic content -->
      </div>
      <div class="result-actions">
        <button class="action-btn secondary" id="newScanBtn">&#128247; New Scan</button>
        <a href="/dashboard/my-invoices.html" class="action-btn primary">View Invoices &rarr;</a>
      </div>
    </div>

    <!-- Tips -->
    <div class="tips" id="tipsSection">
      <div class="tips-title">&#128161; Tips for Best Results</div>
      <ul class="tips-list">
        <li>Place invoice on flat, well-lit surface</li>
        <li>Capture entire document in frame</li>
        <li>Hold phone steady to avoid blur</li>
        <li>Avoid glare from overhead lights</li>
      </ul>
    </div>
  </main>

  <script>
    // DOM Elements
    const captureZone = document.getElementById('captureZone');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const captureContent = document.getElementById('captureContent');
    const processingOverlay = document.getElementById('processingOverlay');
    const processingStep = document.getElementById('processingStep');
    const qualityBadge = document.getElementById('qualityBadge');
    const retakeBtn = document.getElementById('retakeBtn');
    const submitBtn = document.getElementById('submitBtn');
    const resultCard = document.getElementById('resultCard');
    const resultDetails = document.getElementById('resultDetails');
    const resultTitle = document.getElementById('resultTitle');
    const resultSubtitle = document.getElementById('resultSubtitle');
    const resultIcon = document.getElementById('resultIcon');
    const newScanBtn = document.getElementById('newScanBtn');
    const tipsSection = document.getElementById('tipsSection');

    let currentFile = null;

    // Auth token
    function getAuthToken() {
      return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    // Check auth
    const token = getAuthToken();
    if (!token) {
      window.location.href = '/dashboard/login.html?redirect=' + encodeURIComponent('/dashboard/upload-mobile.html');
    }

    // Capture zone click
    captureZone.addEventListener('click', (e) => {
      if (e.target.closest('.preview-actions')) return;
      if (!previewContainer.classList.contains('visible')) {
        fileInput.click();
      }
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });

    // Handle file
    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showError('Please select an image file');
        return;
      }

      currentFile = file;

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        captureContent.style.display = 'none';
        previewContainer.classList.add('visible');
        tipsSection.style.display = 'none';

        // Estimate quality from file size (simple heuristic)
        estimateQuality(file);
      };
      reader.readAsDataURL(file);
    }

    // Estimate image quality
    function estimateQuality(file) {
      const sizeMB = file.size / (1024 * 1024);

      if (sizeMB > 2) {
        qualityBadge.textContent = 'High Quality';
        qualityBadge.className = 'quality-badge good';
      } else if (sizeMB > 0.5) {
        qualityBadge.textContent = 'Good Quality';
        qualityBadge.className = 'quality-badge good';
      } else if (sizeMB > 0.1) {
        qualityBadge.textContent = 'OK Quality';
        qualityBadge.className = 'quality-badge warning';
      } else {
        qualityBadge.textContent = 'Low Resolution';
        qualityBadge.className = 'quality-badge poor';
      }
    }

    // Retake
    retakeBtn.addEventListener('click', () => {
      resetCapture();
    });

    function resetCapture() {
      currentFile = null;
      fileInput.value = '';
      previewImage.src = '';
      previewContainer.classList.remove('visible');
      captureContent.style.display = 'block';
      qualityBadge.className = 'quality-badge';
      resultCard.classList.remove('visible');
      resultCard.classList.remove('error');
      tipsSection.style.display = 'block';
    }

    // Submit
    submitBtn.addEventListener('click', async () => {
      if (!currentFile) return;
      await processInvoice(currentFile);
    });

    // New scan
    newScanBtn.addEventListener('click', () => {
      resetCapture();
    });

    // Process invoice
    async function processInvoice(file) {
      const startTime = Date.now();

      // Show processing
      previewContainer.classList.remove('visible');
      processingOverlay.classList.add('visible');
      captureZone.classList.add('processing');

      const steps = [
        'Optimizing image...',
        'Running OCR...',
        'Detecting vendor...',
        'Extracting line items...',
        'Calculating totals...',
        'Validating data...'
      ];

      let stepIndex = 0;
      const stepInterval = setInterval(() => {
        stepIndex = (stepIndex + 1) % steps.length;
        processingStep.textContent = steps[stepIndex];
      }, 800);

      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('source', 'mobile_camera');

        const response = await fetch('/api/ingest/photo', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        clearInterval(stepInterval);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Upload failed: ${response.status}`);
        }

        const result = await response.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        showResult(result, elapsed);

      } catch (err) {
        clearInterval(stepInterval);
        console.error('Processing error:', err);
        showError(err.message);
      } finally {
        processingOverlay.classList.remove('visible');
        captureZone.classList.remove('processing');
      }
    }

    // Show result
    function showResult(result, elapsed) {
      resultCard.classList.add('visible');
      captureContent.style.display = 'none';
      tipsSection.style.display = 'none';

      if (result.ok) {
        resultCard.classList.remove('error');
        resultIcon.textContent = '\u2705';
        resultTitle.textContent = 'Invoice Processed';
        resultSubtitle.textContent = `Extracted in ${elapsed} seconds`;

        // Build details
        const extracted = result.extracted || {};
        const totals = extracted.totals || {};
        const confidence = result.confidence?.overall || 0;

        let html = '';

        if (extracted.vendor) {
          html += `<div class="result-row">
            <span class="result-label">Vendor</span>
            <span class="result-value">${escapeHtml(extracted.vendor)}</span>
          </div>`;
        }

        if (extracted.invoiceNumber) {
          html += `<div class="result-row">
            <span class="result-label">Invoice #</span>
            <span class="result-value">${escapeHtml(extracted.invoiceNumber)}</span>
          </div>`;
        }

        if (extracted.date) {
          html += `<div class="result-row">
            <span class="result-label">Date</span>
            <span class="result-value">${escapeHtml(extracted.date)}</span>
          </div>`;
        }

        if (extracted.lineItems?.length) {
          html += `<div class="result-row">
            <span class="result-label">Line Items</span>
            <span class="result-value">${extracted.lineItems.length} items</span>
          </div>`;
        }

        const total = totals.total || totals.invoiceTotal || totals.amountDue;
        if (total) {
          const totalValue = typeof total === 'number' ? total : parseFloat(total);
          html += `<div class="result-row">
            <span class="result-label">Total</span>
            <span class="result-value highlight">$${totalValue.toFixed(2)}</span>
          </div>`;
        }

        // Confidence meter
        const confPct = Math.round(confidence * 100);
        const confClass = confPct >= 70 ? 'high' : confPct >= 40 ? 'medium' : 'low';
        html += `<div class="result-row" style="flex-direction: column; align-items: stretch;">
          <div style="display: flex; justify-content: space-between;">
            <span class="result-label">Confidence</span>
            <span class="result-value">${confPct}%</span>
          </div>
          <div class="confidence-meter">
            <div class="confidence-fill ${confClass}" style="width: ${confPct}%"></div>
          </div>
        </div>`;

        // Warnings
        if (result.warnings?.length) {
          html += `<div class="result-row" style="flex-direction: column; align-items: stretch;">
            <span class="result-label">Notes</span>
            <span class="result-value" style="font-size: 12px; color: #fbbf24;">${result.warnings.slice(0, 2).map(w => escapeHtml(w)).join(', ')}</span>
          </div>`;
        }

        resultDetails.innerHTML = html;

      } else {
        resultCard.classList.add('error');
        resultIcon.textContent = '\u26A0';
        resultTitle.textContent = 'Processing Issue';
        resultSubtitle.textContent = 'Could not fully extract invoice data';

        resultDetails.innerHTML = `
          <div class="result-row">
            <span class="result-label">Status</span>
            <span class="result-value" style="color: #fbbf24;">Low confidence extraction</span>
          </div>
          <div class="result-row">
            <span class="result-label">Suggestion</span>
            <span class="result-value" style="font-size: 12px;">Try retaking with better lighting</span>
          </div>
        `;
      }
    }

    // Show error
    function showError(message) {
      resultCard.classList.add('visible');
      resultCard.classList.add('error');
      captureContent.style.display = 'none';
      tipsSection.style.display = 'none';

      resultIcon.textContent = '\u274C';
      resultTitle.textContent = 'Upload Failed';
      resultSubtitle.textContent = message;
      resultDetails.innerHTML = `
        <div class="result-row">
          <span class="result-label">Error</span>
          <span class="result-value" style="color: #ef4444; word-break: break-word;">${escapeHtml(message)}</span>
        </div>
      `;
    }

    // Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
