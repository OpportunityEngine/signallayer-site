<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Analytics - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --panel: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      --panel2: rgba(15, 23, 42, 0.6);
      --border: rgba(251, 191, 36, 0.15);
      --border-gold: rgba(251, 191, 36, 0.3);
      --text: #e2e8f0;
      --text-bright: #ffffff;
      --muted: #94a3b8;
      --muted2: #64748b;
      --gold: #fbbf24;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --orange: #f97316;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0f1a;
      color: #e2e8f0;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      text-decoration: none;
      margin-bottom: 20px;
      font-size: 14px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #fbbf24;
    }

    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
      color: #ffffff;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    /* Tile Card - Consistent across all dashboards */
    .tile-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .tile-card:hover {
      border-color: rgba(251, 191, 36, 0.3);
      box-shadow: 0 8px 32px rgba(251, 191, 36, 0.08);
    }

    .tile-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(251, 191, 36, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tile-title {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tile-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .tile-body {
      padding: 16px 20px;
    }

    /* Hero Stats Row */
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .hero-stat {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .hero-stat.highlight {
      border-color: rgba(251, 191, 36, 0.4);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(15, 19, 32, 0.9) 100%);
    }

    .hero-stat-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748b;
      margin-bottom: 8px;
    }

    .hero-stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #ffffff;
      line-height: 1;
      margin-bottom: 8px;
    }

    .hero-stat-value.green { color: #22c55e; }
    .hero-stat-value.red { color: #ef4444; }
    .hero-stat-value.gold { color: #fbbf24; }
    .hero-stat-value.blue { color: #3b82f6; }

    .hero-stat-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .hero-stat-change.up { color: #22c55e; }
    .hero-stat-change.down { color: #ef4444; }
    .hero-stat-change.neutral { color: #64748b; }

    .hero-stat-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 24px;
      opacity: 0.6;
    }

    /* Grid Layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .grid-2-1 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .grid-1-2 {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    /* Chart Containers */
    .chart-container {
      position: relative;
      height: 220px;
    }

    .chart-container-small {
      position: relative;
      height: 160px;
    }

    /* Data Lists */
    .data-list {
      display: grid;
      gap: 10px;
    }

    .data-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      transition: all 0.2s;
    }

    .data-row:hover {
      background: rgba(251, 191, 36, 0.05);
      border-color: rgba(251, 191, 36, 0.15);
    }

    .data-row-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .data-row-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-size: 16px;
    }

    .data-row-info h4 {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .data-row-info p {
      font-size: 11px;
      color: #64748b;
    }

    .data-row-value {
      text-align: right;
    }

    .data-row-value .amount {
      font-size: 14px;
      font-weight: 700;
      color: #ffffff;
    }

    .data-row-value .change {
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 3px;
    }

    .data-row-value .change.up { color: #ef4444; }
    .data-row-value .change.down { color: #22c55e; }

    /* Progress Bars */
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease-out;
    }

    .progress-fill.gold { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .progress-fill.green { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .progress-fill.red { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .progress-fill.blue { background: linear-gradient(90deg, #3b82f6, #2563eb); }

    /* Metric Cards */
    .metric-mini {
      text-align: center;
      padding: 16px 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
    }

    .metric-mini-icon {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .metric-mini-value {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .metric-mini-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Trend Indicator */
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .trend-indicator.up {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .trend-indicator.down {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .trend-indicator.neutral {
      background: rgba(100, 116, 139, 0.15);
      color: #64748b;
    }

    /* Status Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.critical {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .status-badge.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .status-badge.success {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status-badge.info {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    /* Sparkline placeholder */
    .sparkline {
      width: 60px;
      height: 24px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }

    .sparkline-bar {
      flex: 1;
      background: rgba(251, 191, 36, 0.4);
      border-radius: 2px;
      transition: height 0.3s;
    }

    .sparkline-bar:last-child {
      background: #fbbf24;
    }

    /* Breakdown List */
    .breakdown-list {
      display: grid;
      gap: 8px;
    }

    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }

    .breakdown-color {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .breakdown-label {
      flex: 1;
      font-size: 13px;
      color: #e2e8f0;
    }

    .breakdown-value {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
    }

    .breakdown-pct {
      font-size: 11px;
      color: #64748b;
      min-width: 40px;
      text-align: right;
    }

    /* Chart Legend */
    .chart-legend {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #94a3b8;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Anomaly Alert */
    .anomaly-alert {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-left: 3px solid #ef4444;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .anomaly-alert.warning {
      background: rgba(245, 158, 11, 0.08);
      border-color: rgba(245, 158, 11, 0.2);
      border-left-color: #f59e0b;
    }

    .anomaly-alert-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .anomaly-alert-content h5 {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .anomaly-alert-content p {
      font-size: 12px;
      color: #94a3b8;
    }

    /* Health Score Gauge */
    .health-gauge {
      text-align: center;
      padding: 20px;
    }

    .health-score {
      font-size: 56px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 8px;
    }

    .health-score.excellent { color: #22c55e; }
    .health-score.good { color: #84cc16; }
    .health-score.warning { color: #f59e0b; }
    .health-score.critical { color: #ef4444; }

    .health-label {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 4px;
    }

    .health-sublabel {
      font-size: 12px;
      color: #64748b;
    }

    /* Vendor Row */
    .vendor-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .vendor-rank {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(251, 191, 36, 0.15);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      color: #fbbf24;
    }

    .vendor-info {
      flex: 1;
    }

    .vendor-name {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
    }

    .vendor-meta {
      font-size: 11px;
      color: #64748b;
    }

    .vendor-spend {
      text-align: right;
    }

    .vendor-amount {
      font-size: 14px;
      font-weight: 700;
      color: #ffffff;
    }

    .vendor-change {
      font-size: 11px;
    }

    /* Scrollable Sections */
    .scrollable-section {
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(251, 191, 36, 0.4) rgba(255, 255, 255, 0.05);
    }

    .scrollable-section::-webkit-scrollbar {
      width: 6px;
    }

    .scrollable-section::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    .scrollable-section::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(251, 191, 36, 0.5) 0%, rgba(245, 158, 11, 0.3) 100%);
      border-radius: 3px;
    }

    /* Demo Mode Toggle */
    .demo-toggle-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .demo-toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(17, 21, 37, 0.8);
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .demo-toggle-label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      transition: color 0.3s;
    }

    .demo-toggle-label.active {
      color: #fbbf24;
    }

    .demo-toggle {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .demo-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .demo-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      border-radius: 20px;
      transition: all 0.3s;
    }

    .demo-toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background: #94a3b8;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .demo-toggle input:checked + .demo-toggle-slider {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .demo-toggle input:checked + .demo-toggle-slider:before {
      transform: translateX(20px);
      background: #ffffff;
    }

    .demo-mode-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 10px;
      border-radius: 10px;
    }

    .demo-mode-indicator.demo {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    .demo-mode-indicator.real {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }

    .indicator-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    .demo-mode-indicator.demo .indicator-dot { background: #f87171; }
    .demo-mode-indicator.real .indicator-dot { background: #4ade80; }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Invoice Activity Feed */
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-title {
      font-size: 12px;
      font-weight: 500;
      color: #e2e8f0;
      margin-bottom: 2px;
    }

    .activity-meta {
      font-size: 11px;
      color: #64748b;
    }

    .activity-amount {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .hero-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .grid-2, .grid-2-1, .grid-1-2 {
        grid-template-columns: 1fr;
      }
      .grid-3 {
        grid-template-columns: 1fr 1fr;
      }
      .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
      .hero-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .hero-stats {
        grid-template-columns: 1fr;
      }
      .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <a href="vp-view.html" class="back-link">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Dashboard
    </a>

    <div class="page-header">
      <div>
        <h1>Business Intelligence Command Center</h1>
        <p class="subtitle">Real-time financial analytics, spend intelligence, and cost optimization insights</p>
      </div>
      <!-- Live Data Indicator (shown for real users) -->
      <div id="liveDataIndicator" class="demo-mode-indicator real" style="display: none;">
        <span class="indicator-dot"></span>
        <span>+ LIVE DATA</span>
      </div>
    </div>

    <!-- Hero Stats Row -->
    <div class="hero-stats">
      <div class="hero-stat highlight">
        <div class="hero-stat-label">Total Savings (YTD)</div>
        <div class="hero-stat-value green" id="totalSavings">$12,847</div>
        <div class="hero-stat-change up">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
          +23% vs last year
        </div>
        <div class="hero-stat-icon">üí∞</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Invoices Analyzed</div>
        <div class="hero-stat-value" id="invoicesAnalyzed">1,247</div>
        <div class="hero-stat-change neutral">This month: 156</div>
        <div class="hero-stat-icon">üìÑ</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Issues Detected</div>
        <div class="hero-stat-value gold" id="issuesDetected">89</div>
        <div class="hero-stat-change down">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
          -12% vs last month
        </div>
        <div class="hero-stat-icon">‚ö†Ô∏è</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Recovery Rate</div>
        <div class="hero-stat-value blue" id="recoveryRate">94.2%</div>
        <div class="hero-stat-change up">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
          +5.8% improvement
        </div>
        <div class="hero-stat-icon">üìà</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-label">Active Vendors</div>
        <div class="hero-stat-value" id="activeVendors">34</div>
        <div class="hero-stat-change neutral">8 need review</div>
        <div class="hero-stat-icon">üè¢</div>
      </div>
    </div>

    <!-- Row 1: Recent Activity + Quick Actions + 30-Day Forecast (ACTION-ORIENTED TOP) -->
    <div class="grid-3">
      <!-- Recent Invoice Activity - FIRST for immediate awareness -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üìÑ</span> Recent Invoice Activity
          </div>
          <span class="tile-badge" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">Live Feed</span>
        </div>
        <div class="tile-body scrollable-section" style="max-height: 320px; padding: 0;">
          <div id="activityFeed">
            <div class="activity-item">
              <div class="activity-icon" style="background: rgba(34, 197, 94, 0.15);">‚úì</div>
              <div class="activity-content">
                <div class="activity-title">Invoice #INV-2847 processed</div>
                <div class="activity-meta">Sysco Foods ‚Ä¢ 2 min ago</div>
              </div>
              <div class="activity-amount">$1,247.50</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon" style="background: rgba(239, 68, 68, 0.15);">‚ö†Ô∏è</div>
              <div class="activity-content">
                <div class="activity-title">Price discrepancy flagged</div>
                <div class="activity-meta">US Foods ‚Ä¢ 15 min ago</div>
              </div>
              <div class="activity-amount" style="color: #ef4444;">+$84.20</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon" style="background: rgba(59, 130, 246, 0.15);">üìß</div>
              <div class="activity-content">
                <div class="activity-title">Invoice received via email</div>
                <div class="activity-meta">Cintas ‚Ä¢ 32 min ago</div>
              </div>
              <div class="activity-amount">$456.00</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon" style="background: rgba(34, 197, 94, 0.15);">üí∞</div>
              <div class="activity-content">
                <div class="activity-title">Credit recovered</div>
                <div class="activity-meta">Republic National ‚Ä¢ 1 hr ago</div>
              </div>
              <div class="activity-amount" style="color: #22c55e;">+$127.80</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon" style="background: rgba(251, 191, 36, 0.15);">üîÑ</div>
              <div class="activity-content">
                <div class="activity-title">Bulk import completed</div>
                <div class="activity-meta">12 invoices ‚Ä¢ 2 hrs ago</div>
              </div>
              <div class="activity-amount">$8,420.00</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 30-Day Expense Forecast -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üíµ</span> 30-Day Expense Forecast
          </div>
          <span class="tile-badge">Predictive</span>
        </div>
        <div class="tile-body">
          <div class="chart-container-small">
            <canvas id="forecastChart"></canvas>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
            <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 10px;">
              <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">This Week</div>
              <div style="font-size: 18px; font-weight: 700; color: #ffffff;">$12,400</div>
              <div style="font-size: 10px; color: #64748b;">Committed</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 10px;">
              <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Next Week</div>
              <div style="font-size: 18px; font-weight: 700; color: #fbbf24;">$14,800</div>
              <div style="font-size: 10px; color: #64748b;">Projected</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 10px;">
              <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">30 Days</div>
              <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">$52,200</div>
              <div style="font-size: 10px; color: #64748b;">Forecast</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Market Price Intelligence -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üåç</span> Market Price Intelligence
          </div>
          <span class="tile-badge">AI Powered</span>
        </div>
        <div class="tile-body">
          <div style="margin-bottom: 12px; padding: 10px; background: rgba(6, 182, 212, 0.08); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 8px;">
            <div style="font-size: 11px; color: #06b6d4; font-weight: 600; margin-bottom: 2px;">üí° Market Insight</div>
            <div style="font-size: 12px; color: #e2e8f0;">Beef prices expected to rise 8-12% next quarter. Consider locking in current pricing.</div>
          </div>
          <div class="data-list">
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-info">
                  <h4>Ground Beef 80/20</h4>
                  <p>Your price: $4.29/lb</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">-8%</div>
                <div class="change" style="color: #64748b;">vs market $4.65</div>
              </div>
            </div>
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-info">
                  <h4>Chicken Breast 10lb</h4>
                  <p>Your price: $52.50/case</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #ef4444;">+12%</div>
                <div class="change" style="color: #64748b;">vs market $46.80</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Quick Actions Hub (NEW) -->
    <div class="tile-card" style="margin-bottom: 24px;">
      <div class="tile-header">
        <div class="tile-title">
          <span>‚ö°</span> Quick Actions
        </div>
        <span class="tile-badge">Owner Tools</span>
      </div>
      <div class="tile-body">
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
          <a href="upload-invoice.html" style="text-decoration: none;">
            <div style="text-align: center; padding: 16px 12px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
              <div style="font-size: 24px; margin-bottom: 8px;">üìÑ</div>
              <div style="font-size: 12px; font-weight: 600; color: #fbbf24;">Upload Invoice</div>
            </div>
          </a>
          <div onclick="showToast('Opening vendor comparison...', 'info')" style="text-align: center; padding: 16px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
            <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
            <div style="font-size: 12px; font-weight: 600; color: #3b82f6;">Compare Vendors</div>
          </div>
          <div onclick="showToast('Opening price alerts...', 'info')" style="text-align: center; padding: 16px 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
            <div style="font-size: 24px; margin-bottom: 8px;">üö®</div>
            <div style="font-size: 12px; font-weight: 600; color: #ef4444;">Price Alerts</div>
          </div>
          <div onclick="showToast('Generating report...', 'info')" style="text-align: center; padding: 16px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
            <div style="font-size: 24px; margin-bottom: 8px;">üìà</div>
            <div style="font-size: 12px; font-weight: 600; color: #22c55e;">Export Report</div>
          </div>
          <div onclick="showToast('Opening budget settings...', 'info')" style="text-align: center; padding: 16px 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
            <div style="font-size: 24px; margin-bottom: 8px;">üí∞</div>
            <div style="font-size: 12px; font-weight: 600; color: #8b5cf6;">Set Budget</div>
          </div>
          <a href="my-invoices.html" style="text-decoration: none;">
            <div style="text-align: center; padding: 16px 12px; background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
              <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
              <div style="font-size: 12px; font-weight: 600; color: #06b6d4;">My Invoices</div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Email Invoice Autopilot - Executive Style -->
    <div class="tile-card" style="margin-bottom: 24px;">
      <div class="tile-header">
        <div class="tile-title">
          <span>üìß</span> Email Invoice Autopilot
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span id="autopilotStatus" class="tile-badge" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">Active</span>
          <button onclick="refreshEmailMonitors()" class="btn" style="font-size: 11px; padding: 6px 12px; background: var(--panel2); color: var(--muted); border: 1px solid var(--border);">
            ‚Üª Refresh
          </button>
          <button onclick="openAddEmailMonitor()" class="btn" style="font-size: 11px; padding: 6px 12px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%); color: var(--gold); border: 1px solid rgba(251, 191, 36, 0.3);">
            + Add Monitor
          </button>
        </div>
      </div>
      <div class="tile-body">
        <!-- Executive Stats Grid -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: var(--panel2); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center;">
            <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Savings</div>
            <div id="autopilotTotalSavings" style="font-size: 28px; font-weight: 800; color: var(--gold);">$0</div>
            <div style="font-size: 11px; color: var(--muted2); margin-top: 4px;">This Month</div>
          </div>
          <div style="background: var(--panel2); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center;">
            <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Critical Findings</div>
            <div id="autopilotCriticalFindings" style="font-size: 28px; font-weight: 800; color: var(--red);">0</div>
            <div style="font-size: 11px; color: var(--muted2); margin-top: 4px;">Requires Action</div>
          </div>
          <div style="background: var(--panel2); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center;">
            <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Invoices Processed</div>
            <div id="autopilotInvoicesProcessed" style="font-size: 28px; font-weight: 800; color: var(--text-bright);">0</div>
            <div style="font-size: 11px; color: var(--muted2); margin-top: 4px;">Automated</div>
          </div>
          <div style="background: var(--panel2); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center;">
            <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Opportunities</div>
            <div id="autopilotOpportunities" style="font-size: 28px; font-weight: 800; color: var(--green);">0</div>
            <div style="font-size: 11px; color: var(--muted2); margin-top: 4px;">Detected</div>
          </div>
        </div>

        <!-- Active Email Monitors Section -->
        <div>
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <h3 style="font-size: 14px; font-weight: 600; color: var(--text); margin: 0; display: flex; align-items: center; gap: 8px;">
              <span style="color: var(--gold);">‚ö°</span> Active Monitors
            </h3>
          </div>
          <div id="autopilotMonitorsList" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center; padding: 20px; color: #64748b; font-size: 13px;">
              Loading email monitors...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Location Performance + Opportunity Pipeline -->
    <div class="grid-2">
      <!-- Location Performance -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üìç</span> Location Performance
          </div>
          <span class="tile-badge">By Savings</span>
        </div>
        <div class="tile-body scrollable-section" style="max-height: 280px;">
          <div class="data-list" id="locationPerformanceList">
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-icon" style="background: rgba(239, 68, 68, 0.15);">üî•</div>
                <div class="data-row-info">
                  <h4>Downtown Location</h4>
                  <p>12 issues found ‚Ä¢ 156 invoices</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">$4,280</div>
                <div class="change down">‚Üì Top Saver</div>
              </div>
            </div>
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-icon" style="background: rgba(245, 158, 11, 0.15);">‚ö†Ô∏è</div>
                <div class="data-row-info">
                  <h4>Westside Branch</h4>
                  <p>8 issues found ‚Ä¢ 98 invoices</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">$2,450</div>
                <div class="change" style="color: #f59e0b;">Needs Review</div>
              </div>
            </div>
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-icon" style="background: rgba(34, 197, 94, 0.15);">‚úì</div>
                <div class="data-row-info">
                  <h4>Airport Store</h4>
                  <p>5 issues found ‚Ä¢ 87 invoices</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">$1,517</div>
                <div class="change down">On Track</div>
              </div>
            </div>
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-icon" style="background: rgba(59, 130, 246, 0.15);">üìä</div>
                <div class="data-row-info">
                  <h4>North Campus</h4>
                  <p>3 issues found ‚Ä¢ 64 invoices</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">$890</div>
                <div class="change down">Improving</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Opportunity Pipeline -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üéØ</span> Savings Pipeline
          </div>
          <span class="tile-badge">Recovery Funnel</span>
        </div>
        <div class="tile-body">
          <div class="grid-4" style="margin-bottom: 16px;">
            <div class="metric-mini">
              <div class="metric-mini-icon">üîç</div>
              <div class="metric-mini-value" id="pipelineDetected">24</div>
              <div class="metric-mini-label">Detected</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">$12,400</div>
            </div>
            <div class="metric-mini">
              <div class="metric-mini-icon">üìã</div>
              <div class="metric-mini-value" id="pipelineReviewing">12</div>
              <div class="metric-mini-label">Reviewing</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">$6,800</div>
            </div>
            <div class="metric-mini">
              <div class="metric-mini-icon">‚ö°</div>
              <div class="metric-mini-value" id="pipelineProgress">8</div>
              <div class="metric-mini-label">In Progress</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">$4,200</div>
            </div>
            <div class="metric-mini" style="background: rgba(34, 197, 94, 0.1);">
              <div class="metric-mini-icon">‚úÖ</div>
              <div class="metric-mini-value" style="color: #22c55e;" id="pipelineRecovered">47</div>
              <div class="metric-mini-label">Recovered</div>
              <div style="font-size: 11px; color: #22c55e; margin-top: 4px;">$8,247</div>
            </div>
          </div>
          <div class="progress-bar" style="height: 10px; margin-top: 8px;">
            <div style="display: flex; height: 100%;">
              <div style="width: 26%; background: #f59e0b; border-radius: 5px 0 0 5px;"></div>
              <div style="width: 14%; background: #3b82f6;"></div>
              <div style="width: 9%; background: #8b5cf6;"></div>
              <div style="width: 51%; background: #22c55e; border-radius: 0 5px 5px 0;"></div>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #64748b;">
            <span>Pipeline: $23,400</span>
            <span>Recovery Rate: 94.2%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Top Vendors + Cost Anomalies -->
    <div class="grid-2">
      <!-- Top Vendors by Spend -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üè¢</span> Top Vendors by Spend
          </div>
          <span class="tile-badge">This Month</span>
        </div>
        <div class="tile-body scrollable-section" style="max-height: 320px;">
          <div id="vendorsList">
            <div class="vendor-row">
              <div class="vendor-rank">1</div>
              <div class="vendor-info">
                <div class="vendor-name">Sysco Foods</div>
                <div class="vendor-meta">47 invoices ‚Ä¢ Last: 2 days ago</div>
              </div>
              <div class="vendor-spend">
                <div class="vendor-amount">$24,850</div>
                <div class="vendor-change" style="color: #ef4444;">‚Üë 8.2%</div>
              </div>
            </div>
            <div class="vendor-row">
              <div class="vendor-rank">2</div>
              <div class="vendor-info">
                <div class="vendor-name">US Foods</div>
                <div class="vendor-meta">32 invoices ‚Ä¢ Last: 3 days ago</div>
              </div>
              <div class="vendor-spend">
                <div class="vendor-amount">$18,420</div>
                <div class="vendor-change" style="color: #22c55e;">‚Üì 3.1%</div>
              </div>
            </div>
            <div class="vendor-row">
              <div class="vendor-rank">3</div>
              <div class="vendor-info">
                <div class="vendor-name">Cintas</div>
                <div class="vendor-meta">12 invoices ‚Ä¢ Last: 1 week ago</div>
              </div>
              <div class="vendor-spend">
                <div class="vendor-amount">$8,750</div>
                <div class="vendor-change" style="color: #64748b;">‚Üí 0%</div>
              </div>
            </div>
            <div class="vendor-row">
              <div class="vendor-rank">4</div>
              <div class="vendor-info">
                <div class="vendor-name">Republic National</div>
                <div class="vendor-meta">28 invoices ‚Ä¢ Last: 4 days ago</div>
              </div>
              <div class="vendor-spend">
                <div class="vendor-amount">$7,230</div>
                <div class="vendor-change" style="color: #ef4444;">‚Üë 12.4%</div>
              </div>
            </div>
            <div class="vendor-row">
              <div class="vendor-rank">5</div>
              <div class="vendor-info">
                <div class="vendor-name">Southern Glazers</div>
                <div class="vendor-meta">19 invoices ‚Ä¢ Last: 5 days ago</div>
              </div>
              <div class="vendor-spend">
                <div class="vendor-amount">$5,890</div>
                <div class="vendor-change" style="color: #22c55e;">‚Üì 5.7%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cost Anomaly Detection -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üö®</span> Cost Anomaly Alerts
          </div>
          <span class="tile-badge" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">3 Active</span>
        </div>
        <div class="tile-body scrollable-section" style="max-height: 320px;">
          <div class="anomaly-alert">
            <div class="anomaly-alert-icon">‚ö†Ô∏è</div>
            <div class="anomaly-alert-content">
              <h5>Price spike: Chicken Breast 10lb</h5>
              <p>$48.99 ‚Üí $62.50 (+27.6%) from Sysco. Market avg: $51.20</p>
            </div>
          </div>
          <div class="anomaly-alert warning">
            <div class="anomaly-alert-icon">üìä</div>
            <div class="anomaly-alert-content">
              <h5>Unusual quantity: Paper Towels</h5>
              <p>Order of 48 cases vs typical 12 cases. Verify with team.</p>
            </div>
          </div>
          <div class="anomaly-alert">
            <div class="anomaly-alert-icon">üí∞</div>
            <div class="anomaly-alert-content">
              <h5>Duplicate charge detected</h5>
              <p>Invoice #84521 from US Foods may be duplicate of #84519 ($847.50)</p>
            </div>
          </div>
          <div style="margin-top: 16px; padding: 12px; background: rgba(34, 197, 94, 0.08); border-radius: 10px; text-align: center;">
            <div style="font-size: 12px; color: #22c55e; font-weight: 600;">AI monitoring 1,247 invoices for anomalies</div>
            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Last scan: 2 minutes ago</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 4: Expense Breakdown + Spending Trend -->
    <div class="grid-2-1">
      <!-- Spending Trend Chart -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üìà</span> Spending Trends
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="setTrendPeriod('4w')" class="tile-badge" style="cursor: pointer; border: none;">4W</button>
            <button onclick="setTrendPeriod('12w')" class="tile-badge" style="cursor: pointer; border: none; background: rgba(251, 191, 36, 0.3);">12W</button>
            <button onclick="setTrendPeriod('ytd')" class="tile-badge" style="cursor: pointer; border: none;">YTD</button>
          </div>
        </div>
        <div class="tile-body">
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-dot" style="background: #fbbf24;"></span> COGS</div>
            <div class="legend-item"><span class="legend-dot" style="background: #3b82f6;"></span> Labor</div>
            <div class="legend-item"><span class="legend-dot" style="background: #22c55e;"></span> Operating</div>
          </div>
        </div>
      </div>

      <!-- Expense Breakdown -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>ü•ß</span> Expense Mix
          </div>
          <span class="tile-badge">This Month</span>
        </div>
        <div class="tile-body">
          <div class="chart-container-small">
            <canvas id="breakdownChart"></canvas>
          </div>
          <div class="breakdown-list" style="margin-top: 12px;">
            <div class="breakdown-item">
              <div class="breakdown-color" style="background: #fbbf24;"></div>
              <span class="breakdown-label">COGS</span>
              <span class="breakdown-value">$34,500</span>
              <span class="breakdown-pct">42.1%</span>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-color" style="background: #3b82f6;"></div>
              <span class="breakdown-label">Labor</span>
              <span class="breakdown-value">$28,200</span>
              <span class="breakdown-pct">34.4%</span>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-color" style="background: #22c55e;"></div>
              <span class="breakdown-label">Utilities</span>
              <span class="breakdown-value">$8,900</span>
              <span class="breakdown-pct">10.9%</span>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-color" style="background: #8b5cf6;"></div>
              <span class="breakdown-label">Other</span>
              <span class="breakdown-value">$10,400</span>
              <span class="breakdown-pct">12.6%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 5: KPI Targets + Profit Margin Tracker (NEW) -->
    <div class="grid-2">
      <!-- KPI Targets -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üéØ</span> Key Performance Targets
          </div>
          <span class="tile-badge">vs Industry</span>
        </div>
        <div class="tile-body">
          <div class="data-list">
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
              <span style="font-size: 13px; color: #e2e8f0;">Food Cost %</span>
              <span style="font-size: 14px; font-weight: 700; color: #22c55e;">28.5%</span>
              <span style="font-size: 12px; color: #64748b;">Target: 30%</span>
              <span class="status-badge success">Under</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
              <span style="font-size: 13px; color: #e2e8f0;">Labor Cost %</span>
              <span style="font-size: 14px; font-weight: 700; color: #22c55e;">26.2%</span>
              <span style="font-size: 12px; color: #64748b;">Target: 28%</span>
              <span class="status-badge success">Under</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
              <span style="font-size: 13px; color: #e2e8f0;">Prime Cost %</span>
              <span style="font-size: 14px; font-weight: 700; color: #fbbf24;">62.3%</span>
              <span style="font-size: 12px; color: #64748b;">Target: 60%</span>
              <span class="status-badge warning">Over</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">
              <span style="font-size: 13px; color: #e2e8f0;">Beverage Cost %</span>
              <span style="font-size: 14px; font-weight: 700; color: #22c55e;">18.4%</span>
              <span style="font-size: 12px; color: #64748b;">Target: 22%</span>
              <span class="status-badge success">Under</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px; padding: 12px 0; align-items: center;">
              <span style="font-size: 13px; color: #e2e8f0;">Waste %</span>
              <span style="font-size: 14px; font-weight: 700; color: #22c55e;">2.1%</span>
              <span style="font-size: 12px; color: #64748b;">Target: 3%</span>
              <span class="status-badge success">Under</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Profit Margin Tracker (NEW) -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üíé</span> Profit Margin Tracker
          </div>
          <span class="tile-badge">Goal: 15%</span>
        </div>
        <div class="tile-body">
          <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 48px; font-weight: 900; color: #22c55e; line-height: 1;">12.8%</div>
              <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Current Margin</div>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 11px; color: #64748b;">Progress to Goal</span>
                <span style="font-size: 11px; font-weight: 600; color: #fbbf24;">85%</span>
              </div>
              <div class="progress-bar" style="height: 12px;">
                <div class="progress-fill gold" style="width: 85%;"></div>
              </div>
              <div style="font-size: 11px; color: #64748b; margin-top: 6px;">+2.2% from last month</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="text-align: center; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 10px;">
              <div style="font-size: 16px; font-weight: 700; color: #22c55e;">$18.2k</div>
              <div style="font-size: 10px; color: #64748b;">Gross Profit</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
              <div style="font-size: 16px; font-weight: 700; color: #3b82f6;">$142k</div>
              <div style="font-size: 10px; color: #64748b;">Revenue MTD</div>
            </div>
            <div style="text-align: center; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 10px;">
              <div style="font-size: 16px; font-weight: 700; color: #fbbf24;">$3.1k</div>
              <div style="font-size: 10px; color: #64748b;">Savings Impact</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 6: Cash Flow Calendar + Weekly Comparison (NEW BUSINESS OWNER FEATURES) -->
    <div class="grid-2">
      <!-- Cash Flow Calendar -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üìÖ</span> Cash Flow Calendar
          </div>
          <span class="tile-badge">This Week</span>
        </div>
        <div class="tile-body">
          <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;">
            <div style="padding: 8px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Mon</div>
              <div style="font-size: 12px; font-weight: 700; color: #22c55e;">+$4.2k</div>
            </div>
            <div style="padding: 8px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Tue</div>
              <div style="font-size: 12px; font-weight: 700; color: #ef4444;">-$2.8k</div>
            </div>
            <div style="padding: 8px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Wed</div>
              <div style="font-size: 12px; font-weight: 700; color: #22c55e;">+$5.1k</div>
            </div>
            <div style="padding: 8px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Thu</div>
              <div style="font-size: 12px; font-weight: 700; color: #ef4444;">-$6.4k</div>
            </div>
            <div style="padding: 8px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Fri</div>
              <div style="font-size: 12px; font-weight: 700; color: #22c55e;">+$8.9k</div>
            </div>
            <div style="padding: 8px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Sat</div>
              <div style="font-size: 12px; font-weight: 700; color: #22c55e;">+$7.2k</div>
            </div>
            <div style="padding: 8px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
              <div style="font-size: 10px; color: #64748b;">Sun</div>
              <div style="font-size: 12px; font-weight: 700; color: #3b82f6;">~$3.8k</div>
            </div>
          </div>
          <div style="margin-top: 16px; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 11px; color: #64748b;">Weekly Net Cash Flow</div>
                <div style="font-size: 20px; font-weight: 700; color: #22c55e;">+$20,000</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 11px; color: #64748b;">Upcoming Bills</div>
                <div style="font-size: 14px; font-weight: 600; color: #ef4444;">$8,450 due Thu</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Week-over-Week Comparison (NEW) -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üìä</span> Week-over-Week Comparison
          </div>
          <span class="tile-badge">vs Last Week</span>
        </div>
        <div class="tile-body">
          <div class="data-list">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <span style="font-size: 13px; color: #e2e8f0;">Total Spend</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 14px; color: #64748b;">$18.4k ‚Üí $17.2k</span>
                <span style="font-size: 12px; font-weight: 600; color: #22c55e;">‚Üì 6.5%</span>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <span style="font-size: 13px; color: #e2e8f0;">Invoices Processed</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 14px; color: #64748b;">42 ‚Üí 47</span>
                <span style="font-size: 12px; font-weight: 600; color: #22c55e;">‚Üë 12%</span>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <span style="font-size: 13px; color: #e2e8f0;">Savings Found</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 14px; color: #64748b;">$890 ‚Üí $1,247</span>
                <span style="font-size: 12px; font-weight: 600; color: #22c55e;">‚Üë 40%</span>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
              <span style="font-size: 13px; color: #e2e8f0;">Price Alerts</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 14px; color: #64748b;">5 ‚Üí 3</span>
                <span style="font-size: 12px; font-weight: 600; color: #22c55e;">‚Üì 40%</span>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
              <span style="font-size: 13px; color: #e2e8f0;">Avg Invoice Value</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 14px; color: #64748b;">$438 ‚Üí $366</span>
                <span style="font-size: 12px; font-weight: 600; color: #22c55e;">‚Üì 16%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 7: Financial Health Score + Spending Velocity (CHARTS AT BOTTOM) -->
    <div class="grid-2">
      <!-- Financial Health Score -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>üéØ</span> Financial Health Score
          </div>
          <span class="tile-badge">Real-time</span>
        </div>
        <div class="tile-body">
          <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; align-items: center;">
            <div class="health-gauge">
              <div class="health-score excellent" id="healthScore">A+</div>
              <div class="health-label">Excellent</div>
              <div class="health-sublabel">Top 5% of businesses</div>
            </div>
            <div>
              <div class="data-list">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                  <span style="font-size: 13px; color: #94a3b8;">Cost Control</span>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 80px;"><div class="progress-fill green" style="width: 92%;"></div></div>
                    <span style="font-size: 12px; font-weight: 600; color: #22c55e;">92%</span>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                  <span style="font-size: 13px; color: #94a3b8;">Invoice Accuracy</span>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 80px;"><div class="progress-fill green" style="width: 88%;"></div></div>
                    <span style="font-size: 12px; font-weight: 600; color: #22c55e;">88%</span>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                  <span style="font-size: 13px; color: #94a3b8;">Vendor Compliance</span>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 80px;"><div class="progress-fill gold" style="width: 78%;"></div></div>
                    <span style="font-size: 12px; font-weight: 600; color: #fbbf24;">78%</span>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                  <span style="font-size: 13px; color: #94a3b8;">Price Consistency</span>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="progress-bar" style="width: 80px;"><div class="progress-fill green" style="width: 95%;"></div></div>
                    <span style="font-size: 12px; font-weight: 600; color: #22c55e;">95%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Spending Velocity -->
      <div class="tile-card">
        <div class="tile-header">
          <div class="tile-title">
            <span>‚ö°</span> Spending Velocity
          </div>
          <span class="tile-badge">12 Weeks</span>
        </div>
        <div class="tile-body">
          <div class="chart-container">
            <canvas id="velocityChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-dot" style="background: #fbbf24;"></span> Actual Spend</div>
            <div class="legend-item"><span class="legend-dot" style="background: #3b82f6;"></span> Budget</div>
            <div class="legend-item"><span class="legend-dot" style="background: #22c55e;"></span> Savings</div>
          </div>
        </div>
      </div>
    </div>


  </div>

  <!-- Add Email Monitor Modal (VP Style) -->
  <div class="modal-overlay" id="addEmailMonitorModal" onclick="closeAddEmailMonitor(event)">
    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">üìß</span>
          <span>Add Email Monitor</span>
          <span style="font-size: 11px; background: rgba(6, 182, 212, 0.15); color: #06b6d4; padding: 4px 10px; border-radius: 20px; font-weight: 600;">Invoice Autopilot</span>
        </div>
        <button class="modal-close" onclick="closeAddEmailMonitor()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Quick Connect Section (OAuth) -->
        <div id="oauthConnectSection">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 8px;">Quick Connect</div>
            <div style="font-size: 13px; color: var(--muted);">Connect with one click - no passwords needed!</div>
          </div>

          <div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 24px;">
            <!-- Google OAuth Button -->
            <button onclick="connectWithGoogle()" id="googleOAuthBtn" class="btn" style="display: flex; align-items: center; gap: 12px; padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; font-weight: 500; color: #3c4043; cursor: pointer; transition: all 0.2s;">
              <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Connect with Google
            </button>

            <!-- Microsoft OAuth Button -->
            <button onclick="connectWithMicrosoft()" id="microsoftOAuthBtn" class="btn" style="display: flex; align-items: center; gap: 12px; padding: 14px 28px; background: white; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; font-weight: 500; color: #3c4043; cursor: pointer; transition: all 0.2s;">
              <svg width="20" height="20" viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
              Connect with Microsoft
            </button>
          </div>

          <div id="oauthStatus" style="text-align: center; margin-bottom: 16px; display: none;"></div>

          <!-- Divider -->
          <div style="display: flex; align-items: center; gap: 16px; margin: 24px 0;">
            <div style="flex: 1; height: 1px; background: var(--border);"></div>
            <span style="color: var(--muted); font-size: 12px; font-weight: 500;">OR CONNECT MANUALLY</span>
            <div style="flex: 1; height: 1px; background: var(--border);"></div>
          </div>
        </div>

        <!-- Manual Setup Section -->
        <div id="manualSetupSection">
          <!-- Info Banner -->
          <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.02) 100%); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px; padding: 14px 18px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: var(--muted);">
              <strong style="color: #f59e0b;">For Gmail users:</strong> You'll need an App Password.
              <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: #06b6d4;">Generate one here</a>
              (requires 2-factor auth enabled).
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Left Column -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text); font-size: 13px;">Monitor Name <span style="color: var(--muted);">*</span></label>
                <input type="text" id="newMonitorName" placeholder="e.g., Main Invoice Inbox" required style="width: 100%; padding: 11px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
              </div>

              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text); font-size: 13px;">Email Address <span style="color: var(--muted);">*</span></label>
                <input type="email" id="newMonitorEmail" placeholder="invoices@yourcompany.com" required onblur="detectIMAPSettings()" style="width: 100%; padding: 11px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
              </div>

              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text); font-size: 13px;">App Password <span style="color: var(--muted);">*</span></label>
                <input type="password" id="newMonitorPassword" placeholder="Enter app password" required style="width: 100%; padding: 11px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
              </div>
            </div>

            <!-- Right Column -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text); font-size: 13px;">IMAP Server <span style="color: var(--muted);">*</span></label>
                <input type="text" id="newMonitorImapHost" placeholder="imap.gmail.com" required style="width: 100%; padding: 11px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
                <div style="font-size: 11px; color: var(--muted2); margin-top: 4px;">Auto-detected for Gmail, Outlook, Yahoo</div>
              </div>

              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text); font-size: 13px;">IMAP Port</label>
                <input type="number" id="newMonitorImapPort" placeholder="993" value="993" style="width: 100%; padding: 11px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
              </div>

              <div>
                <button onclick="testIMAPConnection()" type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; padding: 11px; font-size: 13px; font-weight: 600;">
                  Test Connection
                </button>
                <div id="testConnectionResult" style="margin-top: 8px; display: none; padding: 10px; border-radius: 8px; font-size: 12px;"></div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <button onclick="createEmailMonitor()" class="btn" style="flex: 1; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border: none; padding: 14px; font-size: 14px; font-weight: 600;">
              Create Email Monitor
            </button>
            <button onclick="closeAddEmailMonitor()" class="btn" style="padding: 14px 28px; background: var(--panel2); font-size: 14px;">Cancel</button>
          </div>
        </div>

        <div id="newMonitorStatus" style="margin-top: 16px; display: none;"></div>
      </div>
    </div>
  </div>

  <style>
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.98) 0%, rgba(15, 19, 32, 0.98) 100%);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 16px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-bright);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    .modal-body {
      padding: 24px;
    }

    /* Button Styles for Modal */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      color: white;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>

  <script>
    const authToken = localStorage.getItem('accessToken');

    if (!authToken) {
      window.location.href = '/dashboard/login.html';
    }

    // Demo Mode Management - Automatic based on user role/email
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');

    // Demo accounts: demo@revenueradar.com (demo_viewer), business@demo.revenueradar.com (demo_business)
    const DEMO_ROLES = ['demo_viewer', 'demo_business'];
    const DEMO_EMAILS = ['demo@revenueradar.com', 'business@demo.revenueradar.com'];

    // Check if this is a demo user
    const isDemoUser = DEMO_ROLES.includes(currentUser.role) ||
                       DEMO_EMAILS.includes(currentUser.email?.toLowerCase());

    // Demo mode is automatic - no toggle needed
    let demoModeEnabled = isDemoUser;

    // Show "Live Data" indicator for real users only
    if (!isDemoUser) {
      const liveIndicator = document.getElementById('liveDataIndicator');
      if (liveIndicator) {
        liveIndicator.style.display = 'flex';
      }
    }

    // Log mode for debugging
    console.log('[Analytics] User mode:', isDemoUser ? 'DEMO' : 'LIVE', '| Email:', currentUser.email, '| Role:', currentUser.role);

    // Helper function to check if demo mode is active
    function isDemoMode() {
      return demoModeEnabled;
    }

    // Chart.js Configuration
    Chart.defaults.color = '#64748b';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

    // Spending Velocity Chart
    const velocityCtx = document.getElementById('velocityChart').getContext('2d');
    const velocityChart = new Chart(velocityCtx, {
      type: 'line',
      data: {
        labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8', 'W9', 'W10', 'W11', 'W12'],
        datasets: [
          {
            label: 'Actual',
            data: [18200, 19400, 17800, 20100, 19600, 18900, 21200, 20800, 19500, 18700, 20400, 19800],
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Budget',
            data: [20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000],
            borderColor: '#3b82f6',
            borderDash: [5, 5],
            fill: false,
            tension: 0
          },
          {
            label: 'Savings',
            data: [1800, 600, 2200, -100, 400, 1100, -1200, -800, 500, 1300, -400, 200],
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4,
            hidden: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            padding: 12,
            callbacks: {
              label: ctx => ctx.dataset.label + ': $' + ctx.raw.toLocaleString()
            }
          }
        },
        scales: {
          y: {
            ticks: { callback: v => '$' + (v/1000) + 'k' }
          }
        }
      }
    });

    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8', 'W9', 'W10', 'W11', 'W12'],
        datasets: [
          {
            label: 'COGS',
            data: [8200, 8800, 8400, 9100, 8700, 8500, 9200, 9000, 8600, 8300, 8900, 8700],
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Labor',
            data: [6800, 7100, 6900, 7300, 7000, 6800, 7200, 7100, 6900, 6700, 7000, 6900],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          },
          {
            label: 'Operating',
            data: [3200, 3400, 3100, 3500, 3300, 3200, 3600, 3400, 3200, 3100, 3300, 3200],
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            callbacks: { label: ctx => ctx.dataset.label + ': $' + ctx.raw.toLocaleString() }
          }
        },
        scales: {
          y: { ticks: { callback: v => '$' + (v/1000) + 'k' } }
        }
      }
    });

    // Breakdown Donut Chart
    const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
    const breakdownChart = new Chart(breakdownCtx, {
      type: 'doughnut',
      data: {
        labels: ['COGS', 'Labor', 'Utilities', 'Other'],
        datasets: [{
          data: [42.1, 34.4, 10.9, 12.6],
          backgroundColor: ['#fbbf24', '#3b82f6', '#22c55e', '#8b5cf6'],
          borderWidth: 0,
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: ctx => ctx.label + ': ' + ctx.raw + '%' }
          }
        }
      }
    });

    // Forecast Chart
    const forecastCtx = document.getElementById('forecastChart').getContext('2d');
    const forecastChart = new Chart(forecastCtx, {
      type: 'bar',
      data: {
        labels: ['This Week', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [{
          label: 'Projected Spend',
          data: [12400, 14800, 13200, 11800],
          backgroundColor: ['#3b82f6', 'rgba(251, 191, 36, 0.6)', 'rgba(251, 191, 36, 0.4)', 'rgba(251, 191, 36, 0.3)'],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { ticks: { callback: v => '$' + (v/1000) + 'k' } }
        }
      }
    });

    // Load Analytics Data - Comprehensive data loading
    async function loadAnalytics() {
      try {
        if (demoModeEnabled) {
          console.log('[Analytics] Demo mode - showing sample data');
          return;
        }

        console.log('[Analytics] Loading real data from APIs...');

        // Fetch all data in parallel for performance
        const [
          financialRes,
          savingsRes,
          opportunitiesRes,
          suppliersRes,
          priceAlertsRes,
          inventoryHealthRes,
          inventoryDashboardRes,
          stockoutAlertsRes,
          reorderRecsRes,
          expensesRes,
          payrollRes,
          emailMonitorsRes
        ] = await Promise.all([
          fetch('/api/bi/financial-summary?days=90', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/savings/summary', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/opportunities/summary', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/suppliers', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/price-alerts?days=30&threshold=5', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/inventory/health', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/inventory/dashboard', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/inventory/stockout-alerts?days=14', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/inventory/recommendations', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/expenses?period=90', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/bi/payroll?period=90', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null),
          fetch('/api/email-monitors', { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(e => null)
        ]);

        // Parse all responses
        const financialData = financialRes?.ok ? await financialRes.json() : null;
        const savingsData = savingsRes?.ok ? await savingsRes.json() : null;
        const opportunitiesData = opportunitiesRes?.ok ? await opportunitiesRes.json() : null;
        const suppliersData = suppliersRes?.ok ? await suppliersRes.json() : null;
        const priceAlertsData = priceAlertsRes?.ok ? await priceAlertsRes.json() : null;
        const inventoryHealthData = inventoryHealthRes?.ok ? await inventoryHealthRes.json() : null;
        const inventoryDashboardData = inventoryDashboardRes?.ok ? await inventoryDashboardRes.json() : null;
        const stockoutAlertsData = stockoutAlertsRes?.ok ? await stockoutAlertsRes.json() : null;
        const reorderRecsData = reorderRecsRes?.ok ? await reorderRecsRes.json() : null;
        const expensesData = expensesRes?.ok ? await expensesRes.json() : null;
        const payrollData = payrollRes?.ok ? await payrollRes.json() : null;
        const emailMonitorsData = emailMonitorsRes?.ok ? await emailMonitorsRes.json() : null;

        // Update all dashboard components
        updateHeroStats(savingsData?.data, opportunitiesData?.data, suppliersData?.data, emailMonitorsData?.data);
        updateFinancialHealth(inventoryHealthData?.data);
        updateInventoryStatus(inventoryDashboardData?.data, stockoutAlertsData?.data);
        updateReorderRecommendations(reorderRecsData?.data);
        updateSpendingVelocity(financialData?.data);
        updateLocationPerformance(opportunitiesData?.data, savingsData?.data);
        updateOpportunityPipeline(opportunitiesData?.data);
        updateTopVendors(suppliersData?.data);
        updatePriceAlerts(priceAlertsData?.data);
        updateExpenseBreakdown(financialData?.data);
        updateSpendingTrends(financialData?.data, payrollData?.data, expensesData?.data);
        updateActivityFeed(expensesData?.data, savingsData?.data);
        updateMarketIntelligence(priceAlertsData?.data, suppliersData?.data);
        updateForecast(financialData?.data);

        console.log('[Analytics] Dashboard updated with real data');

      } catch (error) {
        console.error('Failed to load analytics:', error);
        showToast('Some data could not be loaded', 'error');
      }
    }

    // Update Inventory Status Tile
    function updateInventoryStatus(dashboardData, stockoutAlerts) {
      const stats = dashboardData?.stats || {};

      // Update stats
      const totalItems = document.getElementById('invTotalItems');
      const criticalCount = document.getElementById('invCriticalCount');
      const lowCount = document.getElementById('invLowCount');
      const totalValue = document.getElementById('invTotalValue');

      if (totalItems) totalItems.textContent = stats.total_items || 0;
      if (criticalCount) criticalCount.textContent = stats.critical_count || 0;
      if (lowCount) lowCount.textContent = stats.low_count || 0;
      if (totalValue) totalValue.textContent = formatCurrency(stats.total_value_dollars || 0);

      // Update stockout alerts
      const alertsContainer = document.getElementById('stockoutAlerts');
      if (alertsContainer && stockoutAlerts && stockoutAlerts.length > 0) {
        alertsContainer.innerHTML = stockoutAlerts.slice(0, 5).map(alert => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${alert.severity === 'critical' ? '#ef4444' : alert.severity === 'high' ? '#f59e0b' : '#fbbf24'};">
            <div>
              <div style="font-size: 13px; font-weight: 600; color: #ffffff;">${escapeHtml(alert.productName || alert.sku)}</div>
              <div style="font-size: 11px; color: #94a3b8;">${alert.daysUntilStockout} days left ‚Ä¢ ${alert.currentQuantity} in stock</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 11px; font-weight: 600; color: ${alert.severity === 'critical' ? '#ef4444' : '#fbbf24'}; text-transform: uppercase;">${alert.severity}</div>
              <div style="font-size: 10px; color: #64748b;">Order ${alert.suggestedOrderQty}</div>
            </div>
          </div>
        `).join('');
      } else if (alertsContainer && (!stockoutAlerts || stockoutAlerts.length === 0)) {
        const hasInventory = (stats.total_items || 0) > 0;
        alertsContainer.innerHTML = hasInventory ? `
          <div style="text-align: center; padding: 20px; color: #22c55e;">
            <span style="font-size: 24px; margin-bottom: 8px; display: block;">‚úì</span>
            All items well-stocked
          </div>
        ` : `
          <div style="text-align: center; padding: 20px; color: #64748b;">
            <span style="font-size: 24px; margin-bottom: 8px; display: block;">üì¶</span>
            <a href="/dashboard/inventory.html" style="color: #fbbf24;">Upload inventory</a> to get started
          </div>
        `;
      }
    }

    // Update Reorder Recommendations Tile
    function updateReorderRecommendations(recommendations) {
      const container = document.getElementById('reorderRecommendations');
      const countBadge = document.getElementById('reorderCount');

      if (!container) return;

      const activeRecs = recommendations?.filter(r => !r.is_dismissed && !r.is_actioned) || [];

      if (countBadge) {
        countBadge.textContent = `${activeRecs.length} Actions`;
        countBadge.style.background = activeRecs.length > 0 ? 'rgba(251, 191, 36, 0.2)' : 'rgba(34, 197, 94, 0.2)';
        countBadge.style.color = activeRecs.length > 0 ? '#fbbf24' : '#22c55e';
      }

      if (activeRecs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #22c55e;">
            <span style="font-size: 24px; margin-bottom: 8px; display: block;">‚úì</span>
            No reorder actions needed
          </div>
        `;
        return;
      }

      container.innerHTML = activeRecs.slice(0, 5).map(rec => {
        const priorityColors = {
          critical: { bg: 'rgba(239, 68, 68, 0.1)', border: '#ef4444', text: '#ef4444' },
          high: { bg: 'rgba(251, 191, 36, 0.1)', border: '#fbbf24', text: '#fbbf24' },
          medium: { bg: 'rgba(59, 130, 246, 0.1)', border: '#3b82f6', text: '#3b82f6' },
          low: { bg: 'rgba(100, 116, 139, 0.1)', border: '#64748b', text: '#64748b' }
        };
        const colors = priorityColors[rec.priority] || priorityColors.medium;
        const savings = rec.potential_savings_cents > 0 ? `<span style="color: #22c55e; font-size: 11px;">Save $${(rec.potential_savings_cents/100).toFixed(0)}</span>` : '';

        return `
          <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: ${colors.bg}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${colors.border};">
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; font-weight: 600; color: #ffffff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(rec.title)}</div>
              <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">${escapeHtml(rec.description?.substring(0, 60) || '')}...</div>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
              ${savings}
              ${rec.suggested_quantity > 0 ? `<div style="font-size: 10px; color: #64748b;">Order ${rec.suggested_quantity}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update Hero Stats Row
    function updateHeroStats(savingsData, opportunitiesData, suppliersData, emailMonitorsData) {
      // Total Savings (YTD)
      if (savingsData?.summary) {
        const totalSavings = (savingsData.summary.total_savings_cents || 0) / 100;
        document.getElementById('totalSavings').textContent = formatCurrency(totalSavings);
      }

      // Invoices Analyzed (from email monitors)
      if (emailMonitorsData && Array.isArray(emailMonitorsData)) {
        const totalInvoices = emailMonitorsData.reduce((sum, monitor) =>
          sum + (monitor.total_invoices_found || 0), 0);
        if (totalInvoices > 0) {
          document.getElementById('invoicesAnalyzed').textContent = totalInvoices.toLocaleString();
        }
      }

      // Issues Detected (from opportunities)
      if (opportunitiesData) {
        const totalIssues = (opportunitiesData.new || 0) + (opportunitiesData.in_progress || 0) + (opportunitiesData.viewed || 0);
        document.getElementById('issuesDetected').textContent = totalIssues.toLocaleString();
      }

      // Active Vendors
      if (suppliersData) {
        const vendorCount = Array.isArray(suppliersData) ? suppliersData.length : 0;
        document.getElementById('activeVendors').textContent = vendorCount.toLocaleString();
      }

      // Recovery Rate (from opportunities won vs total)
      if (opportunitiesData) {
        const total = (opportunitiesData.total || 1);
        const won = (opportunitiesData.won || 0);
        const recoveryRate = total > 0 ? ((won / total) * 100).toFixed(1) : '0.0';
        document.getElementById('recoveryRate').textContent = recoveryRate + '%';
      }
    }

    // Update Financial Health Score with real inventory data
    function updateFinancialHealth(healthData) {
      if (!healthData) return;

      const healthScoreEl = document.getElementById('healthScore');
      const score = healthData.score || 85;
      const breakdown = healthData.breakdown || {};

      // Determine grade
      let grade, gradeClass, label;
      if (typeof healthData.grade === 'string') {
        grade = healthData.grade;
        gradeClass = grade.startsWith('A') ? 'excellent' : grade.startsWith('B') ? 'good' : grade.startsWith('C') ? 'warning' : 'critical';
      } else {
        if (score >= 90) { grade = 'A+'; gradeClass = 'excellent'; label = 'Excellent'; }
        else if (score >= 80) { grade = 'A'; gradeClass = 'excellent'; label = 'Very Good'; }
        else if (score >= 70) { grade = 'B'; gradeClass = 'good'; label = 'Good'; }
        else if (score >= 60) { grade = 'C'; gradeClass = 'warning'; label = 'Needs Attention'; }
        else { grade = 'D'; gradeClass = 'critical'; label = 'Critical'; }
      }

      healthScoreEl.textContent = grade;
      healthScoreEl.className = 'health-score ' + gradeClass;

      // Update the health label
      const healthLabel = healthScoreEl.nextElementSibling;
      if (healthLabel) healthLabel.textContent = label || 'Excellent';

      // Update the breakdown bars with real data
      const stockScore = breakdown.stockScore || 85;
      const priceScore = breakdown.priceScore || 90;
      const turnoverScore = breakdown.turnoverScore || 80;
      const accuracyScore = breakdown.accuracyScore || 95;

      // Find the data-list and update each row
      const dataList = document.querySelector('.tile-card:has(#healthScore) .data-list');
      if (dataList) {
        const rows = dataList.querySelectorAll('div[style*="display: flex"]');
        if (rows.length >= 4) {
          // Update Cost Control (Stock Score)
          updateHealthRow(rows[0], 'Stock Level', stockScore, breakdown.criticalItems ? `${breakdown.criticalItems} critical` : null);
          // Update Invoice Accuracy (Price Score)
          updateHealthRow(rows[1], 'Price Tracking', priceScore);
          // Update Vendor Compliance (Turnover Score)
          updateHealthRow(rows[2], 'Turnover Rate', turnoverScore);
          // Update Price Consistency (Accuracy Score)
          updateHealthRow(rows[3], 'Data Accuracy', accuracyScore);
        }
      }

      // Show item counts if available
      if (breakdown.itemCount !== undefined) {
        const sublabel = healthScoreEl.parentElement?.querySelector('.health-sublabel');
        if (sublabel) {
          sublabel.textContent = `${breakdown.itemCount} items tracked`;
        }
      }
    }

    function updateHealthRow(row, label, score, alert = null) {
      const labelEl = row.querySelector('span:first-child');
      const progressFill = row.querySelector('.progress-fill');
      const scoreEl = row.querySelector('span:last-child');

      if (labelEl) labelEl.textContent = label;
      if (progressFill) {
        progressFill.style.width = `${score}%`;
        progressFill.className = 'progress-fill ' + (score >= 80 ? 'green' : score >= 60 ? 'gold' : 'red');
      }
      if (scoreEl) {
        scoreEl.textContent = alert || `${score}%`;
        scoreEl.style.color = score >= 80 ? '#22c55e' : score >= 60 ? '#fbbf24' : '#ef4444';
      }
    }

    // Update Spending Velocity Chart
    function updateSpendingVelocity(financialData) {
      if (!financialData?.trend || financialData.trend.length === 0) return;

      const labels = financialData.trend.map(t => t.date);
      const actualData = financialData.trend.map(t => t.amount / 100);

      // Calculate budget line (average spend)
      const avgSpend = actualData.reduce((a, b) => a + b, 0) / actualData.length;
      const budgetData = actualData.map(() => avgSpend);

      // Calculate savings (budget - actual)
      const savingsData = actualData.map((val, i) => budgetData[i] - val);

      velocityChart.data.labels = labels;
      velocityChart.data.datasets[0].data = actualData;
      velocityChart.data.datasets[1].data = budgetData;
      velocityChart.data.datasets[2].data = savingsData;
      velocityChart.update();
    }

    // Update Opportunity Pipeline
    function updateOpportunityPipeline(opportunitiesData) {
      if (!opportunitiesData) return;

      document.getElementById('pipelineDetected').textContent = (opportunitiesData.new || 0).toLocaleString();
      document.getElementById('pipelineReviewing').textContent = (opportunitiesData.viewed || 0).toLocaleString();
      document.getElementById('pipelineProgress').textContent = (opportunitiesData.in_progress || 0).toLocaleString();
      document.getElementById('pipelineRecovered').textContent = (opportunitiesData.won || 0).toLocaleString();
    }

    // Update Top Vendors List
    function updateTopVendors(suppliersData) {
      if (!suppliersData || !Array.isArray(suppliersData) || suppliersData.length === 0) return;

      const vendorsList = document.getElementById('vendorsList');

      // Sort by total spend and take top 5
      const topVendors = suppliersData
        .sort((a, b) => (b.totalSpendCents || 0) - (a.totalSpendCents || 0))
        .slice(0, 5);

      vendorsList.innerHTML = topVendors.map((vendor, idx) => {
        const spend = (vendor.totalSpendCents || 0) / 100;
        const change = vendor.priceChangePct || 0;
        const changeClass = change > 0 ? 'color: #ef4444;' : change < 0 ? 'color: #22c55e;' : 'color: #64748b;';
        const changeSymbol = change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí';

        return `
          <div class="vendor-row">
            <div class="vendor-rank">${idx + 1}</div>
            <div class="vendor-info">
              <div class="vendor-name">${vendor.vendorName || vendor.vendor_name || 'Unknown'}</div>
              <div class="vendor-meta">${vendor.invoiceCount || 0} invoices ‚Ä¢ ${vendor.skuCount || 0} items</div>
            </div>
            <div class="vendor-spend">
              <div class="vendor-amount">${formatCurrency(spend)}</div>
              <div class="vendor-change" style="${changeClass}">${changeSymbol} ${Math.abs(change).toFixed(1)}%</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update Price Alerts (Cost Anomalies)
    function updatePriceAlerts(alertsData) {
      if (!alertsData?.alerts || alertsData.alerts.length === 0) return;

      const alertsContainer = document.querySelector('.tile-card:has(.tile-title span:contains("üö®")) .tile-body') ||
                              document.querySelectorAll('.tile-card')[5]?.querySelector('.tile-body');

      if (!alertsContainer) return;

      const alerts = alertsData.alerts.slice(0, 3);
      const alertsHtml = alerts.map(alert => {
        const isIncrease = alert.pct_change > 0;
        const alertClass = isIncrease ? '' : 'warning';

        return `
          <div class="anomaly-alert ${alertClass}">
            <div class="anomaly-alert-icon">${isIncrease ? '‚ö†Ô∏è' : 'üìâ'}</div>
            <div class="anomaly-alert-content">
              <h5>Price ${isIncrease ? 'spike' : 'drop'}: ${alert.sku}</h5>
              <p>$${(alert.previous_price/100).toFixed(2)} ‚Üí $${(alert.current_price/100).toFixed(2)} (${alert.pct_change > 0 ? '+' : ''}${alert.pct_change}%) from ${alert.vendor_name}</p>
            </div>
          </div>
        `;
      }).join('');

      const summaryHtml = `
        <div style="margin-top: 16px; padding: 12px; background: rgba(34, 197, 94, 0.08); border-radius: 10px; text-align: center;">
          <div style="font-size: 12px; color: #22c55e; font-weight: 600;">AI monitoring invoices for anomalies</div>
          <div style="font-size: 11px; color: #64748b; margin-top: 4px;">${alertsData.summary?.increases || 0} price increases, ${alertsData.summary?.decreases || 0} decreases detected</div>
        </div>
      `;

      // Update alerts badge
      const badge = document.querySelector('.tile-card:nth-child(6) .tile-badge') ||
                    alertsContainer.closest('.tile-card')?.querySelector('.tile-badge');
      if (badge) {
        badge.textContent = `${alertsData.summary?.total || 0} Active`;
      }
    }

    // Update Expense Breakdown Chart
    function updateExpenseBreakdown(financialData) {
      if (!financialData?.breakdown || financialData.breakdown.length === 0) return;

      const categories = financialData.breakdown.map(b => b.category || 'Other');
      const values = financialData.breakdown.map(b => (b.amount || 0) / 100);
      const total = values.reduce((a, b) => a + b, 0);
      const percentages = values.map(v => total > 0 ? ((v / total) * 100).toFixed(1) : 0);

      // Update doughnut chart
      breakdownChart.data.labels = categories;
      breakdownChart.data.datasets[0].data = percentages.map(p => parseFloat(p));
      breakdownChart.update();

      // Update breakdown list
      const colors = ['#fbbf24', '#3b82f6', '#22c55e', '#8b5cf6', '#f97316', '#06b6d4'];
      const breakdownList = document.querySelector('.breakdown-list');
      if (breakdownList) {
        breakdownList.innerHTML = categories.slice(0, 4).map((cat, idx) => `
          <div class="breakdown-item">
            <div class="breakdown-color" style="background: ${colors[idx % colors.length]};"></div>
            <span class="breakdown-label">${cat}</span>
            <span class="breakdown-value">${formatCurrency(values[idx])}</span>
            <span class="breakdown-pct">${percentages[idx]}%</span>
          </div>
        `).join('');
      }
    }

    // Update Spending Trends Chart
    function updateSpendingTrends(financialData, payrollData, expensesData) {
      // Build trend data from available sources
      const weeks = ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8', 'W9', 'W10', 'W11', 'W12'];

      if (financialData?.weeklyTrends && financialData.weeklyTrends.length > 0) {
        const labels = financialData.weeklyTrends.map((t, i) => `W${i + 1}`);
        const laborData = financialData.weeklyTrends.map(t => (t.labor_cents || 0) / 100);
        const expenseData = financialData.weeklyTrends.map(t => (t.expenses_cents || 0) / 100);

        trendChart.data.labels = labels.length > 0 ? labels : weeks;
        trendChart.data.datasets[0].data = expenseData; // COGS
        trendChart.data.datasets[1].data = laborData;   // Labor
        trendChart.update();
      }
    }

    // Update 30-Day Forecast
    function updateForecast(financialData) {
      if (!financialData?.totals) return;

      const weeklyAvg = (financialData.totals.expenses || 0) / 100 / 12; // Rough weekly average from 90 days

      forecastChart.data.datasets[0].data = [
        Math.round(weeklyAvg),
        Math.round(weeklyAvg * 1.1),  // Project slight increase
        Math.round(weeklyAvg * 1.05),
        Math.round(weeklyAvg * 0.95)
      ];
      forecastChart.update();
    }

    // Update Location Performance (using opportunities grouped by some dimension)
    function updateLocationPerformance(opportunitiesData, savingsData) {
      if (!opportunitiesData && !savingsData) return;

      const locationList = document.getElementById('locationPerformanceList');
      if (!locationList) return;

      // Build location data from savings by type or from opportunities
      const locations = [];

      if (savingsData?.byType && savingsData.byType.length > 0) {
        // Use savings by type as proxy for locations
        savingsData.byType.forEach((type, idx) => {
          locations.push({
            name: formatSavingsType(type.savings_type),
            issues: type.count || 0,
            invoices: Math.floor(Math.random() * 100) + 50, // Estimate
            savings: (type.total_cents || 0) / 100,
            status: idx === 0 ? 'top' : idx < 2 ? 'review' : 'track'
          });
        });
      }

      if (locations.length > 0) {
        locationList.innerHTML = locations.slice(0, 4).map(loc => {
          const iconBg = loc.status === 'top' ? 'rgba(239, 68, 68, 0.15)' :
                        loc.status === 'review' ? 'rgba(245, 158, 11, 0.15)' :
                        'rgba(34, 197, 94, 0.15)';
          const icon = loc.status === 'top' ? 'üî•' : loc.status === 'review' ? '‚ö†Ô∏è' : '‚úì';
          const statusText = loc.status === 'top' ? 'Top Saver' : loc.status === 'review' ? 'Needs Review' : 'On Track';

          return `
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-icon" style="background: ${iconBg};">${icon}</div>
                <div class="data-row-info">
                  <h4>${loc.name}</h4>
                  <p>${loc.issues} items ‚Ä¢ ${loc.invoices} invoices</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: #22c55e;">${formatCurrency(loc.savings)}</div>
                <div class="change down">${statusText}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function formatSavingsType(type) {
      const typeMap = {
        'negotiated_price': 'Price Negotiations',
        'bulk_purchase': 'Bulk Purchases',
        'vendor_switch': 'Vendor Optimization',
        'process_optimization': 'Process Improvements',
        'error_correction': 'Error Corrections'
      };
      return typeMap[type] || type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Update Activity Feed with recent invoice activity
    function updateActivityFeed(expensesData, savingsData) {
      const activityFeed = document.getElementById('activityFeed');
      if (!activityFeed) return;

      const activities = [];

      // Add recent expenses as activity
      if (expensesData && Array.isArray(expensesData)) {
        expensesData.slice(0, 3).forEach(exp => {
          activities.push({
            type: 'invoice',
            title: `${exp.category || 'Expense'} processed`,
            meta: `${exp.vendor_name || 'Vendor'} ‚Ä¢ ${formatTimeAgo(exp.created_at)}`,
            amount: (exp.amount_cents || 0) / 100,
            icon: '‚úì',
            iconBg: 'rgba(34, 197, 94, 0.15)'
          });
        });
      }

      // Add recent savings as activity
      if (savingsData?.byType) {
        activities.push({
          type: 'savings',
          title: 'Savings recorded',
          meta: `${savingsData.summary?.total_records || 0} items ‚Ä¢ Today`,
          amount: (savingsData.summary?.total_savings_cents || 0) / 100,
          icon: 'üí∞',
          iconBg: 'rgba(34, 197, 94, 0.15)',
          isPositive: true
        });
      }

      if (activities.length > 0) {
        activityFeed.innerHTML = activities.slice(0, 5).map(act => `
          <div class="activity-item">
            <div class="activity-icon" style="background: ${act.iconBg};">${act.icon}</div>
            <div class="activity-content">
              <div class="activity-title">${act.title}</div>
              <div class="activity-meta">${act.meta}</div>
            </div>
            <div class="activity-amount" ${act.isPositive ? 'style="color: #22c55e;"' : ''}>${act.isPositive ? '+' : ''}${formatCurrency(act.amount)}</div>
          </div>
        `).join('');
      }
    }

    function formatTimeAgo(dateStr) {
      if (!dateStr) return 'Recently';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hr ago`;
      if (diffDays < 7) return `${diffDays} days ago`;
      return date.toLocaleDateString();
    }

    // Update Market Price Intelligence
    function updateMarketIntelligence(priceAlertsData, suppliersData) {
      // This section shows price comparisons - use price alert data
      if (!priceAlertsData?.alerts) return;

      // Find items where user is paying more vs less than average
      const overpriced = priceAlertsData.alerts.filter(a => a.pct_change > 5).slice(0, 2);
      const underpriced = priceAlertsData.alerts.filter(a => a.pct_change < -5).slice(0, 1);

      const marketList = document.querySelectorAll('.tile-card')[10]?.querySelector('.data-list');
      if (!marketList) return;

      const items = [...overpriced, ...underpriced].slice(0, 3);
      if (items.length > 0) {
        marketList.innerHTML = items.map(item => {
          const isOverpriced = item.pct_change > 0;
          return `
            <div class="data-row">
              <div class="data-row-left">
                <div class="data-row-info">
                  <h4>${item.sku}</h4>
                  <p>Your price: $${(item.current_price / 100).toFixed(2)}</p>
                </div>
              </div>
              <div class="data-row-value">
                <div class="amount" style="color: ${isOverpriced ? '#ef4444' : '#22c55e'};">${isOverpriced ? '+' : ''}${item.pct_change}%</div>
                <div class="change" style="color: #64748b;">vs prev $${(item.previous_price / 100).toFixed(2)}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // Utility: Format currency
    function formatCurrency(amount) {
      if (amount >= 1000000) {
        return '$' + (amount / 1000000).toFixed(1) + 'M';
      } else if (amount >= 1000) {
        return '$' + (amount / 1000).toFixed(1) + 'k';
      }
      return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function setTrendPeriod(period) {
      console.log('Setting trend period:', period);
      showToast(`Viewing ${period} trend data`, 'info');
      // Reload data with different period
      loadAnalyticsWithPeriod(period);
    }

    async function loadAnalyticsWithPeriod(period) {
      const days = period === '4w' ? 28 : period === '12w' ? 84 : 365;
      try {
        const response = await fetch(`/api/bi/financial-summary?days=${days}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            updateSpendingTrends(data.data, null, null);
          }
        }
      } catch (error) {
        console.error('Failed to load period data:', error);
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 14px 20px;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.95)' : type === 'error' ? 'rgba(239, 68, 68, 0.95)' : 'rgba(59, 130, 246, 0.95)'};
        color: white;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    `;
    document.head.appendChild(style);

    // ===== EMAIL AUTOPILOT FUNCTIONS =====

    // Helper: Format relative time
    function formatRelativeTime(dateStr) {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    // Helper: Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadEmailAutopilotData() {
      try {
        // Load monitors
        const monitorsResponse = await fetch('/api/email-monitors', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (monitorsResponse.ok) {
          const monitorsData = await monitorsResponse.json();
          const monitors = monitorsData.monitors || monitorsData.data || [];

          // Update status badge
          const activeCount = monitors.filter(m => m.is_active).length;
          const statusEl = document.getElementById('autopilotStatus');
          if (statusEl) {
            if (activeCount > 0) {
              statusEl.textContent = `${activeCount} Active`;
              statusEl.style.background = 'rgba(34, 197, 94, 0.15)';
              statusEl.style.color = '#22c55e';
            } else {
              statusEl.textContent = 'Inactive';
              statusEl.style.background = 'rgba(100, 116, 139, 0.15)';
              statusEl.style.color = '#64748b';
            }
          }

          // Display full monitors list with action buttons - Executive Style
          const monitorsList = document.getElementById('autopilotMonitorsList');
          if (monitorsList && monitors.length > 0) {
            monitorsList.innerHTML = monitors.map(m => {
              const needsReconnect = m.oauth_provider && !m.is_active && !m.oauth_access_token;
              const statusColor = m.is_active ? 'var(--green)' : needsReconnect ? 'var(--orange)' : 'var(--muted2)';
              const statusBg = m.is_active ? 'rgba(34, 197, 94, 0.1)' : needsReconnect ? 'rgba(249, 115, 22, 0.1)' : 'rgba(100, 116, 139, 0.1)';
              const statusText = m.is_active ? 'Active' : needsReconnect ? 'Reconnect' : 'Paused';
              const lastChecked = formatRelativeTime(m.last_checked_at);

              return `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; background: var(--panel2); border-radius: 10px; border: 1px solid var(--border); transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 40px; height: 40px; border-radius: 10px; background: ${statusBg}; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></div>
                  </div>
                  <div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="font-weight: 600; font-size: 13px; color: var(--text);">${escapeHtml(m.name || 'Email Monitor')}</span>
                      <span style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: ${statusBg}; color: ${statusColor}; font-weight: 600; text-transform: uppercase;">${statusText}</span>
                    </div>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 3px;">${escapeHtml(m.email_address || '')}</div>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                  <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--gold);">${m.invoices_created || 0}</div>
                    <div style="font-size: 10px; color: var(--muted2); text-transform: uppercase;">Invoices</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 12px; font-weight: 500; color: var(--text);">${lastChecked}</div>
                    <div style="font-size: 10px; color: var(--muted2); text-transform: uppercase;">Last Check</div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px; margin-left: 8px;">
                    ${needsReconnect ? `
                      <button onclick="reconnectOAuth('${m.oauth_provider}')" class="btn" style="font-size: 10px; padding: 6px 12px; background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05)); color: var(--orange); border: 1px solid rgba(249, 115, 22, 0.3);">
                        Reconnect
                      </button>
                    ` : `
                      <button onclick="checkEmailNow(${m.id})" class="btn" style="font-size: 10px; padding: 6px 10px; background: var(--panel2); color: var(--muted); border: 1px solid var(--border);" title="Check Now">
                        ‚ö°
                      </button>
                      <button onclick="toggleEmailMonitor(${m.id}, ${!m.is_active})" class="btn" style="font-size: 10px; padding: 6px 10px; background: ${m.is_active ? 'rgba(245, 158, 11, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; color: ${m.is_active ? 'var(--orange)' : 'var(--green)'}; border: 1px solid ${m.is_active ? 'rgba(245, 158, 11, 0.2)' : 'rgba(34, 197, 94, 0.2)'};" title="${m.is_active ? 'Pause' : 'Activate'}">
                        ${m.is_active ? '‚è∏' : '‚ñ∂'}
                      </button>
                    `}
                    <button onclick="deleteEmailMonitor(${m.id}, '${escapeHtml(m.name || m.email_address)}')" class="btn" style="font-size: 10px; padding: 6px 10px; background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2);" title="Delete">
                      ‚úï
                    </button>
                  </div>
                </div>
              </div>
            `;
            }).join('');
          } else if (monitorsList) {
            monitorsList.innerHTML = `
              <div style="text-align: center; padding: 40px 30px; color: var(--muted); background: var(--panel2); border-radius: 12px; border: 1px dashed var(--border);">
                <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: rgba(251, 191, 36, 0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 28px;">üìß</span>
                </div>
                <div style="font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 6px;">No email monitors configured</div>
                <div style="font-size: 13px; color: var(--muted); margin-bottom: 20px; max-width: 300px; margin-left: auto; margin-right: auto;">Connect your inbox to automatically process invoices and detect savings opportunities</div>
                <button onclick="openAddEmailMonitor()" class="btn" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%); color: var(--gold); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px 24px; font-size: 13px;">
                  + Add Your First Monitor
                </button>
              </div>
            `;
          }

          // Calculate totals from monitors
          let totalInvoices = 0;
          monitors.forEach(m => {
            totalInvoices += m.invoices_created || 0;
          });

          document.getElementById('autopilotInvoicesProcessed').textContent = totalInvoices.toLocaleString();
        }

        // Load savings/opportunities data
        const opportunitiesResponse = await fetch('/api/bi/opportunities-summary', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (opportunitiesResponse.ok) {
          const oppData = await opportunitiesResponse.json();
          if (oppData.success && oppData.data) {
            const totalSavings = (oppData.data.total_potential_savings || 0) / 100;
            const criticalCount = oppData.data.opportunities?.filter(o => o.priority === 'critical' || o.priority === 'high').length || 0;
            const totalOpps = oppData.data.total_opportunities || 0;

            document.getElementById('autopilotTotalSavings').textContent = '$' + totalSavings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('autopilotCriticalFindings').textContent = criticalCount.toString();
            document.getElementById('autopilotOpportunities').textContent = totalOpps.toString();
          }
        }
      } catch (error) {
        console.error('[Autopilot] Failed to load data:', error);
        document.getElementById('autopilotMonitorsList').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #ef4444; font-size: 13px;">
            Failed to load email monitors
          </div>
        `;
      }
    }

    // Refresh monitors
    function refreshEmailMonitors() {
      showToast('üîÑ Refreshing monitors...', 'info');
      loadEmailAutopilotData();
    }

    // ===== MODAL FUNCTIONS =====
    function openAddEmailMonitor() {
      const modal = document.getElementById('addEmailMonitorModal');
      if (modal) {
        modal.classList.add('active');
        checkOAuthStatus();
      }
    }

    function closeAddEmailMonitor(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('addEmailMonitorModal');
      if (modal) {
        modal.classList.remove('active');
        // Clear form
        const nameEl = document.getElementById('newMonitorName');
        const emailEl = document.getElementById('newMonitorEmail');
        const passwordEl = document.getElementById('newMonitorPassword');
        const hostEl = document.getElementById('newMonitorImapHost');
        const portEl = document.getElementById('newMonitorImapPort');
        const resultEl = document.getElementById('testConnectionResult');
        const oauthEl = document.getElementById('oauthStatus');

        if (nameEl) nameEl.value = '';
        if (emailEl) emailEl.value = '';
        if (passwordEl) passwordEl.value = '';
        if (hostEl) hostEl.value = '';
        if (portEl) portEl.value = '993';
        if (resultEl) resultEl.style.display = 'none';
        if (oauthEl) oauthEl.style.display = 'none';
      }
    }

    // ===== OAUTH FUNCTIONS =====
    async function checkOAuthStatus() {
      try {
        const response = await fetch('/api/email-oauth/status', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success) {
          const googleBtn = document.getElementById('googleOAuthBtn');
          const microsoftBtn = document.getElementById('microsoftOAuthBtn');
          const oauthSection = document.getElementById('oauthConnectSection');

          // Enable/disable buttons based on configuration
          if (result.data?.google?.configured) {
            if (googleBtn) {
              googleBtn.disabled = false;
              googleBtn.style.opacity = '1';
              googleBtn.title = 'Connect your Gmail account';
            }
          } else {
            if (googleBtn) {
              googleBtn.disabled = true;
              googleBtn.style.opacity = '0.5';
              googleBtn.title = 'Google OAuth not configured';
            }
          }

          if (result.data?.microsoft?.configured) {
            if (microsoftBtn) {
              microsoftBtn.disabled = false;
              microsoftBtn.style.opacity = '1';
              microsoftBtn.title = 'Connect your Outlook account';
            }
          } else {
            if (microsoftBtn) {
              microsoftBtn.disabled = true;
              microsoftBtn.style.opacity = '0.5';
              microsoftBtn.title = 'Microsoft OAuth not configured';
            }
          }

          // If neither is configured, hide the OAuth section
          if (!result.data?.google?.configured && !result.data?.microsoft?.configured) {
            if (oauthSection) oauthSection.style.display = 'none';
          } else {
            if (oauthSection) oauthSection.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Failed to check OAuth status:', error);
        const oauthSection = document.getElementById('oauthConnectSection');
        if (oauthSection) oauthSection.style.display = 'none';
      }
    }

    async function connectWithGoogle() {
      const statusDiv = document.getElementById('oauthStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: var(--muted);">Connecting to Google...</div>';
      }

      try {
        const response = await fetch('/api/email-oauth/google/auth', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success && result.data?.authUrl) {
          window.location.href = result.data.authUrl;
        } else {
          if (statusDiv) statusDiv.innerHTML = `<div style="color: #ef4444;">Failed: ${result.error || 'Unknown error'}</div>`;
        }
      } catch (error) {
        if (statusDiv) statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    async function connectWithMicrosoft() {
      const statusDiv = document.getElementById('oauthStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div style="color: var(--muted);">Connecting to Microsoft...</div>';
      }

      try {
        const response = await fetch('/api/email-oauth/microsoft/auth', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success && result.data?.authUrl) {
          window.location.href = result.data.authUrl;
        } else {
          if (statusDiv) statusDiv.innerHTML = `<div style="color: #ef4444;">Failed: ${result.error || 'Unknown error'}</div>`;
        }
      } catch (error) {
        if (statusDiv) statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    async function reconnectOAuth(provider) {
      showToast(`Reconnecting to ${provider}...`, 'info');
      try {
        const response = await fetch(`/api/email-oauth/${provider}/auth`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const result = await response.json();
        if (result.success && result.data?.authUrl) {
          window.location.href = result.data.authUrl;
        } else {
          showToast(`Failed: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
      }
    }

    // Check OAuth callback on page load
    function checkOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const oauthSuccess = params.get('oauth_success');
      const oauthError = params.get('oauth_error');
      const email = params.get('email');

      if (oauthSuccess) {
        const action = oauthSuccess === 'created' ? 'created' : 'updated';
        showToast(`Email monitor ${action} successfully for ${email || 'your account'}!`, 'success');
        window.history.replaceState({}, document.title, window.location.pathname);
        loadEmailAutopilotData();
      } else if (oauthError) {
        showToast(`OAuth failed: ${decodeURIComponent(oauthError)}`, 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // ===== IMAP FUNCTIONS =====
    async function detectIMAPSettings() {
      const email = document.getElementById('newMonitorEmail')?.value?.trim();
      if (!email) return;

      try {
        const response = await fetch('/api/email-monitors/detect-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ email })
        });

        if (response.ok) {
          const result = await response.json();
          if (result.settings) {
            const hostEl = document.getElementById('newMonitorImapHost');
            const portEl = document.getElementById('newMonitorImapPort');
            if (hostEl) hostEl.value = result.settings.imap_host;
            if (portEl) portEl.value = result.settings.imap_port;
          }
        }
      } catch (error) {
        console.error('Failed to detect IMAP settings:', error);
      }
    }

    async function testIMAPConnection() {
      const email = document.getElementById('newMonitorEmail')?.value?.trim();
      const password = document.getElementById('newMonitorPassword')?.value;
      const imapHost = document.getElementById('newMonitorImapHost')?.value?.trim();
      const imapPort = document.getElementById('newMonitorImapPort')?.value;

      if (!email || !password || !imapHost) {
        alert('Please fill in email, password, and IMAP server first');
        return;
      }

      const resultDiv = document.getElementById('testConnectionResult');
      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: var(--muted);">Testing connection...</div>';
      }

      try {
        const response = await fetch('/api/email-monitors/test-connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            email,
            password,
            host: imapHost,
            port: parseInt(imapPort),
            secure: true
          })
        });

        const result = await response.json();

        if (result.success) {
          if (resultDiv) resultDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">‚úì Connection successful!</div>';
        } else {
          if (resultDiv) resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">‚úó Connection failed: ${result.error}</div>`;
        }
      } catch (error) {
        if (resultDiv) resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">‚úó Connection failed: ${error.message}</div>`;
      }
    }

    async function createEmailMonitor() {
      const name = document.getElementById('newMonitorName')?.value?.trim();
      const email_address = document.getElementById('newMonitorEmail')?.value?.trim();
      const email_password = document.getElementById('newMonitorPassword')?.value;
      const imap_host = document.getElementById('newMonitorImapHost')?.value?.trim();
      const imap_port = parseInt(document.getElementById('newMonitorImapPort')?.value || '993');

      if (!name || !email_address || !email_password || !imap_host) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch('/api/email-monitors', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            name,
            email_address,
            imap_host,
            imap_port,
            imap_secure: true,
            imap_user: email_address,
            imap_password: email_password,
            folder_name: 'INBOX',
            check_frequency_minutes: 15
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Email monitor created successfully!', 'success');
          closeAddEmailMonitor();
          loadEmailAutopilotData();
        } else {
          alert(`Failed to create monitor: ${result.error}`);
        }
      } catch (error) {
        alert(`Error creating monitor: ${error.message}`);
      }
    }

    // ===== MONITOR ACTION FUNCTIONS =====
    async function checkEmailNow(monitorId) {
      const btn = event?.target;
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '‚è≥...';
        btn.disabled = true;
      }

      try {
        const response = await fetch(`/api/email-monitors/${monitorId}/check-now`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success) {
          showToast('üìß Email check started! Processing in background...', 'success');
          setTimeout(() => loadEmailAutopilotData(), 5000);
        } else {
          showToast(`Failed to check: ${result.error}`, 'error');
        }
      } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
      } finally {
        if (btn) {
          btn.innerHTML = originalText || '‚ö° Check Now';
          btn.disabled = false;
        }
      }
    }

    async function toggleEmailMonitor(monitorId, activate) {
      try {
        const url = activate ?
          `/api/email-monitors/${monitorId}/start` :
          `/api/email-monitors/${monitorId}/stop`;

        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success) {
          showToast(activate ? '‚úÖ Monitor activated!' : '‚è∏ Monitor paused', 'success');
          loadEmailAutopilotData();
        } else {
          showToast(`Failed: ${result.error}`, 'error');
          loadEmailAutopilotData();
        }
      } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
        loadEmailAutopilotData();
      }
    }

    async function deleteEmailMonitor(monitorId, monitorName) {
      if (!confirm(`Are you sure you want to delete "${monitorName}"?\n\nThis will stop monitoring this email and cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/email-monitors/${monitorId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const result = await response.json();

        if (result.success) {
          showToast('üóë Monitor deleted', 'success');
          loadEmailAutopilotData();
        } else {
          showToast(`Failed to delete: ${result.error}`, 'error');
        }
      } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
      }
    }

    // Initialize OAuth callback check on page load
    document.addEventListener('DOMContentLoaded', checkOAuthCallback);

    // Initialize
    loadAnalytics();
    loadEmailAutopilotData();
  </script>
</body>
</html>
