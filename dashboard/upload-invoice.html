<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Invoice - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0f1a;
      color: #e2e8f0;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 24px;
      position: relative;
      z-index: 1;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      text-decoration: none;
      margin-bottom: 32px;
      font-size: 14px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #fbbf24;
    }

    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .subtitle {
      color: #94a3b8;
      margin-bottom: 32px;
    }

    /* Main Upload Card */
    .upload-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 24px;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed rgba(251, 191, 36, 0.3);
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(15, 23, 42, 0.4);
    }

    .drop-zone:hover {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.05);
    }

    .drop-zone.dragover {
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
      transform: scale(1.02);
    }

    .drop-zone.uploading {
      pointer-events: none;
      opacity: 0.7;
    }

    .drop-zone-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .drop-zone-title {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .drop-zone-subtitle {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .drop-zone-formats {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .format-badge {
      padding: 6px 14px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      color: #fbbf24;
    }

    .file-input {
      display: none;
    }

    /* Upload Options */
    .upload-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .upload-options {
        grid-template-columns: 1fr;
      }
    }

    .upload-option {
      padding: 20px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(100, 116, 139, 0.2);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-option:hover {
      border-color: rgba(251, 191, 36, 0.3);
      background: rgba(251, 191, 36, 0.05);
    }

    .upload-option-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }

    .upload-option-title {
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .upload-option-desc {
      font-size: 12px;
      color: #64748b;
    }

    /* Form Section */
    .form-section {
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid rgba(251, 191, 36, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      color: rgba(251, 191, 36, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #fbbf24;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    .form-input::placeholder {
      color: #64748b;
    }

    /* Progress */
    .upload-progress {
      display: none;
      margin-top: 24px;
    }

    .upload-progress.active {
      display: block;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .progress-filename {
      font-weight: 600;
      color: #e2e8f0;
    }

    .progress-percent {
      color: #fbbf24;
      font-weight: 700;
    }

    .progress-bar-container {
      height: 8px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 50px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
      border-radius: 50px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-status {
      margin-top: 12px;
      font-size: 13px;
      color: #64748b;
    }

    /* Results Card */
    .results-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 16px;
      padding: 32px;
      display: none;
    }

    .results-card.active {
      display: block;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .results-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .results-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      font-weight: 800;
      color: #22c55e;
    }

    .results-subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    .results-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .results-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .result-stat {
      text-align: center;
      padding: 16px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
    }

    .result-stat-value {
      font-family: 'Montserrat', sans-serif;
      font-size: 24px;
      font-weight: 800;
      color: #fbbf24;
    }

    .result-stat-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    /* Opportunities List */
    .opportunities-list {
      margin-top: 24px;
    }

    .opportunities-title {
      font-size: 14px;
      font-weight: 700;
      color: rgba(251, 191, 36, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .opportunity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 3px solid #fbbf24;
    }

    .opportunity-info {
      flex: 1;
    }

    .opportunity-type {
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .opportunity-desc {
      font-size: 13px;
      color: #94a3b8;
    }

    .opportunity-value {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      font-weight: 800;
      color: #22c55e;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }

    .btn-secondary:hover {
      background: rgba(251, 191, 36, 0.1);
    }

    /* Recent Uploads */
    .recent-uploads {
      margin-top: 32px;
    }

    .section-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 18px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 16px;
    }

    .upload-history-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(251, 191, 36, 0.1);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .upload-history-item:hover {
      border-color: rgba(251, 191, 36, 0.2);
    }

    .upload-history-icon {
      width: 44px;
      height: 44px;
      background: rgba(251, 191, 36, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .upload-history-info {
      flex: 1;
    }

    .upload-history-name {
      font-weight: 600;
      color: #e2e8f0;
    }

    .upload-history-meta {
      font-size: 13px;
      color: #64748b;
    }

    .upload-history-status {
      padding: 6px 12px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
    }

    .upload-history-status.completed {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .upload-history-status.processing {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    /* Alert */
    .alert {
      padding: 14px 18px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .alert.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .alert.warning {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }

    .alert.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }

    /* Confidence indicator */
    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .confidence-bar-container {
      flex: 1;
      height: 8px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 50px;
      overflow: hidden;
    }

    .confidence-bar {
      height: 100%;
      border-radius: 50px;
      transition: width 0.5s ease;
    }

    .confidence-bar.high { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .confidence-bar.medium { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .confidence-bar.low { background: linear-gradient(90deg, #ef4444, #dc2626); }

    .confidence-label {
      font-size: 13px;
      font-weight: 600;
      min-width: 80px;
    }

    .confidence-label.high { color: #22c55e; }
    .confidence-label.medium { color: #fbbf24; }
    .confidence-label.low { color: #ef4444; }

    /* OCR Tips */
    .ocr-tips {
      background: rgba(251, 191, 36, 0.05);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .ocr-tips-title {
      font-size: 13px;
      font-weight: 700;
      color: #fbbf24;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ocr-tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .ocr-tips-list li {
      font-size: 13px;
      color: #94a3b8;
      padding: 6px 0;
      padding-left: 20px;
      position: relative;
    }

    .ocr-tips-list li::before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: #fbbf24;
    }

    /* Quality metrics */
    .quality-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    @media (max-width: 768px) {
      .quality-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .quality-metric {
      text-align: center;
      padding: 12px;
      background: rgba(15, 23, 42, 0.4);
      border-radius: 8px;
    }

    .quality-metric-value {
      font-size: 18px;
      font-weight: 700;
    }

    .quality-metric-value.good { color: #22c55e; }
    .quality-metric-value.warn { color: #fbbf24; }
    .quality-metric-value.bad { color: #ef4444; }

    .quality-metric-label {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }

    /* Low confidence warning card */
    .low-confidence-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(185, 28, 28, 0.1) 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      display: none;
    }

    .low-confidence-card.active {
      display: block;
      animation: slideIn 0.4s ease;
    }

    .low-confidence-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .low-confidence-icon {
      width: 48px;
      height: 48px;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .low-confidence-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 18px;
      font-weight: 800;
      color: #ef4444;
    }

    .low-confidence-subtitle {
      color: #94a3b8;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="container">
    <a href="vp-view.html" class="back-link">‚Üê Back to Dashboard</a>

    <h1>Upload Invoice</h1>
    <p class="subtitle">Upload an invoice to discover hidden revenue opportunities</p>

    <div id="alertContainer"></div>

    <div class="upload-card">
      <!-- Drop Zone -->
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="drop-zone-icon">üìÑ</div>
        <div class="drop-zone-title">Drag & Drop Your Invoice</div>
        <div class="drop-zone-subtitle">or click to browse files</div>
        <div class="drop-zone-formats">
          <span class="format-badge">PDF</span>
          <span class="format-badge">Photos</span>
          <span class="format-badge">Excel</span>
          <span class="format-badge">CSV</span>
        </div>
        <div class="drop-zone-hint" style="margin-top: 8px; font-size: 12px; color: #888;">
          üì± Phone photos & screenshots supported with OCR
        </div>
      </div>
      <input type="file" id="fileInput" class="file-input" accept=".pdf,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.heic,.webp,.tiff,.tif" multiple onchange="handleFiles(event)">

      <!-- Upload Options -->
      <div class="upload-options">
        <div class="upload-option" onclick="document.getElementById('fileInput').click()">
          <div class="upload-option-icon">üíª</div>
          <div class="upload-option-title">From Computer</div>
          <div class="upload-option-desc">Browse local files</div>
        </div>
        <div class="upload-option" onclick="showAlert('info', 'Email import coming soon!')">
          <div class="upload-option-icon">üìß</div>
          <div class="upload-option-title">From Email</div>
          <div class="upload-option-desc">Connect inbox</div>
        </div>
        <div class="upload-option" onclick="showAlert('info', 'Cloud import coming soon!')">
          <div class="upload-option-icon">‚òÅÔ∏è</div>
          <div class="upload-option-title">From Cloud</div>
          <div class="upload-option-desc">Google Drive, Dropbox</div>
        </div>
      </div>

      <!-- Optional Form Fields -->
      <div class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Account Name (Optional)</label>
            <input type="text" class="form-input" id="accountName" placeholder="Customer or company name">
          </div>
          <div class="form-group">
            <label class="form-label">Vendor Name (Optional)</label>
            <input type="text" class="form-input" id="vendorName" placeholder="Supplier name">
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-header">
          <span class="progress-filename" id="progressFilename">invoice.pdf</span>
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-status" id="progressStatus">Uploading...</div>
      </div>
    </div>

    <!-- Low Confidence Card (for OCR failures) -->
    <div class="low-confidence-card" id="lowConfidenceCard">
      <div class="low-confidence-header">
        <div class="low-confidence-icon">‚ö†Ô∏è</div>
        <div>
          <div class="low-confidence-title">Could Not Extract Invoice Data</div>
          <div class="low-confidence-subtitle" id="lowConfSubtitle">The image quality may be too low for accurate extraction</div>
        </div>
      </div>
      <div class="confidence-indicator">
        <span class="confidence-label low">Confidence</span>
        <div class="confidence-bar-container">
          <div class="confidence-bar low" id="lowConfBar" style="width: 20%"></div>
        </div>
        <span id="lowConfPercent" style="font-size: 13px; color: #ef4444; font-weight: 700;">20%</span>
      </div>
      <div class="ocr-tips" id="ocrTipsSection">
        <div class="ocr-tips-title">üì∑ Tips for Better Results</div>
        <ul class="ocr-tips-list" id="ocrTipsList">
          <li>Hold your phone steady and ensure the invoice is in focus</li>
          <li>Take the photo in a well-lit area</li>
          <li>Make sure the entire invoice is visible</li>
        </ul>
      </div>
      <div class="quality-metrics" id="qualityMetrics" style="display: none;">
        <div class="quality-metric">
          <div class="quality-metric-value" id="qmBlur">-</div>
          <div class="quality-metric-label">Focus</div>
        </div>
        <div class="quality-metric">
          <div class="quality-metric-value" id="qmGlare">-</div>
          <div class="quality-metric-label">Glare</div>
        </div>
        <div class="quality-metric">
          <div class="quality-metric-value" id="qmBrightness">-</div>
          <div class="quality-metric-label">Lighting</div>
        </div>
        <div class="quality-metric">
          <div class="quality-metric-value" id="qmOcr">-</div>
          <div class="quality-metric-label">OCR</div>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="resetUpload()">Try Again</button>
        <button class="btn btn-secondary" onclick="enterManually()">Enter Manually</button>
      </div>
    </div>

    <!-- Results Card -->
      <div class="results-header">
        <div class="results-icon" id="resultsIcon">‚úì</div>
        <div>
          <div class="results-title" id="resultsTitle">Invoice Processed Successfully!</div>
          <div class="results-subtitle" id="resultsFilename">invoice.pdf</div>
        </div>
      </div>

      <!-- Confidence indicator for successful results -->
      <div class="confidence-indicator" id="successConfidence" style="display: none;">
        <span class="confidence-label" id="confLabelSuccess">Confidence</span>
        <div class="confidence-bar-container">
          <div class="confidence-bar" id="confBarSuccess" style="width: 0%"></div>
        </div>
        <span id="confPercentSuccess" style="font-size: 13px; font-weight: 700;">0%</span>
      </div>

      <div class="results-stats">
        <div class="result-stat">
          <div class="result-stat-value" id="statItems">0</div>
          <div class="result-stat-label">Line Items</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="statTotal">$0</div>
          <div class="result-stat-label">Invoice Total</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="statOpportunities">0</div>
          <div class="result-stat-label">Opportunities</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="statSavings">$0</div>
          <div class="result-stat-label">Potential Savings</div>
        </div>
      </div>

      <div class="opportunities-list" id="opportunitiesList">
        <div class="opportunities-title">Detected Opportunities</div>
        <!-- Opportunities will be inserted here -->
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="viewInDashboard()">View in Dashboard</button>
        <button class="btn btn-secondary" onclick="resetUpload()">Upload Another</button>
      </div>
    </div>

    <!-- Recent Uploads -->
    <div class="recent-uploads">
      <h2 class="section-title">Recent Uploads</h2>
      <div id="recentUploadsList">
        <!-- Will be populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    // Check auth
    const token = localStorage.getItem('accessToken');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Drop zone handlers
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles({ target: { files: e.dataTransfer.files } });
    });

    // File handling
    async function handleFiles(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;

      // Process first file
      const file = files[0];
      await uploadFile(file);
    }

    async function uploadFile(file) {
      // Supported file types - now includes images for phone photos/screenshots
      const documentExtensions = ['.pdf', '.xlsx', '.xls', '.csv'];
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.heic', '.webp', '.tiff', '.tif'];
      const allowedExtensions = [...documentExtensions, ...imageExtensions];
      const ext = '.' + file.name.split('.').pop().toLowerCase();

      if (!allowedExtensions.includes(ext)) {
        showAlert('error', 'Please upload a PDF, image (JPG, PNG, HEIC), Excel, or CSV file');
        return;
      }

      const isImage = imageExtensions.includes(ext);
      const isPDF = ext === '.pdf';

      // Show progress
      const progressEl = document.getElementById('uploadProgress');
      progressEl.classList.add('active');
      document.getElementById('progressFilename').textContent = file.name;
      document.getElementById('dropZone').classList.add('uploading');

      // Define progressInterval outside try block so it's accessible in catch
      let progressInterval = null;

      try {
        const accountName = document.getElementById('accountName').value;
        const vendorName = document.getElementById('vendorName').value;

        // Read file first
        updateProgress(10, 'Reading file...');
        const fileContent = await readFileAsBase64(file);

        // Determine payload based on file type
        let rawTextPayload;
        let mimeType = file.type;

        if (isPDF) {
          rawTextPayload = 'PDF_FILE_BASE64:' + fileContent;
          updateProgress(20, 'Preparing PDF for processing...');
        } else if (isImage) {
          // Image files - use universal processor with OCR
          rawTextPayload = 'IMAGE_FILE_BASE64:' + fileContent;
          updateProgress(20, 'Preparing image for OCR processing...');
        } else {
          // Excel/CSV - read as text
          rawTextPayload = await readFileAsText(file);
          updateProgress(20, 'Preparing file...');
        }

        // Create abort controller for timeout (90 seconds for large PDFs)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000);

        // Start progress animation
        let progress = 25;
        const progressMessages = isImage ? [
          'Uploading image...',
          'Preprocessing image...',
          'Running OCR text extraction...',
          'Analyzing invoice content...',
          'Processing invoice data...'
        ] : [
          'Uploading to server...',
          'Parsing document...',
          'Extracting data...',
          'Analyzing content...',
          'Processing invoice...'
        ];
        let msgIndex = 0;

        progressInterval = setInterval(() => {
          progress += Math.random() * 8;
          if (progress > 85) progress = 85;
          updateProgress(progress, progressMessages[msgIndex % progressMessages.length]);
          msgIndex++;
        }, 800);

        console.log('[Upload] Sending to /ingest endpoint...', isImage ? '(image with OCR)' : '');

        const response = await fetch('/ingest', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            raw_text: rawTextPayload,
            source_type: 'upload',
            fileName: file.name,
            mimeType: mimeType,  // Include MIME type for image processing
            accountName: accountName || 'Uploaded Invoice',
            vendorName: vendorName || 'Unknown Vendor'
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        if (progressInterval) clearInterval(progressInterval);

        console.log('[Upload] Response received, status:', response.status);
        updateProgress(90, 'Processing response...');

        if (!response.ok) {
          let errorMessage = 'Upload failed';
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.message || `Server error (${response.status})`;
          } catch (e) {
            errorMessage = `Server error (${response.status})`;
          }
          throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('[Upload] Successfully processed:', result.status);

        // Complete progress
        updateProgress(100, 'Processing complete!');

        // Show results after delay
        setTimeout(() => {
          showResults(file.name, result);
        }, 500);

      } catch (error) {
        if (progressInterval) clearInterval(progressInterval);
        console.error('Upload error:', error);

        let errorMsg = 'Failed to process invoice';
        if (error.name === 'AbortError') {
          errorMsg = 'Upload timed out after 90 seconds. Please try a smaller file or check your connection.';
        } else if (error.message) {
          errorMsg = error.message;
        }

        showAlert('error', errorMsg);
        resetProgress();
      }
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    function updateProgress(percent, status) {
      document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressStatus').textContent = status;
    }

    function resetProgress() {
      document.getElementById('uploadProgress').classList.remove('active');
      document.getElementById('dropZone').classList.remove('uploading');
      document.getElementById('progressBar').style.width = '0%';
    }

    // Map of failure reasons to user-friendly tips
    const FAILURE_TIPS = {
      'too_blurry': 'Hold your phone steady and ensure the invoice is in focus',
      'glare_detected': 'Avoid taking photos under bright lights or direct sunlight',
      'image_too_dark': 'Take the photo in a well-lit area',
      'image_too_bright': 'Move away from bright light sources',
      'document_not_detected': 'Make sure the entire invoice is visible and flat against a surface',
      'low_resolution': 'Move closer to the invoice or use a higher camera resolution',
      'skew_too_severe': 'Try to position your phone directly above the invoice',
      'no_supported_text_detected': 'Ensure the invoice text is legible and not covered',
      'totals_not_found': 'Make sure the total amount is visible in the photo',
      'line_items_not_detected': 'Ensure line items are clearly visible in the image'
    };

    function showResults(filename, result) {
      resetProgress();
      console.log('[Results] Full response:', result);

      // Check for v2 pipeline results with low confidence
      const pipelineV2 = result.extracted?.processorMeta?.pipelineV2 || result.pipelineV2;
      const pipelineV2Fallback = result.extracted?.processorMeta?.pipelineV2Fallback;
      const confidence = result.extracted?.processorMeta?.extractionConfidence ||
                        result.confidence?.overall ||
                        (pipelineV2 ? pipelineV2.confidence?.overallScore : null) || 0;
      const warnings = result.extracted?.processorMeta?.warnings || [];

      // Check if this is a low confidence image upload that should show the warning card
      const isImageUpload = result.extracted?.processorMeta?.fileType === 'image' ||
                           result.extracted?.processorMeta?.extractionMethod?.includes('ocr');
      const isLowConfidence = confidence < 0.4 && isImageUpload;

      if (isLowConfidence && (warnings.length > 0 || pipelineV2Fallback)) {
        showLowConfidenceCard(filename, result, confidence, warnings, pipelineV2);
        return;
      }

      // Normal success flow
      document.getElementById('resultsCard').classList.add('active');
      document.getElementById('resultsFilename').textContent = filename;

      // Show confidence indicator if we have confidence data
      if (confidence > 0) {
        const confPercent = Math.round(confidence * 100);
        let confClass = 'low';
        if (confidence >= 0.8) confClass = 'high';
        else if (confidence >= 0.5) confClass = 'medium';

        document.getElementById('successConfidence').style.display = 'flex';
        document.getElementById('confBarSuccess').style.width = confPercent + '%';
        document.getElementById('confBarSuccess').className = 'confidence-bar ' + confClass;
        document.getElementById('confPercentSuccess').textContent = confPercent + '%';
        document.getElementById('confPercentSuccess').style.color = confClass === 'high' ? '#22c55e' : confClass === 'medium' ? '#fbbf24' : '#ef4444';
        document.getElementById('confLabelSuccess').className = 'confidence-label ' + confClass;

        // Adjust title based on confidence
        if (confidence >= 0.8) {
          document.getElementById('resultsTitle').textContent = 'Invoice Processed Successfully!';
          document.getElementById('resultsIcon').style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
        } else if (confidence >= 0.5) {
          document.getElementById('resultsTitle').textContent = 'Invoice Processed - Please Verify';
          document.getElementById('resultsIcon').style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
        } else {
          document.getElementById('resultsTitle').textContent = 'Invoice Processed - Manual Review Recommended';
          document.getElementById('resultsIcon').style.background = 'linear-gradient(135deg, #f59e0b 0%, #ea580c 100%)';
        }
      } else {
        document.getElementById('successConfidence').style.display = 'none';
        document.getElementById('resultsTitle').textContent = 'Invoice Processed Successfully!';
        document.getElementById('resultsIcon').style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
      }

      // Populate stats - check multiple possible locations for data
      // Items can be in: extracted.items, canonical.line_items, or debug.extractedItemsCount
      const items = result.extracted?.items?.length ||
                    result.canonical?.line_items?.length ||
                    result.debug?.extractedItemsCount ||
                    0;

      // Total can be in: extracted.parsedInvoice.totals, canonical totals, or calculated from items
      let total = 0;
      if (result.extracted?.parsedInvoice?.totals?.totalCents) {
        total = result.extracted.parsedInvoice.totals.totalCents / 100;
      } else if (result.canonical?.total_amount_cents) {
        total = result.canonical.total_amount_cents / 100;
      } else if (result.extracted?.items?.length > 0) {
        // Calculate from items if no total found
        total = result.extracted.items.reduce((sum, item) => {
          const itemTotal = parseFloat(item.totalPrice) || parseFloat(item.unitPrice) || 0;
          return sum + itemTotal;
        }, 0);
      }

      // Opportunities from parsed invoice
      const opportunities = result.extracted?.parsedInvoice?.opportunities?.length ||
                           result.debug?.revenueRadar?.rulesEngine?.opportunities_created ||
                           0;

      // Calculate potential savings from opportunities
      let savings = 0;
      if (result.extracted?.parsedInvoice?.opportunities) {
        savings = result.extracted.parsedInvoice.opportunities.reduce((sum, opp) => {
          return sum + ((opp.amount || 0) / 100);
        }, 0);
      }

      console.log('[Results] Parsed:', { items, total, opportunities, savings });

      document.getElementById('statItems').textContent = items;
      document.getElementById('statTotal').textContent = '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('statOpportunities').textContent = opportunities;
      document.getElementById('statSavings').textContent = '$' + savings.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

      // Populate opportunities list
      const oppList = document.getElementById('opportunitiesList');
      const oppData = result.extracted?.parsedInvoice?.opportunities || result.opportunities || [];

      if (oppData.length > 0) {
        let oppHTML = '<div class="opportunities-title">Detected Opportunities</div>';
        oppData.forEach(opp => {
          const value = (opp.amount || opp.value || 0) / 100;
          oppHTML += `
            <div class="opportunity-item">
              <div class="opportunity-info">
                <div class="opportunity-type">${opp.type || 'Revenue Opportunity'}</div>
                <div class="opportunity-desc">${opp.description || opp.suggestion || 'Potential opportunity detected'}</div>
              </div>
              <div class="opportunity-value">$${value.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
            </div>
          `;
        });
        oppList.innerHTML = oppHTML;
      } else if (items > 0) {
        oppList.innerHTML = `
          <div class="opportunities-title">Invoice Processed</div>
          <p style="color: #64748b; font-size: 14px;">Successfully extracted ${items} line items totaling $${total.toLocaleString(undefined, {minimumFractionDigits: 2})}. No pricing discrepancies found.</p>
        `;
      } else {
        // Show more info when no items extracted
        const warnings = result.extracted?.processorMeta?.warnings || [];
        const fileType = result.extracted?.processorMeta?.fileType || 'unknown';
        const extractionMethod = result.extracted?.processorMeta?.extractionMethod || 'unknown';
        const confidence = result.extracted?.processorMeta?.extractionConfidence || 0;

        let diagnosticMsg = '';
        if (warnings.length > 0) {
          diagnosticMsg = `<br><span style="font-size: 12px; color: #f59e0b;">‚ö†Ô∏è ${warnings.join('. ')}</span>`;
        }

        if (fileType === 'pdf' && confidence < 0.5) {
          diagnosticMsg += `<br><span style="font-size: 12px; color: #64748b;">This may be a scanned PDF. OCR extraction was attempted.</span>`;
        }

        oppList.innerHTML = `
          <div class="opportunities-title">Processing Complete</div>
          <p style="color: #64748b; font-size: 14px;">
            Invoice received and stored. ${items === 0 ? 'No line items could be automatically extracted from this document.' : ''}
            Check the dashboard for detailed analysis.
            ${diagnosticMsg}
          </p>
          <p style="font-size: 11px; color: #475569; margin-top: 8px;">
            File type: ${fileType} | Extraction: ${extractionMethod} | Confidence: ${(confidence * 100).toFixed(0)}%
          </p>
        `;
      }

      // Add to recent uploads
      loadRecentUploads();
    }

    function showLowConfidenceCard(filename, result, confidence, warnings, pipelineV2) {
      document.getElementById('lowConfidenceCard').classList.add('active');

      // Set confidence bar
      const confPercent = Math.round(confidence * 100);
      document.getElementById('lowConfBar').style.width = confPercent + '%';
      document.getElementById('lowConfPercent').textContent = confPercent + '%';

      // Determine subtitle based on failure reasons
      let subtitle = 'The image quality may be too low for accurate extraction';
      if (warnings.includes('too_blurry')) {
        subtitle = 'The image appears to be blurry or out of focus';
      } else if (warnings.includes('glare_detected')) {
        subtitle = 'Glare was detected in the image';
      } else if (warnings.includes('image_too_dark')) {
        subtitle = 'The image is too dark';
      } else if (warnings.includes('no_supported_text_detected')) {
        subtitle = 'Could not detect invoice text in the image';
      }
      document.getElementById('lowConfSubtitle').textContent = subtitle;

      // Build tips list from failure reasons
      const tipsList = document.getElementById('ocrTipsList');
      let tips = [];

      warnings.forEach(reason => {
        if (FAILURE_TIPS[reason]) {
          tips.push(FAILURE_TIPS[reason]);
        }
      });

      // Add generic tips if none specific
      if (tips.length === 0) {
        tips = [
          'Hold your phone steady and ensure the invoice is in focus',
          'Take the photo in a well-lit area',
          'Make sure the entire invoice is visible'
        ];
      }

      tipsList.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');

      // Show quality metrics if available from v2 pipeline
      if (pipelineV2?.quality) {
        const q = pipelineV2.quality;
        document.getElementById('qualityMetrics').style.display = 'grid';

        // Focus (inverse of blur score - higher is better)
        const focusScore = 1 - (q.blurScore || 0);
        setQualityMetric('qmBlur', focusScore, 'Focus');

        // Glare (inverse - lower is better)
        const glareScore = 1 - (q.glareScore || 0);
        setQualityMetric('qmGlare', glareScore, 'Glare');

        // Brightness (0.5 is ideal)
        const brightnessScore = 1 - Math.abs((q.brightness || 0.5) - 0.5) * 2;
        setQualityMetric('qmBrightness', brightnessScore, 'Lighting');

        // OCR confidence
        const ocrScore = result.confidence?.ocr || 0;
        setQualityMetric('qmOcr', ocrScore, 'OCR');
      }
    }

    function setQualityMetric(elementId, score, label) {
      const el = document.getElementById(elementId);
      const percent = Math.round(score * 100);

      // Determine quality class
      let qualityClass = 'bad';
      let icon = '‚úó';
      if (score >= 0.7) {
        qualityClass = 'good';
        icon = '‚úì';
      } else if (score >= 0.4) {
        qualityClass = 'warn';
        icon = '~';
      }

      el.textContent = icon;
      el.className = 'quality-metric-value ' + qualityClass;
    }

    function enterManually() {
      // For now, redirect to dashboard where they can edit
      showAlert('info', 'Manual entry feature coming soon. You can edit invoice data in the dashboard.');
      resetUpload();
    }

    function resetUpload() {
      document.getElementById('resultsCard').classList.remove('active');
      document.getElementById('lowConfidenceCard').classList.remove('active');
      document.getElementById('fileInput').value = '';
      document.getElementById('accountName').value = '';
      document.getElementById('vendorName').value = '';
    }

    function viewInDashboard() {
      window.location.href = 'my-invoices.html';
    }

    // Load recent uploads from database
    async function loadRecentUploads() {
      try {
        const response = await fetch('/api/uploads/recent?limit=5', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          const runs = data.runs || [];

          const listEl = document.getElementById('recentUploadsList');

          if (runs.length === 0) {
            listEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No recent uploads yet. Upload your first invoice above!</p>';
            return;
          }

          listEl.innerHTML = runs.map(run => {
            // Format the date nicely (parse as UTC since server stores in UTC)
            let dateStr = run.createdAt;
            if (dateStr && !dateStr.endsWith('Z') && !dateStr.includes('+')) {
              dateStr = dateStr.replace(' ', 'T') + 'Z';
            }
            const date = dateStr ? new Date(dateStr) : new Date();
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            // Determine status class
            const statusClass = run.status === 'completed' ? 'success' :
                               run.status === 'processing' ? 'pending' : 'failed';

            return `
              <div class="upload-history-item">
                <div class="upload-history-icon">üìÑ</div>
                <div class="upload-history-info">
                  <div class="upload-history-name">${run.fileName || 'Invoice'}</div>
                  <div class="upload-history-meta">${run.vendorName || run.accountName || 'Unknown'} ‚Ä¢ ${formattedDate}</div>
                </div>
                <span class="upload-history-status ${statusClass}">${run.status || 'completed'}</span>
              </div>
            `;
          }).join('');
        } else {
          console.error('Failed to load recent uploads:', response.status);
          document.getElementById('recentUploadsList').innerHTML =
            '<p style="color: #64748b; text-align: center; padding: 20px;">Could not load recent uploads</p>';
        }
      } catch (error) {
        console.error('Error loading recent uploads:', error);
        document.getElementById('recentUploadsList').innerHTML =
          '<p style="color: #64748b; text-align: center; padding: 20px;">Error loading uploads</p>';
      }
    }

    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert ${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 4000);
    }

    // Initial load
    loadRecentUploads();
  </script>
</body>
</html>
