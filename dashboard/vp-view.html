<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Dashboard - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       PREMIUM EXECUTIVE DASHBOARD STYLES
       Revenue Radar - Business Dashboard
       ======================================== */

    :root {
      /* Executive Premium Dark Palette - Deeper & More Prestigious */
      --bg: #050810;
      --bg-secondary: #080c14;
      --bg-gradient: linear-gradient(145deg, #050810 0%, #0a0e18 50%, #080c14 100%);
      --panel: #0c1019;
      --panel2: #0a0d15;
      --panel-elevated: #0e121c;
      --panel-glass: rgba(12, 16, 25, 0.85);

      /* Refined Borders & Dividers */
      --border: rgba(255, 255, 255, 0.05);
      --border-subtle: rgba(255, 255, 255, 0.03);
      --border-hover: rgba(212, 175, 55, 0.3);
      --border-gold: rgba(212, 175, 55, 0.25);

      /* Premium Text Hierarchy */
      --text: rgba(255, 255, 255, 0.92);
      --text-bright: #f8fafc;
      --text-heading: #ffffff;
      --muted: rgba(255, 255, 255, 0.65);
      --muted2: rgba(255, 255, 255, 0.45);
      --muted3: rgba(255, 255, 255, 0.3);

      /* Refined Gold Accents - More Executive/Prestigious */
      --gold: #d4af37;
      --gold-light: #e6c55a;
      --gold-dark: #b8972f;
      --gold-darker: #9a7b24;
      --gold-glow: rgba(212, 175, 55, 0.12);
      --gold-shimmer: linear-gradient(135deg, #d4af37 0%, #e6c55a 50%, #d4af37 100%);

      /* Status Colors - Refined */
      --good: rgba(74, 222, 128, 0.15);
      --good-text: #4ade80;
      --warn: rgba(251, 191, 36, 0.15);
      --warn-text: #fbbf24;
      --error: rgba(248, 113, 113, 0.15);
      --error-text: #f87171;

      /* Premium Shadows */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 40px rgba(212, 175, 55, 0.08);
    }

    /* ========================================
       BASE RESET & TYPOGRAPHY
       ======================================== */

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      margin: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at top left, rgba(212, 175, 55, 0.03) 0%, transparent 40%),
        radial-gradient(ellipse at top right, rgba(15, 23, 42, 0.5) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(5, 8, 16, 0.95) 0%, transparent 60%);
      background-attachment: fixed;
      color: var(--text);
      line-height: 1.5;
    }

    /* ========================================
       LAYOUT
       ======================================== */

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .pageBody {
      width: min(1400px, 94vw);
      margin: 24px auto 48px;
      display: grid;
      gap: 20px;
    }

    /* ========================================
       HEADER
       ======================================== */

    .header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .headerTitle {
      font-size: 24px;
      letter-spacing: 0.3px;
      font-weight: 800;
      color: var(--text-bright);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      margin-bottom: 8px;
    }

    .headerSub {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .headerRight {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* ========================================
       CARDS
       ======================================== */

    .card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.6) 0%, rgba(15, 19, 32, 0.8) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 1px 4px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      border-color: var(--border-hover);
      box-shadow:
        0 6px 24px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    /* ========================================
       METRICS ROW
       ======================================== */

    .metricsRow {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
    }

    .metricTile {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px 18px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .metricTile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold) 0%, var(--gold-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .metricTile:hover {
      border-color: var(--border-gold);
      background: rgba(15, 23, 42, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(251, 191, 36, 0.15);
    }

    .metricTile:hover::before {
      opacity: 1;
    }

    .metricLabel {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .metricValue {
      font-size: 28px;
      font-weight: 900;
      color: var(--text-bright);
      margin-top: 8px;
      letter-spacing: 0.3px;
      line-height: 1.2;
      font-family: 'Montserrat', 'Inter', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .metricSub {
      font-size: 12px;
      color: var(--muted2);
      font-weight: 700;
      margin-top: 8px;
      opacity: 0.75;
    }

    /* ========================================
       GRID LAYOUTS
       ======================================== */

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* ========================================
       SECTION HEADERS
       ======================================== */

    .sectionHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .sectionTitle {
      font-size: 14px;
      font-weight: 800;
      color: var(--text-bright);
      letter-spacing: 0.3px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    /* ========================================
       BREAKDOWN LISTS
       ======================================== */

    .breakdownList {
      display: grid;
      gap: 10px;
    }

    .breakdownRow {
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .breakdownRow:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.05);
      transform: translateX(3px);
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.1);
    }

    .breakdownRow-active {
      outline: 2px solid var(--border-gold);
      outline-offset: -1px;
      background: rgba(251, 191, 36, 0.08);
    }

    .breakdownLeft {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }

    .breakdownRank {
      width: 22px;
      color: var(--muted2);
      font-size: 13px;
      font-weight: 800;
      text-align: center;
    }

    .breakdownName {
      font-size: 14px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text);
    }

    .breakdownRight {
      text-align: right;
    }

    .breakdownAmount {
      font-weight: 800;
      font-size: 15px;
      color: var(--text-bright);
    }

    .breakdownMeta {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
      font-weight: 600;
    }

    /* ========================================
       TABLES
       ======================================== */

    .tableWrap {
      overflow-x: auto;
      border-radius: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--border);
      padding: 14px 12px;
      vertical-align: middle;
      transition: background 0.2s;
    }

    .table th {
      color: var(--muted);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.2);
    }

    .table tbody tr:hover {
      background: rgba(251, 191, 36, 0.03);
    }

    .cellMain {
      font-weight: 700;
      color: var(--text-bright);
    }

    .num {
      text-align: right;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .clickable {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }

    .clickable:hover {
      color: var(--gold);
    }

    /* ========================================
       BUTTONS
       ======================================== */

    .btn {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.08);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
    }

    .btn-ghost {
      background: transparent;
      box-shadow: none;
    }

    /* Compact Header Action Buttons */
    .header-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(12, 16, 25, 0.9) 100%);
      color: var(--text);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      white-space: nowrap;
    }

    .header-action-btn:hover {
      border-color: var(--border-gold);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12) 0%, rgba(212, 175, 55, 0.08) 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
    }

    .header-action-btn .btn-icon {
      font-size: 14px;
    }

    .header-action-btn .btn-badge {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      font-size: 10px;
      font-weight: 800;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 2px;
    }

    .header-action-btn.upload:hover {
      border-color: rgba(59, 130, 246, 0.5);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(37, 99, 235, 0.08) 100%);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .header-action-btn.actions:hover {
      border-color: rgba(251, 191, 36, 0.5);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.12) 0%, rgba(217, 119, 6, 0.08) 100%);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
    }

    .header-action-btn.actions .btn-badge {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .header-action-btn.payroll:hover {
      border-color: rgba(34, 197, 94, 0.5);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.12) 0%, rgba(22, 163, 74, 0.08) 100%);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }

    /* ========================================
       FORM INPUTS
       ======================================== */

    .select {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }

    .select:hover,
    .select:focus {
      border-color: var(--border-gold);
      background: rgba(255, 255, 255, 0.05);
      outline: none;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    input[type="date"] {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      color-scheme: dark;
    }

    input[type="date"]:hover,
    input[type="date"]:focus {
      border-color: var(--border-gold);
      background: rgba(255, 255, 255, 0.05);
      outline: none;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    /* ========================================
       BADGES
       ======================================== */

    .badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-neutral {
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
    }

    .badge-good {
      background: var(--good);
      border-color: rgba(120, 255, 190, 0.3);
      color: rgba(120, 255, 190, 0.95);
    }

    .badge-warn {
      background: var(--warn);
      border-color: rgba(255, 210, 120, 0.3);
      color: rgba(255, 210, 120, 0.95);
    }

    /* ========================================
       STATES
       ======================================== */

    .emptyState {
      color: var(--muted);
      font-size: 13px;
      padding: 24px 16px;
      text-align: center;
      font-weight: 600;
    }

    .errorState {
      border: 1px solid rgba(255, 90, 90, 0.4);
      background: rgba(255, 90, 90, 0.08);
      padding: 16px;
      border-radius: 14px;
    }

    .errorTitle {
      font-weight: 800;
      margin-bottom: 8px;
      color: rgba(255, 90, 90, 0.95);
    }

    .errorMsg {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .loadingState {
      color: var(--muted);
      font-size: 13px;
      padding: 24px 16px;
      text-align: center;
      font-weight: 600;
    }

    /* ========================================
       CLICKABLE METRIC TILES
       ======================================== */

    .metricTile.clickable {
      cursor: pointer;
    }

    .metricTile.clickable .metricSub {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metricTile.clickable .metricSub::after {
      content: '→';
      opacity: 0;
      transform: translateX(-4px);
      transition: all 0.2s ease;
    }

    .metricTile.clickable:hover .metricSub::after {
      opacity: 1;
      transform: translateX(0);
    }

    /* ========================================
       SEE PROOF BUTTON
       ======================================== */

    .btn-proof {
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-proof:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    /* ========================================
       PROOF MODAL
       ======================================== */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 1;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      font-size: 24px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 24px;
    }

    /* Proof Details */
    .proof-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .proof-stat {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .proof-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .proof-stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .proof-stat-value.savings {
      color: #10b981;
    }

    .proof-stat-value.delta {
      color: var(--gold);
    }

    /* Invoice Preview */
    .invoice-preview {
      background: #ffffff;
      border-radius: 8px;
      padding: 24px;
      color: #1a1a1a;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .invoice-header {
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 16px;
      margin-bottom: 16px;
    }

    .invoice-vendor {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .invoice-meta {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
    }

    .invoice-line {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 16px;
      padding: 8px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .invoice-line.highlighted {
      background: linear-gradient(90deg, rgba(251, 191, 36, 0.3) 0%, rgba(251, 191, 36, 0.1) 100%);
      margin: 0 -12px;
      padding: 12px;
      border: 2px solid #f59e0b;
      border-radius: 6px;
      position: relative;
    }

    .invoice-line.highlighted::before {
      content: '⚠️ FLAGGED';
      position: absolute;
      top: -10px;
      left: 12px;
      background: #f59e0b;
      color: #1a1a1a;
      font-size: 10px;
      font-weight: 800;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .line-desc {
      font-weight: 500;
    }

    .line-qty {
      color: #6b7280;
    }

    .line-amount {
      font-weight: 700;
      text-align: right;
    }

    .line-amount.flagged {
      color: #dc2626;
      text-decoration: line-through;
    }

    .line-expected {
      color: #059669;
      font-weight: 700;
    }

    /* Issue Explanation */
    .issue-explanation {
      background: var(--panel2);
      border: 1px solid var(--border-gold);
      border-radius: 12px;
      padding: 20px;
    }

    .explanation-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--gold);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .explanation-text {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .explanation-action {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .explanation-action strong {
      color: var(--text);
    }

    /* Clickable Breakdown Rows */
    .breakdownRow.clickable-row {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .breakdownRow.clickable-row:hover {
      background: rgba(251, 191, 36, 0.08);
      transform: translateX(4px);
    }

    .breakdownRow.clickable-row:hover .breakdownName {
      color: var(--gold);
    }

    .drill-arrow {
      opacity: 0;
      transition: all 0.2s ease;
      margin-left: 4px;
    }

    .breakdownRow.clickable-row:hover .drill-arrow {
      opacity: 1;
    }

    /* Drill-down Modal Styles */
    .drilldown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%);
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .drilldown-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .drilldown-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .drilldown-stats {
      display: flex;
      gap: 24px;
    }

    .drilldown-stat {
      text-align: right;
    }

    .drilldown-stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold);
    }

    .drilldown-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .drilldown-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .drilldown-tab {
      padding: 8px 16px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .drilldown-tab:hover {
      border-color: var(--border-gold);
      color: var(--text);
    }

    .drilldown-tab.active {
      background: var(--gold);
      border-color: var(--gold);
      color: #1a1a1a;
    }

    .drilldown-issues {
      display: grid;
      gap: 12px;
    }

    .drilldown-issue {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 16px;
      align-items: center;
      padding: 16px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .drilldown-issue:hover {
      border-color: var(--border-gold);
    }

    .issue-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .issue-type {
      font-weight: 700;
      color: var(--text);
    }

    .issue-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .issue-amount {
      text-align: right;
    }

    .issue-current {
      font-size: 14px;
      color: var(--muted);
      text-decoration: line-through;
    }

    .issue-delta {
      font-size: 20px;
      font-weight: 800;
      color: var(--gold);
    }

    /* Location Modal */
    .location-list {
      display: grid;
      gap: 12px;
    }

    .location-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .location-item:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.05);
    }

    .location-name {
      font-weight: 700;
      color: var(--text);
    }

    .location-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .location-stats {
      text-align: right;
    }

    .location-invoices {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .location-savings {
      font-size: 12px;
      color: #10b981;
      font-weight: 600;
    }

    /* ========================================
       RESPONSIVE DESIGN
       ======================================== */

    @media (max-width: 1100px) {
      .metricsRow {
        grid-template-columns: 1fr 1fr;
      }
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .pageBody {
        width: 96vw;
        gap: 16px;
      }

      .header {
        padding: 14px 16px;
      }

      .metricsRow {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 16px;
      }

      .tableWrap {
        overflow-x: auto;
      }
    }

    /* Trial Banner Styles */
    .trial-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #1a1a1a;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
      display: none;
    }

    .trial-banner.warning {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .trial-banner-text {
      font-size: 15px;
    }

    /* ========================================
       QUICK ACTION TILES
       ======================================== */

    .quick-action-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      font-family: inherit;
      font-size: inherit;
    }

    .quick-action-tile:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.15);
    }

    .quick-action-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .quick-action-label {
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      color: var(--muted);
    }

    .quick-action-tile:hover .quick-action-label {
      color: var(--text);
    }

    /* ========================================
       PROGRESS BARS
       ======================================== */

    .progress-bar-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* ========================================
       DEMO MODE TOGGLE (Admin Only)
       ======================================== */

    .demo-toggle-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      margin-left: auto;
    }

    .demo-toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(17, 21, 37, 0.8);
      padding: 8px 16px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .demo-toggle-label {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      transition: color 0.3s;
    }

    .demo-toggle-label.active {
      color: #fbbf24;
    }

    .demo-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }

    .demo-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .demo-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      border-radius: 24px;
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .demo-toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background: #94a3b8;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .demo-toggle input:checked + .demo-toggle-slider {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-color: rgba(251, 191, 36, 0.5);
    }

    .demo-toggle input:checked + .demo-toggle-slider:before {
      transform: translateX(24px);
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
    }

    .demo-mode-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 12px;
      border-radius: 12px;
      transition: all 0.3s;
    }

    .demo-mode-indicator.demo {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .demo-mode-indicator.real {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .indicator-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    .demo-mode-indicator.demo .indicator-dot {
      background: #f87171;
    }

    .demo-mode-indicator.real .indicator-dot {
      background: #4ade80;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    /* ========================================
       BUSINESS ANALYTICS EMBEDDED STYLES
       ======================================== */

    /* Achievement Banner */
    .achievement-banner {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }

    .achievement-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .achievement-content {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    .achievement-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 12px;
      font-size: 24px;
      box-shadow: 0 6px 16px rgba(251, 191, 36, 0.3);
      animation: pulse-icon 2s ease-in-out infinite;
    }

    @keyframes pulse-icon {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .achievement-text h3 {
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 4px 0;
    }

    .achievement-text p {
      color: #fbbf24;
      font-size: 13px;
      margin: 0;
    }

    .streak-counter {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .streak-flame {
      font-size: 32px;
      animation: flicker 1s ease-in-out infinite alternate;
    }

    @keyframes flicker {
      0% { transform: scale(1) rotate(-3deg); }
      100% { transform: scale(1.1) rotate(3deg); }
    }

    .streak-number {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .streak-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Analytics Score Section */
    .analytics-score-section {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .total-score-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 2px solid rgba(251, 191, 36, 0.3);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .score-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #fbbf24;
      margin-bottom: 8px;
    }

    .total-savings {
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
      margin-bottom: 6px;
    }

    .savings-period {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 16px;
    }

    .level-progress {
      margin-top: 16px;
    }

    .level-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .level-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }

    .level-fill {
      height: 100%;
      background: linear-gradient(90deg, #fbbf24, #22c55e);
      border-radius: 5px;
      transition: width 1s ease-out;
      position: relative;
    }

    .level-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: levelShine 2s infinite;
    }

    @keyframes levelShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .next-level {
      margin-top: 10px;
      font-size: 12px;
      color: #fbbf24;
    }

    /* Comparison Grid */
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .comparison-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: 12px;
      padding: 16px;
      position: relative;
    }

    .comparison-card.improved {
      border-color: rgba(34, 197, 94, 0.3);
    }

    .comparison-card.warning {
      border-color: rgba(251, 191, 36, 0.3);
    }

    .comparison-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .comparison-title {
      font-size: 11px;
      font-weight: 500;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .comparison-badge.up {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .comparison-badge.down {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .comparison-value {
      font-size: 24px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 6px;
    }

    .comparison-vs {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #64748b;
    }

    .vs-arrow {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .vs-arrow.up { color: #22c55e; }
    .vs-arrow.down { color: #ef4444; }

    /* Analytics Charts */
    .analytics-charts-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .analytics-chart-card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.6) 0%, rgba(15, 19, 32, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
    }

    .chart-legend {
      display: flex;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #94a3b8;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .legend-dot.payroll { background: #fbbf24; }
    .legend-dot.expenses { background: #ef4444; }

    .breakdown-list {
      margin-top: 16px;
    }

    .breakdown-item {
      display: grid;
      grid-template-columns: 8px 1fr auto auto;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .breakdown-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .breakdown-label {
      font-size: 13px;
      color: #e2e8f0;
    }

    .breakdown-value {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
    }

    .breakdown-pct {
      font-size: 12px;
      color: #64748b;
    }

    @media (max-width: 900px) {
      .analytics-score-section {
        grid-template-columns: 1fr;
      }
      .analytics-charts-section {
        grid-template-columns: 1fr;
      }
      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ========================================
       COMMAND CENTER STYLES
       ======================================== */

    /* Compact Quick Actions Row */
    /* Premium Quick Actions Tiles */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .quick-action-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 28px 18px;
      background: linear-gradient(165deg, rgba(12, 16, 25, 0.97) 0%, rgba(8, 12, 20, 0.99) 100%);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 20px;
      color: #e2e8f0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      min-height: 130px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }

    .quick-action-tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }

    .quick-action-tile::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(212, 175, 55, 0.03) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }

    .quick-action-tile:hover {
      border-color: rgba(212, 175, 55, 0.35);
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(212, 175, 55, 0.08);
    }

    .quick-action-tile:hover::before,
    .quick-action-tile:hover::after {
      opacity: 1;
    }

    .quick-action-tile .tile-icon {
      font-size: 36px;
      margin-bottom: 14px;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
      transition: transform 0.3s ease;
    }

    .quick-action-tile:hover .tile-icon {
      transform: scale(1.08);
    }

    .quick-action-tile .tile-label {
      font-size: 12px;
      font-weight: 700;
      color: rgba(148, 163, 184, 0.9);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .quick-action-tile .tile-value {
      font-size: 22px;
      font-weight: 800;
      color: var(--gold);
      margin-top: 6px;
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    /* Analytics Tile - Emerald Theme */
    .quick-action-tile.analytics {
      background: linear-gradient(165deg, rgba(8, 25, 18, 0.97) 0%, rgba(5, 18, 12, 0.99) 100%);
      border-color: rgba(16, 185, 129, 0.2);
    }
    .quick-action-tile.analytics::before {
      background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.6), transparent);
    }
    .quick-action-tile.analytics:hover {
      border-color: rgba(16, 185, 129, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(16, 185, 129, 0.12);
    }
    .quick-action-tile.analytics .tile-value {
      color: #10b981;
      text-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
    }

    /* Actions Tile - Gold Theme */
    .quick-action-tile.actions {
      background: linear-gradient(165deg, rgba(25, 18, 8, 0.97) 0%, rgba(18, 12, 5, 0.99) 100%);
      border-color: rgba(212, 175, 55, 0.2);
    }
    .quick-action-tile.actions::before {
      background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.6), transparent);
    }
    .quick-action-tile.actions:hover {
      border-color: rgba(212, 175, 55, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(212, 175, 55, 0.12);
    }
    .quick-action-tile.actions .tile-badge {
      position: absolute;
      top: 14px;
      right: 14px;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      font-size: 10px;
      font-weight: 800;
      padding: 5px 10px;
      border-radius: 12px;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
      animation: pulse-badge 2s infinite;
    }

    .quick-action-tile .tile-subtitle {
      font-size: 11px;
      color: rgba(100, 116, 139, 0.9);
      margin-top: 6px;
      letter-spacing: 0.3px;
    }

    /* Results Tile - Success Green Theme */
    .quick-action-tile.results {
      background: linear-gradient(165deg, rgba(8, 22, 16, 0.97) 0%, rgba(5, 15, 10, 0.99) 100%);
      border-color: rgba(34, 197, 94, 0.2);
    }
    .quick-action-tile.results::before {
      background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);
    }
    .quick-action-tile.results:hover {
      border-color: rgba(34, 197, 94, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(34, 197, 94, 0.1);
    }
    .quick-action-tile.results .tile-value {
      color: #22c55e;
      text-shadow: 0 0 25px rgba(34, 197, 94, 0.4);
    }

    /* Locations Tile - Blue Theme */
    .quick-action-tile.locations {
      background: linear-gradient(165deg, rgba(10, 18, 35, 0.97) 0%, rgba(6, 12, 25, 0.99) 100%);
      border-color: rgba(59, 130, 246, 0.2);
    }
    .quick-action-tile.locations::before {
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), transparent);
    }
    .quick-action-tile.locations:hover {
      border-color: rgba(59, 130, 246, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(59, 130, 246, 0.1);
    }
    .quick-action-tile.locations .tile-value {
      color: #3b82f6;
      text-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
    }

    /* Pipeline Tile - Purple Theme */
    .quick-action-tile.pipeline {
      background: linear-gradient(165deg, rgba(22, 12, 30, 0.97) 0%, rgba(15, 8, 22, 0.99) 100%);
      border-color: rgba(139, 92, 246, 0.2);
    }
    .quick-action-tile.pipeline::before {
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.6), transparent);
    }
    .quick-action-tile.pipeline:hover {
      border-color: rgba(139, 92, 246, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.1);
    }
    .quick-action-tile.pipeline .tile-value {
      color: #8b5cf6;
      text-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
    }

    /* Events Tile - Violet Theme */
    .quick-action-tile.events {
      background: linear-gradient(165deg, rgba(25, 15, 35, 0.97) 0%, rgba(18, 10, 26, 0.99) 100%);
      border-color: rgba(168, 85, 247, 0.2);
    }
    .quick-action-tile.events::before {
      background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.6), transparent);
    }
    .quick-action-tile.events:hover {
      border-color: rgba(168, 85, 247, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(168, 85, 247, 0.1);
    }
    .quick-action-tile.events .tile-value {
      color: #a855f7;
      text-shadow: 0 0 25px rgba(168, 85, 247, 0.4);
    }

    /* Catering Tile - Rose/Pink Theme */
    .quick-action-tile.catering {
      background: linear-gradient(165deg, rgba(30, 12, 22, 0.97) 0%, rgba(22, 8, 16, 0.99) 100%);
      border-color: rgba(236, 72, 153, 0.2);
    }
    .quick-action-tile.catering::before {
      background: linear-gradient(90deg, transparent, rgba(236, 72, 153, 0.6), transparent);
    }
    .quick-action-tile.catering:hover {
      border-color: rgba(236, 72, 153, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(236, 72, 153, 0.1);
    }
    .quick-action-tile.catering .tile-value {
      color: #ec4899;
      text-shadow: 0 0 25px rgba(236, 72, 153, 0.4);
    }

    /* Payroll Tile - Teal/Success Theme */
    .quick-action-tile.payroll {
      background: linear-gradient(165deg, rgba(8, 25, 20, 0.97) 0%, rgba(5, 18, 14, 0.99) 100%);
      border-color: rgba(20, 184, 166, 0.2);
    }
    .quick-action-tile.payroll::before {
      background: linear-gradient(90deg, transparent, rgba(20, 184, 166, 0.6), transparent);
    }
    .quick-action-tile.payroll:hover {
      border-color: rgba(20, 184, 166, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(20, 184, 166, 0.1);
    }
    .quick-action-tile.payroll .tile-value {
      color: #14b8a6;
      text-shadow: 0 0 25px rgba(20, 184, 166, 0.4);
    }

    /* Expense Tile - Amber/Gold Theme */
    .quick-action-tile.expense {
      background: linear-gradient(165deg, rgba(28, 22, 10, 0.97) 0%, rgba(20, 15, 6, 0.99) 100%);
      border-color: rgba(245, 158, 11, 0.2);
    }
    .quick-action-tile.expense::before {
      background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.6), transparent);
    }
    .quick-action-tile.expense:hover {
      border-color: rgba(245, 158, 11, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(245, 158, 11, 0.1);
    }
    .quick-action-tile.expense .tile-value {
      color: #f59e0b;
      text-shadow: 0 0 25px rgba(245, 158, 11, 0.4);
    }

    /* Intent Signals Tile - Orange/Red Theme for Urgency */
    .quick-action-tile.intent {
      background: linear-gradient(165deg, rgba(35, 18, 10, 0.97) 0%, rgba(25, 12, 6, 0.99) 100%);
      border-color: rgba(249, 115, 22, 0.25);
      position: relative;
    }
    .quick-action-tile.intent::before {
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.7), transparent);
    }
    .quick-action-tile.intent:hover {
      border-color: rgba(249, 115, 22, 0.5);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(249, 115, 22, 0.15);
    }
    .quick-action-tile.intent .tile-value {
      color: #f97316;
      text-shadow: 0 0 25px rgba(249, 115, 22, 0.5);
    }
    .quick-action-tile.intent .tile-subtitle {
      color: rgba(251, 146, 60, 0.9);
    }
    .quick-action-tile.intent.has-critical::after {
      content: '';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-critical 1.5s ease-in-out infinite;
    }
    @keyframes pulse-critical {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }

    .quick-action-tile.settings {
      background: linear-gradient(165deg, rgba(20, 22, 28, 0.97) 0%, rgba(15, 17, 22, 0.99) 100%);
      border-color: rgba(148, 163, 184, 0.2);
    }
    .quick-action-tile.settings::before {
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.6), transparent);
    }
    .quick-action-tile.settings:hover {
      border-color: rgba(148, 163, 184, 0.45);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 40px rgba(148, 163, 184, 0.1);
    }
    .quick-action-tile.settings .tile-value {
      color: #94a3b8;
      text-shadow: 0 0 25px rgba(148, 163, 184, 0.4);
    }

    /* Email Banner Tile - Cyan/Blue Theme */
    .quick-action-tile.email-banner {
      background: linear-gradient(165deg, rgba(8, 18, 28, 0.97) 0%, rgba(5, 12, 20, 0.99) 100%);
      border-color: rgba(6, 182, 212, 0.2);
      min-height: auto;
    }
    .quick-action-tile.email-banner::before {
      background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.6), transparent);
    }
    .quick-action-tile.email-banner:hover {
      border-color: rgba(6, 182, 212, 0.4);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 30px rgba(6, 182, 212, 0.08);
      transform: translateY(-3px);
    }

    /* Email Monitor Stats Styling */
    .email-monitor-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .email-monitor-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(6, 182, 212, 0.08);
      border: 1px solid rgba(6, 182, 212, 0.15);
      border-radius: 10px;
      padding: 8px 14px;
    }
    .email-monitor-item .monitor-email {
      font-size: 13px;
      font-weight: 600;
      color: #06b6d4;
    }
    .email-monitor-item .monitor-stats {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: var(--muted2);
    }
    .email-monitor-item .monitor-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .email-monitor-item .monitor-stat-value {
      color: var(--text);
      font-weight: 600;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @media (max-width: 900px) {
      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 500px) {
      .quick-actions-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Command Center Grid */
    .command-center-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .command-stat {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.8) 0%, rgba(15, 19, 32, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }

    .command-stat:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    .command-stat.highlight {
      border-color: rgba(251, 191, 36, 0.3);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(17, 21, 37, 0.9) 100%);
    }

    .command-stat.success {
      border-color: rgba(34, 197, 94, 0.3);
    }

    .command-stat.warning {
      border-color: rgba(251, 191, 36, 0.3);
    }

    .command-stat.danger {
      border-color: rgba(239, 68, 68, 0.3);
    }

    .command-stat-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .command-stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #ffffff;
      line-height: 1.1;
    }

    .command-stat-value.gold { color: #fbbf24; }
    .command-stat-value.green { color: #22c55e; }
    .command-stat-value.red { color: #ef4444; }
    .command-stat-value.blue { color: #3b82f6; }

    .command-stat-sub {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    .command-stat-trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 8px;
    }

    .command-stat-trend.up {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .command-stat-trend.down {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    /* Location Performance Grid */
    .location-performance {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .location-card {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.2s;
    }

    .location-card:hover {
      border-color: var(--border-hover);
    }

    .location-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .location-name {
      font-size: 13px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .location-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .location-badge.hot {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .location-badge.warm {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .location-badge.good {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .location-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .location-stat {
      text-align: center;
    }

    .location-stat-value {
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
    }

    .location-stat-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
    }

    /* Opportunity Pipeline */
    .opportunity-pipeline {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .pipeline-stage {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }

    .pipeline-stage-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .pipeline-stage-icon {
      font-size: 18px;
    }

    .pipeline-stage-title {
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .pipeline-stage-count {
      font-size: 24px;
      font-weight: 800;
      color: #ffffff;
    }

    .pipeline-stage-value {
      font-size: 14px;
      font-weight: 600;
      color: #22c55e;
      margin-top: 4px;
    }

    /* Action Items */
    .action-items {
      margin-top: 16px;
    }

    .action-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border);
      border-left: 3px solid #fbbf24;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .action-item:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: var(--border-hover);
    }

    .action-item.urgent {
      border-left-color: #ef4444;
    }

    .action-item.high {
      border-left-color: #f59e0b;
    }

    .action-item.medium {
      border-left-color: #3b82f6;
    }

    .action-item-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(251, 191, 36, 0.1);
      border-radius: 8px;
      font-size: 18px;
    }

    .action-item-content {
      flex: 1;
    }

    .action-item-title {
      font-size: 13px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .action-item-meta {
      font-size: 12px;
      color: #64748b;
    }

    .action-item-value {
      font-size: 14px;
      font-weight: 700;
      color: #22c55e;
    }

    .action-item-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: none;
      border-radius: 6px;
      color: #0a0f1a;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-item-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    @media (max-width: 900px) {
      .command-center-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .opportunity-pipeline {
        grid-template-columns: repeat(2, 1fr);
      }
      .quick-actions-compact {
        justify-content: center;
      }
    }

    /* Actions Executed & Results Tracking */
    .actions-results-section {
      margin-top: 24px;
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.6) 0%, rgba(15, 19, 32, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .actions-results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, transparent 100%);
      border-bottom: 1px solid var(--border);
    }

    .actions-results-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .actions-results-title h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .actions-results-title .verified-badge {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .actions-results-summary {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .actions-summary-stat {
      text-align: center;
    }

    .actions-summary-value {
      font-size: 20px;
      font-weight: 800;
      color: #22c55e;
    }

    .actions-summary-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .actions-results-grid {
      display: grid;
      gap: 12px;
      padding: 16px 20px;
    }

    .action-result-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .action-result-card:hover {
      border-color: rgba(34, 197, 94, 0.3);
      background: rgba(15, 23, 42, 0.7);
    }

    .action-result-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 10px;
      font-size: 20px;
    }

    .action-result-details {
      flex: 1;
    }

    .action-result-name {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 4px;
    }

    .action-result-recommendation {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .action-result-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 11px;
      color: #64748b;
    }

    .action-result-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-result-impact {
      text-align: right;
      min-width: 120px;
    }

    .action-result-savings {
      font-size: 20px;
      font-weight: 800;
      color: #22c55e;
      line-height: 1.2;
    }

    .action-result-verified {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 4px;
    }

    .action-result-timeline {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .timeline-bar {
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .timeline-progress {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .timeline-label {
      font-size: 10px;
      color: #64748b;
      white-space: nowrap;
    }

    .actions-total-impact {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.05) 100%);
      border-top: 1px solid var(--border);
    }

    .total-impact-label {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
    }

    .total-impact-value {
      font-size: 28px;
      font-weight: 800;
      color: #22c55e;
    }

    .total-impact-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(34, 197, 94, 0.15);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .total-impact-badge span {
      font-size: 12px;
      font-weight: 600;
      color: #22c55e;
    }

    /* Intent Signals Modal Styles */
    .intent-signals-grid {
      display: grid;
      gap: 12px;
      max-height: 500px;
      overflow-y: auto;
      padding: 4px;
    }

    .intent-signal-card {
      display: flex;
      align-items: stretch;
      gap: 16px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s;
      position: relative;
    }

    .intent-signal-card:hover {
      border-color: rgba(249, 115, 22, 0.3);
      background: rgba(15, 23, 42, 0.7);
    }

    .intent-signal-card.priority-critical {
      border-left: 3px solid #ef4444;
    }
    .intent-signal-card.priority-high {
      border-left: 3px solid #f97316;
    }
    .intent-signal-card.priority-medium {
      border-left: 3px solid #eab308;
    }
    .intent-signal-card.priority-low {
      border-left: 3px solid #64748b;
    }

    .intent-signal-priority-bar {
      width: 4px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    .intent-signal-priority-bar.critical { background: #ef4444; }
    .intent-signal-priority-bar.high { background: #f97316; }
    .intent-signal-priority-bar.medium { background: #eab308; }
    .intent-signal-priority-bar.low { background: #64748b; }

    .intent-signal-content {
      flex: 1;
      min-width: 0;
    }

    .intent-signal-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .intent-signal-company {
      font-size: 15px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .intent-signal-industry {
      font-size: 10px;
      font-weight: 600;
      color: #94a3b8;
      background: rgba(100, 116, 139, 0.15);
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
    }

    .intent-signal-location {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
    }

    .intent-signal-keyword-box {
      background: rgba(249, 115, 22, 0.08);
      border: 1px solid rgba(249, 115, 22, 0.2);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .intent-signal-keyword-label {
      font-size: 10px;
      color: #f97316;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .intent-signal-search-context {
      font-size: 13px;
      color: #e2e8f0;
      font-style: italic;
    }

    .intent-signal-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      color: #64748b;
    }

    .intent-signal-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .intent-signal-score {
      text-align: right;
      min-width: 100px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .intent-signal-score-value {
      font-size: 28px;
      font-weight: 800;
      color: #f97316;
      line-height: 1;
    }

    .intent-signal-score-label {
      font-size: 10px;
      color: #64748b;
      text-transform: uppercase;
    }

    .freshness-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
    }
    .freshness-badge.hot {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      animation: pulse-hot 1.5s ease-in-out infinite;
    }
    .freshness-badge.warm {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
    }
    .freshness-badge.cooling {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }
    .freshness-badge.cold {
      background: rgba(100, 116, 139, 0.15);
      color: #64748b;
    }
    @keyframes pulse-hot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .intent-signal-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .intent-signal-btn {
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .intent-signal-btn:hover {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.1);
    }
    .intent-signal-btn.primary {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      border: none;
      color: white;
    }
    .intent-signal-btn.primary:hover {
      opacity: 0.9;
    }

    .intent-summary-stat {
      text-align: center;
      flex: 1;
    }
    .intent-summary-value {
      font-size: 32px;
      font-weight: 800;
    }
    .intent-summary-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .intent-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .intent-filter-btn {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .intent-filter-btn:hover {
      border-color: #f97316;
      color: #f97316;
    }
    .intent-filter-btn.active {
      background: rgba(249, 115, 22, 0.15);
      border-color: #f97316;
      color: #f97316;
      font-weight: 600;
    }

    .intent-contact-info {
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 10px;
    }
    .intent-contact-info .contact-name {
      font-size: 12px;
      font-weight: 600;
      color: #22c55e;
    }
    .intent-contact-info .contact-title {
      font-size: 11px;
      color: #64748b;
    }
    .intent-contact-info .contact-email {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .intent-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    .intent-empty-state h3 {
      font-size: 18px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .intent-empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="pageBody">
      <!-- Header Section -->
      <div class="header">
        <div class="headerTitle">Business Dashboard</div>
        <div class="headerSub">
          <span id="companyName">Revenue Radar</span>
          <span class="muted">•</span>
          <span class="muted">Analyzing invoice discrepancies and overbilling</span>
        </div>
        <div class="headerRight">
          <label style="color: var(--muted); font-size: 13px; font-weight: 600;">
            From:
            <input type="date" id="dateFrom" style="margin-left: 8px;">
          </label>
          <label style="color: var(--muted); font-size: 13px; font-weight: 600;">
            To:
            <input type="date" id="dateTo" style="margin-left: 8px;">
          </label>
          <button class="btn" onclick="loadDashboard()">Apply Filters</button>

          <!-- Compact Quick Actions -->
          <a href="upload-invoice.html" class="header-action-btn upload">
            <span>Upload Invoice</span>
          </a>
          <button class="header-action-btn actions" onclick="openActionItemsModal()">
            <span>Action Items</span>
            <span class="btn-badge" id="headerActionBadge">5</span>
          </button>
          <button class="header-action-btn" onclick="openManualPayrollModal()">
            <span>Payroll Entry</span>
          </button>
          <button class="header-action-btn" onclick="openManualExpenseModal()">
            <span>Expense Entry</span>
          </button>

          <!-- Demo Mode Toggle (Admin Only) -->
          <div id="demoToggleContainer" class="demo-toggle-container" style="display: none;">
            <div class="demo-toggle-wrapper">
              <span class="demo-toggle-label" id="demoModeLabel">Demo</span>
              <label class="demo-toggle">
                <input type="checkbox" id="demoModeToggle" onchange="toggleDemoMode()">
                <span class="demo-toggle-slider"></span>
              </label>
              <span class="demo-toggle-label" id="realDataLabel">Real</span>
            </div>
            <div class="demo-mode-indicator" id="demoModeIndicator">
              <span class="indicator-dot"></span>
              <span id="modeText">Demo Mode</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Trial Status Banner -->
      <div id="trialBanner" class="trial-banner">
        <span id="trialStatusText" class="trial-banner-text"></span>
      </div>

      <!-- Premium Quick Actions Tiles - Row 1: Core Operations -->
      <div class="quick-actions-grid" style="grid-template-columns: repeat(4, 1fr);">
        <a href="inventory.html" class="quick-action-tile">
          <span class="tile-label">Inventory</span>
          <span class="tile-value" id="tileInventoryCount">247 Items</span>
        </a>
        <a href="business-analytics.html" class="quick-action-tile analytics">
          <span class="tile-label">Analytics</span>
          <span class="tile-value" id="tileSavingsFound">$8,247 Found</span>
          <span class="tile-subtitle">+ Location Performance</span>
        </a>
        <div class="quick-action-tile intent" id="intentSignalsTile" onclick="openIntentSignalsModal()">
          <span class="tile-label">Intent Signals</span>
          <span class="tile-value" id="tileIntentCount">0 New</span>
          <span class="tile-subtitle" id="tileIntentCritical">Loading...</span>
        </div>
        <div class="quick-action-tile results" onclick="openActionsExecutedModal()">
          <span class="tile-label">Smart Actions Executed</span>
          <span class="tile-value" style="color: #22c55e;" id="tileActionsExecuted">$6,287 Saved</span>
          <span class="tile-subtitle" id="tileActionsCount">12 actions - 92% success</span>
        </div>
      </div>

      <!-- Row 2: Upload Payroll, Events, Catering & Overbilling -->
      <div class="quick-actions-grid" style="margin-top: -4px; grid-template-columns: repeat(4, 1fr);">
        <a href="upload-payroll.html" class="quick-action-tile payroll">
          <span class="tile-label">Upload Payroll</span>
          <span class="tile-value" id="tilePayrollStatus">Import POS Data</span>
          <span class="tile-subtitle">Toast, Square, Clover & more</span>
        </a>
        <a href="private-events.html" class="quick-action-tile events">
          <span class="tile-label">Private Events</span>
          <span class="tile-value" id="tileEventsCount">3 Upcoming</span>
          <span class="tile-subtitle" id="tileEventsNext">Next: Sat, Jan 25</span>
        </a>
        <a href="catering.html" class="quick-action-tile catering">
          <span class="tile-label">Catering</span>
          <span class="tile-value" id="tileCateringCount">5 Orders</span>
          <span class="tile-subtitle" id="tileCateringRevenue">$12,450 this month</span>
        </a>
        <div class="quick-action-tile pipeline" onclick="scrollToFlaggedIssues()">
          <span class="tile-label">Overbilling</span>
          <span class="tile-value" id="tilePipelineTotal">$8,247</span>
          <span class="tile-subtitle" id="tilePipelineCount">18 issues flagged</span>
        </div>
      </div>

      <!-- Row 3: Connect Email Banner with Stats -->
      <div class="quick-actions-grid" style="margin-top: -4px; grid-template-columns: 1fr;">
        <div class="quick-action-tile email-banner" style="flex-direction: row; justify-content: flex-start; gap: 20px; padding: 20px 28px; cursor: default;">
          <div style="text-align: left; flex: 1;">
            <span class="tile-label" style="font-size: 14px;">Connect Email for Invoice Autopilot</span>
            <div id="emailMonitorStats" style="margin-top: 10px;">
              <!-- Default empty state - will be populated by JS -->
              <div class="email-monitor-empty" style="color: var(--muted2); font-size: 13px;">
                No email monitors configured yet
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; margin-left: auto; position: relative; z-index: 10;">
            <span style="color: var(--muted); font-size: 12px;">Set up automatic invoice scanning</span>
            <button class="btn" onclick="openSetupGuide()" style="background: var(--panel2); font-size: 12px; padding: 8px 14px; position: relative; z-index: 10; cursor: pointer;">How It Works</button>
            <button class="btn" onclick="openAddEmailMonitor()" style="font-size: 12px; padding: 8px 14px; position: relative; z-index: 10; cursor: pointer;">Configure</button>
          </div>
        </div>
      </div>

      <!-- Financial Overview Section -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">📈 Financial Overview</div>
          <div style="display: flex; gap: 8px;">
            <select id="chartPeriod" onchange="loadFinancialCharts()" style="background: var(--panel2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 6px; font-size: 13px;">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
          </div>
        </div>
        <div class="divider"></div>

        <div style="padding: 20px;">
          <!-- Achievement Banner (Gamification) -->
          <div class="achievement-banner">
            <div class="achievement-content">
              <div class="achievement-icon">🏆</div>
              <div class="achievement-text">
                <h3>Savings Champion!</h3>
                <p>You've saved more than 85% of businesses this month</p>
              </div>
            </div>
            <div class="streak-counter">
              <div>
                <span class="streak-flame">🔥</span>
              </div>
              <div>
                <div class="streak-number" id="streakCount">7</div>
                <div class="streak-label">Week Streak</div>
              </div>
            </div>
          </div>

          <!-- Command Center Grid - Overbilling Metrics -->
          <div class="command-center-grid" style="margin-top: 20px;">
            <div class="command-stat highlight">
              <div class="command-stat-label">Total Potential Overbilling</div>
              <div class="command-stat-value gold" id="ccTotalOverbilling">$8,247</div>
              <div class="command-stat-sub">Across all invoices</div>
              <div class="command-stat-trend up">↑ $1,200 this week</div>
            </div>
            <div class="command-stat">
              <div class="command-stat-label">Invoices Analyzed</div>
              <div class="command-stat-value blue" id="ccInvoicesAnalyzed">247</div>
              <div class="command-stat-sub">Last 30 days</div>
              <div class="command-stat-trend up">↑ 23 new</div>
            </div>
            <div class="command-stat warning">
              <div class="command-stat-label">Flagged Issues</div>
              <div class="command-stat-value red" id="ccFlaggedIssues">18</div>
              <div class="command-stat-sub">Requiring attention</div>
              <div class="command-stat-trend down">↓ 4 resolved</div>
            </div>
            <div class="command-stat success">
              <div class="command-stat-label">Avg Projected Impact</div>
              <div class="command-stat-value green" id="ccAvgImpact">$458</div>
              <div class="command-stat-sub">Per flagged invoice</div>
              <div class="command-stat-trend up">↑ 12% vs last month</div>
            </div>
          </div>

          <!-- Score Section with Savings & KPIs -->
          <div class="analytics-score-section">
            <div class="total-score-card">
              <div class="score-label">Total Savings This Year</div>
              <div class="total-savings" id="totalSavings">$12,847</div>
              <div class="savings-period">Jan 2026 - Present</div>

              <div class="level-progress">
                <div class="level-label">
                  <span>Level 4: Cost Crusher</span>
                  <span>Level 5: 65%</span>
                </div>
                <div class="level-bar">
                  <div class="level-fill" style="width: 65%;"></div>
                </div>
                <div class="next-level">Save $2,153 more to reach Level 5: Budget Boss</div>
              </div>
            </div>

            <div class="comparison-grid">
              <div class="comparison-card improved">
                <div class="comparison-header">
                  <span class="comparison-title">This Week Payroll</span>
                  <span class="comparison-badge down">-8.2%</span>
                </div>
                <div class="comparison-value" id="weekPayroll">$4,250</div>
                <div class="comparison-vs">
                  vs last week
                  <span class="vs-arrow down">↓ $380 less</span>
                </div>
              </div>

              <div class="comparison-card warning">
                <div class="comparison-header">
                  <span class="comparison-title">This Week Expenses</span>
                  <span class="comparison-badge up">+12.5%</span>
                </div>
                <div class="comparison-value" id="weekExpenses">$6,890</div>
                <div class="comparison-vs">
                  vs last week
                  <span class="vs-arrow up">↑ $765 more</span>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Summary Stats (Original) -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px; background: var(--panel2); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Expenses</div>
            <div style="font-size: 24px; font-weight: 700; color: #ef4444;" id="chartTotalExpenses">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Payroll</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--gold);" id="chartTotalPayroll">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Inventory Spend</div>
            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="chartTotalInventory">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Savings Found</div>
            <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="chartTotalSavings">$0</div>
          </div>
        </div>

        <!-- Charts Grid (Original + Enhanced) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
          <!-- Spending Trend Chart -->
          <div>
            <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Spending Trend</h4>
            <div style="position: relative; height: 200px; width: 100%;">
              <canvas id="spendingTrendChart"></canvas>
            </div>
          </div>
          <!-- Expense Breakdown Chart -->
          <div>
            <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Expense Breakdown</h4>
            <div style="position: relative; height: 160px; width: 100%;">
              <canvas id="expenseBreakdownChart"></canvas>
            </div>
            <div class="breakdown-list" style="margin-top: 12px;">
              <div class="breakdown-item">
                <div class="breakdown-color" style="background: #fbbf24;"></div>
                <span class="breakdown-label">COGS</span>
                <span class="breakdown-value" id="cogsCost">$3,450</span>
                <span class="breakdown-pct" id="cogsPct">50.1%</span>
              </div>
              <div class="breakdown-item">
                <div class="breakdown-color" style="background: #3b82f6;"></div>
                <span class="breakdown-label">Utilities</span>
                <span class="breakdown-value" id="utilitiesCost">$890</span>
                <span class="breakdown-pct" id="utilitiesPct">12.9%</span>
              </div>
              <div class="breakdown-item">
                <div class="breakdown-color" style="background: #22c55e;"></div>
                <span class="breakdown-label">Rent</span>
                <span class="breakdown-value" id="rentCost">$1,500</span>
                <span class="breakdown-pct" id="rentPct">21.8%</span>
              </div>
              <div class="breakdown-item">
                <div class="breakdown-color" style="background: #8b5cf6;"></div>
                <span class="breakdown-label">Other</span>
                <span class="breakdown-value" id="otherCost">$1,050</span>
                <span class="breakdown-pct" id="otherPct">15.2%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Budget vs Actual -->
        <div style="padding: 0 20px 20px;">
          <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Budget vs Actual</h4>
          <div id="budgetComparison" style="display: grid; gap: 12px;">
            <!-- Dynamically populated -->
          </div>
        </div>

        <!-- Location Performance Breakdown -->
        <div style="padding: 0 20px 20px; border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
          <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px; display: flex; align-items: center; gap: 8px;">
            📍 Location Performance
            <span style="font-size: 11px; font-weight: 500; color: #64748b; background: var(--panel2); padding: 2px 8px; border-radius: 10px;">By Savings</span>
          </h4>
          <div class="location-performance" id="locationPerformance">
            <div class="location-card">
              <div class="location-header">
                <span class="location-name">Downtown Location</span>
                <span class="location-badge hot">🔥 Top Saver</span>
              </div>
              <div class="location-stats">
                <div class="location-stat">
                  <div class="location-stat-value" style="color: #22c55e;">$4,280</div>
                  <div class="location-stat-label">Saved</div>
                </div>
                <div class="location-stat">
                  <div class="location-stat-value">12</div>
                  <div class="location-stat-label">Issues Found</div>
                </div>
              </div>
            </div>
            <div class="location-card">
              <div class="location-header">
                <span class="location-name">Westside Branch</span>
                <span class="location-badge warm">⚠️ Needs Review</span>
              </div>
              <div class="location-stats">
                <div class="location-stat">
                  <div class="location-stat-value" style="color: #22c55e;">$2,450</div>
                  <div class="location-stat-label">Saved</div>
                </div>
                <div class="location-stat">
                  <div class="location-stat-value">8</div>
                  <div class="location-stat-label">Issues Found</div>
                </div>
              </div>
            </div>
            <div class="location-card">
              <div class="location-header">
                <span class="location-name">Airport Store</span>
                <span class="location-badge good">✓ On Track</span>
              </div>
              <div class="location-stats">
                <div class="location-stat">
                  <div class="location-stat-value" style="color: #22c55e;">$1,517</div>
                  <div class="location-stat-label">Saved</div>
                </div>
                <div class="location-stat">
                  <div class="location-stat-value">5</div>
                  <div class="location-stat-label">Issues Found</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Opportunity Pipeline -->
        <div style="padding: 0 20px 20px; border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
          <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px; display: flex; align-items: center; gap: 8px;">
            🎯 Opportunity Pipeline
            <span style="font-size: 11px; font-weight: 500; color: #64748b; background: var(--panel2); padding: 2px 8px; border-radius: 10px;">Savings Potential</span>
          </h4>
          <div class="opportunity-pipeline" id="opportunityPipeline">
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <span class="pipeline-stage-icon">🔍</span>
                <span class="pipeline-stage-title">Detected</span>
              </div>
              <div class="pipeline-stage-count" id="pipelineDetected">24</div>
              <div class="pipeline-stage-value">$12,400</div>
            </div>
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <span class="pipeline-stage-icon">📋</span>
                <span class="pipeline-stage-title">Reviewing</span>
              </div>
              <div class="pipeline-stage-count" id="pipelineReviewing">12</div>
              <div class="pipeline-stage-value">$6,800</div>
            </div>
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <span class="pipeline-stage-icon">⚡</span>
                <span class="pipeline-stage-title">In Progress</span>
              </div>
              <div class="pipeline-stage-count" id="pipelineInProgress">8</div>
              <div class="pipeline-stage-value">$4,200</div>
            </div>
            <div class="pipeline-stage">
              <div class="pipeline-stage-header">
                <span class="pipeline-stage-icon">✅</span>
                <span class="pipeline-stage-title">Recovered</span>
              </div>
              <div class="pipeline-stage-count" id="pipelineRecovered">47</div>
              <div class="pipeline-stage-value" style="color: #22c55e;">$8,247</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Vendor and Location Breakdown -->
      <div class="grid2">
        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">Potential overbilling by vendor</div>
          </div>
          <div class="divider"></div>
          <div class="breakdownList" id="vendorBreakdown">
            <div class="loadingState">Loading vendors...</div>
          </div>
        </div>

        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">Potential overbilling by location</div>
          </div>
          <div class="divider"></div>
          <div class="breakdownList" id="locationBreakdown">
            <div class="loadingState">Loading locations...</div>
          </div>
        </div>
      </div>

      <!-- Flagged Issues Table -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">Flagged issues</div>
          <div class="muted">High-confidence prioritized</div>
        </div>
        <div class="divider"></div>
        <div class="tableWrap" id="issuesTable">
          <div class="loadingState">Loading issues...</div>
        </div>
      </div>

      <!-- Inventory Intelligence Section -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">📦 Inventory Intelligence</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn" onclick="window.location.href='inventory.html'" style="background: var(--panel2); font-size: 13px;">Full Inventory</button>
            <button class="btn" onclick="runInventoryAnalysis()">Run Analysis</button>
          </div>
        </div>
        <div class="divider"></div>

        <!-- Inventory Stats Row -->
        <div id="inventoryStatsRow" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px; background: var(--panel2); border-bottom: 1px solid var(--border);">
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="invTotalItems">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Total Items</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--gold);" id="invTotalValue">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Inventory Value</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #ef4444;" id="invLowStock">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Low Stock Items</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="invHealthScore">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Health Score</div>
          </div>
        </div>

        <!-- Recommendations Cards -->
        <div style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <h4 style="margin: 0; color: var(--text); font-size: 15px;">🎯 Smart Recommendations</h4>
            <div style="display: flex; gap: 8px;">
              <span class="badge" id="invCriticalBadge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">0 Critical</span>
              <span class="badge" id="invSavingsBadge" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">$0 Savings</span>
            </div>
          </div>
          <div id="inventoryRecommendations" style="display: grid; gap: 12px;">
            <div style="text-align: center; padding: 32px; color: var(--muted2);">
              <div style="font-size: 40px; margin-bottom: 12px;">📊</div>
              <p style="margin: 0 0 16px 0;">Loading inventory recommendations...</p>
            </div>
          </div>
        </div>

        <!-- Stockout Alerts -->
        <div style="padding: 0 20px 20px;">
          <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 15px;">⚠️ Stockout Alerts</h4>
          <div id="stockoutAlerts" style="display: grid; gap: 8px;">
            <div style="text-align: center; padding: 24px; color: var(--muted2);">
              <p style="margin: 0;">No stockout alerts at this time.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Email Monitor Modal -->
  <div class="modal-overlay" id="addEmailMonitorModal" onclick="closeAddEmailMonitor(event)">
    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">📧</span>
          <span>Add Email Monitor</span>
          <span style="font-size: 11px; background: rgba(6, 182, 212, 0.15); color: #06b6d4; padding: 4px 10px; border-radius: 20px; font-weight: 600;">Invoice Autopilot</span>
        </div>
        <button class="modal-close" onclick="closeAddEmailMonitor()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Quick Setup Info -->
        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.08) 0%, rgba(6, 182, 212, 0.02) 100%); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 10px; padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
          <div style="width: 44px; height: 44px; background: rgba(6, 182, 212, 0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">🔒</div>
          <div>
            <div style="font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 2px;">Secure Connection</div>
            <div style="font-size: 12px; color: var(--muted);">Your credentials are encrypted and we only read invoice emails. <a href="#" onclick="openSetupGuide(); return false;" style="color: #06b6d4;">Need help? View setup guide</a></div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left Column -->
          <div style="display: flex; flex-direction: column; gap: 18px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px;">Monitor Name <span style="color: var(--muted);">*</span></label>
              <input type="text" id="newMonitorName" placeholder="e.g., Main Invoice Inbox" required style="width: 100%; padding: 12px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; transition: border-color 0.2s;">
              <div style="font-size: 11px; color: var(--muted2); margin-top: 6px;">A friendly name to identify this inbox</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px;">Email Address <span style="color: var(--muted);">*</span></label>
              <input type="email" id="newMonitorEmail" placeholder="invoices@yourcompany.com" required onblur="detectIMAPSettings()" style="width: 100%; padding: 12px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; transition: border-color 0.2s;">
              <div style="font-size: 11px; color: var(--muted2); margin-top: 6px;">The email account to monitor for invoices</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px;">Password / App Password <span style="color: var(--muted);">*</span></label>
              <input type="password" id="newMonitorPassword" placeholder="Enter app password" required style="width: 100%; padding: 12px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; transition: border-color 0.2s;">
              <div style="font-size: 11px; color: #f59e0b; margin-top: 6px; display: flex; align-items: center; gap: 4px;">
                <span>⚠️</span> Gmail/Yahoo/Outlook require an App Password
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div style="display: flex; flex-direction: column; gap: 18px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px;">IMAP Server <span style="color: var(--muted);">*</span></label>
              <input type="text" id="newMonitorImapHost" placeholder="imap.gmail.com" required style="width: 100%; padding: 12px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; transition: border-color 0.2s;">
              <div style="font-size: 11px; color: var(--muted2); margin-top: 6px;">Auto-detected for common providers</div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px;">IMAP Port</label>
              <input type="number" id="newMonitorImapPort" placeholder="993" value="993" style="width: 100%; padding: 12px 14px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; transition: border-color 0.2s;">
              <div style="font-size: 11px; color: var(--muted2); margin-top: 6px;">Usually 993 for SSL connections</div>
            </div>

            <div style="margin-top: auto;">
              <button onclick="testIMAPConnection()" type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; padding: 12px; font-size: 13px; font-weight: 600;">
                🔌 Test Connection
              </button>
              <div id="testConnectionResult" style="margin-top: 10px; display: none; padding: 10px; border-radius: 8px; font-size: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; margin-top: 28px; padding-top: 20px; border-top: 1px solid var(--border);">
          <button onclick="createEmailMonitor()" class="btn" style="flex: 1; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border: none; padding: 14px; font-size: 14px; font-weight: 600;">
            Create Email Monitor
          </button>
          <button onclick="closeAddEmailMonitor()" class="btn" style="padding: 14px 28px; background: var(--panel2); font-size: 14px;">Cancel</button>
        </div>

        <div id="newMonitorStatus" style="margin-top: 16px; display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Setup Guide Modal -->
  <div class="modal-overlay" id="setupGuideModal" onclick="closeSetupGuide(event)">
    <div class="modal-content" style="max-width: 950px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">📧</span>
          <span>Email Autopilot Setup Guide</span>
        </div>
        <button class="modal-close" onclick="closeSetupGuide()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Two Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Left Column: How It Works + Tips -->
          <div>
            <!-- How It Works -->
            <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(251, 191, 36, 0.02) 100%); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 16px 0; color: var(--gold); font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <span>⚡</span> How It Works
              </h3>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                  <div style="width: 24px; height: 24px; background: rgba(251, 191, 36, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--gold); flex-shrink: 0;">1</div>
                  <div style="font-size: 13px; color: var(--text);">Connect your invoice email inbox</div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                  <div style="width: 24px; height: 24px; background: rgba(251, 191, 36, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--gold); flex-shrink: 0;">2</div>
                  <div style="font-size: 13px; color: var(--text);">We automatically scan for new invoices</div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                  <div style="width: 24px; height: 24px; background: rgba(251, 191, 36, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--gold); flex-shrink: 0;">3</div>
                  <div style="font-size: 13px; color: var(--text);">AI extracts data from PDFs & emails</div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                  <div style="width: 24px; height: 24px; background: rgba(251, 191, 36, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--gold); flex-shrink: 0;">4</div>
                  <div style="font-size: 13px; color: var(--text);">Get alerts on price increases & overbilling</div>
                </div>
              </div>
            </div>

            <!-- Pro Tips -->
            <div style="background: var(--panel2); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
              <h3 style="margin: 0 0 14px 0; color: var(--text); font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <span>💡</span> Pro Tips
              </h3>
              <div style="display: flex; flex-direction: column; gap: 10px; font-size: 12px; color: var(--muted);">
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                  <span style="color: #22c55e;">✓</span>
                  <span><strong style="color: var(--text);">Dedicated email:</strong> Create invoices@company.com for vendors</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                  <span style="color: #22c55e;">✓</span>
                  <span><strong style="color: var(--text);">Multi-location:</strong> One monitor per location works best</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                  <span style="color: #22c55e;">✓</span>
                  <span><strong style="color: var(--text);">Forwarding:</strong> Set up rules to consolidate invoices</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                  <span style="color: #22c55e;">✓</span>
                  <span><strong style="color: var(--text);">Frequency:</strong> Scanned every 15 minutes automatically</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Provider Instructions -->
          <div>
            <h3 style="margin: 0 0 14px 0; color: var(--text); font-size: 14px; font-weight: 700;">Setup by Email Provider</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <!-- Gmail -->
              <details style="background: var(--panel2); border-radius: 10px; border: 1px solid var(--border);">
                <summary style="padding: 14px 16px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">📬</span> Gmail / Google Workspace
                </summary>
                <div style="padding: 0 16px 16px; color: var(--muted); font-size: 12px; line-height: 1.7;">
                  <ol style="margin: 0; padding-left: 18px;">
                    <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: #06b6d4;">App Passwords</a></li>
                    <li>Enable 2-Step Verification if needed</li>
                    <li>Generate a new app password for "Mail"</li>
                    <li>Use the 16-character password below</li>
                  </ol>
                  <div style="margin-top: 10px; padding: 10px 12px; background: rgba(6, 182, 212, 0.08); border-radius: 6px; font-family: monospace; font-size: 11px;">
                    <strong style="color: #06b6d4;">Server:</strong> imap.gmail.com <strong style="color: #06b6d4; margin-left: 12px;">Port:</strong> 993
                  </div>
                </div>
              </details>

              <!-- Outlook -->
              <details style="background: var(--panel2); border-radius: 10px; border: 1px solid var(--border);">
                <summary style="padding: 14px 16px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">📧</span> Outlook / Office 365
                </summary>
                <div style="padding: 0 16px 16px; color: var(--muted); font-size: 12px; line-height: 1.7;">
                  <ol style="margin: 0; padding-left: 18px;">
                    <li>Go to <a href="https://account.microsoft.com/security" target="_blank" style="color: #06b6d4;">Microsoft Security</a></li>
                    <li>Enable Two-step verification</li>
                    <li>Create a new app password</li>
                  </ol>
                  <div style="margin-top: 10px; padding: 10px 12px; background: rgba(6, 182, 212, 0.08); border-radius: 6px; font-family: monospace; font-size: 11px;">
                    <strong style="color: #06b6d4;">Server:</strong> outlook.office365.com <strong style="color: #06b6d4; margin-left: 12px;">Port:</strong> 993
                  </div>
                </div>
              </details>

              <!-- Yahoo -->
              <details style="background: var(--panel2); border-radius: 10px; border: 1px solid var(--border);">
                <summary style="padding: 14px 16px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">📨</span> Yahoo Mail
                </summary>
                <div style="padding: 0 16px 16px; color: var(--muted); font-size: 12px; line-height: 1.7;">
                  <ol style="margin: 0; padding-left: 18px;">
                    <li>Go to <a href="https://login.yahoo.com/account/security" target="_blank" style="color: #06b6d4;">Yahoo Security</a></li>
                    <li>Generate app password for "Other App"</li>
                    <li>Name it "Revenue Radar"</li>
                  </ol>
                  <div style="margin-top: 10px; padding: 10px 12px; background: rgba(6, 182, 212, 0.08); border-radius: 6px; font-family: monospace; font-size: 11px;">
                    <strong style="color: #06b6d4;">Server:</strong> imap.mail.yahoo.com <strong style="color: #06b6d4; margin-left: 12px;">Port:</strong> 993
                  </div>
                </div>
              </details>

              <!-- GoDaddy -->
              <details style="background: var(--panel2); border-radius: 10px; border: 1px solid var(--border);">
                <summary style="padding: 14px 16px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">🌐</span> GoDaddy Workspace
                </summary>
                <div style="padding: 0 16px 16px; color: var(--muted); font-size: 12px; line-height: 1.7;">
                  <p style="margin: 0 0 10px 0;">Use your regular email password - no app password needed.</p>
                  <div style="padding: 10px 12px; background: rgba(6, 182, 212, 0.08); border-radius: 6px; font-family: monospace; font-size: 11px;">
                    <strong style="color: #06b6d4;">Server:</strong> imap.secureserver.net <strong style="color: #06b6d4; margin-left: 12px;">Port:</strong> 993
                  </div>
                </div>
              </details>

              <!-- Other -->
              <details style="background: var(--panel2); border-radius: 10px; border: 1px solid var(--border);">
                <summary style="padding: 14px 16px; cursor: pointer; font-weight: 600; color: var(--text); font-size: 13px; display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 16px;">⚙️</span> Other Providers
                </summary>
                <div style="padding: 0 16px 16px; color: var(--muted); font-size: 12px; line-height: 1.7;">
                  <p style="margin: 0;">Check your email provider's documentation for IMAP settings. Typically:</p>
                  <ul style="margin: 8px 0 0 0; padding-left: 18px;">
                    <li>Server: imap.yourdomain.com</li>
                    <li>Port: 993 (SSL) or 143 (non-SSL)</li>
                  </ul>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- CTA Button -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center;">
          <button onclick="closeSetupGuide(); openAddEmailMonitor();" class="btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border: none; padding: 14px 32px; font-size: 14px; font-weight: 600;">
            Ready to Connect Email →
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Monitor Activity Modal -->
  <div id="monitorActivityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 800px; width: 90%; margin: 40px auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;" id="monitorActivityTitle">Monitor Activity</h2>
        <button onclick="closeMonitorActivity()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>
      <div id="monitorActivityContent" style="max-height: 500px; overflow-y: auto;">
        <div style="text-align: center; padding: 40px; color: var(--muted2);">Loading activity...</div>
      </div>
    </div>
  </div>

  <!-- Payroll Upload Modal -->
  <div id="payrollUploadModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; margin: 40px auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">📤 Upload Payroll File</h2>
        <button onclick="closePayrollUpload()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>

      <!-- Supported Formats Info -->
      <div style="background: var(--gold-glow); border: 1px solid var(--border-gold); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 8px 0; color: var(--gold); font-size: 14px;">Supported Formats</h4>
        <p style="margin: 0; color: var(--muted); font-size: 13px; line-height: 1.6;">
          Upload payroll exports from <strong style="color: var(--text);">ADP, Toast, Gusto, QuickBooks, Paychex, Square</strong> and more.
          We accept <strong style="color: var(--text);">.xlsx, .xls, .csv, and .pdf</strong> files.
        </p>
      </div>

      <!-- Upload Zone -->
      <div id="payrollDropZone" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px;"
           ondragover="handlePayrollDragOver(event)" ondragleave="handlePayrollDragLeave(event)" ondrop="handlePayrollDrop(event)" onclick="document.getElementById('payrollFileInput').click()">
        <div style="font-size: 48px; margin-bottom: 12px;">📁</div>
        <div style="color: var(--text); font-weight: 600; margin-bottom: 8px;">Drop your payroll file here</div>
        <div style="color: var(--muted2); font-size: 13px;">or click to browse</div>
        <input type="file" id="payrollFileInput" accept=".xlsx,.xls,.csv,.pdf" style="display: none;" onchange="handlePayrollFileSelect(event)">
      </div>

      <!-- Selected File Info -->
      <div id="payrollFileInfo" style="display: none; background: var(--panel2); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="color: var(--text); font-weight: 600;" id="payrollFileName">-</div>
            <div style="color: var(--muted2); font-size: 12px;" id="payrollFileSize">-</div>
          </div>
          <button onclick="clearPayrollFile()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px;">Remove</button>
        </div>
      </div>

      <!-- Payroll Provider Selection -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Payroll Provider (Optional)</label>
        <select id="payrollProvider" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          <option value="">Auto-detect</option>
          <option value="adp">ADP</option>
          <option value="toast">Toast</option>
          <option value="gusto">Gusto</option>
          <option value="quickbooks">QuickBooks</option>
          <option value="paychex">Paychex</option>
          <option value="square">Square Payroll</option>
          <option value="other">Other</option>
        </select>
        <small style="display: block; color: var(--muted2); margin-top: 4px;">Helps us parse your file more accurately</small>
      </div>

      <!-- Pay Period (Optional) -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period Start (Optional)</label>
          <input type="date" id="payrollUploadStart" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
        </div>
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period End (Optional)</label>
          <input type="date" id="payrollUploadEnd" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
        </div>
      </div>

      <!-- Upload Button -->
      <div style="display: flex; gap: 12px;">
        <button onclick="uploadPayrollFile()" id="payrollUploadBtn" class="btn" style="flex: 1;" disabled>
          Upload & Process
        </button>
        <button onclick="closePayrollUpload()" class="btn" style="flex: 1; background: var(--panel2);">Cancel</button>
      </div>

      <!-- Upload Status -->
      <div id="payrollUploadStatus" style="margin-top: 16px; display: none;"></div>
    </div>
  </div>

  <!-- Chart.js for Financial Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Authentication Manager - Load FIRST -->
  <script src="/dashboard/auth-manager.js"></script>
  <!-- Shared Navigation - Load SECOND -->
  <script src="/dashboard/shared-nav.js"></script>

  <script>
    // =====================================================
    // VP DASHBOARD - JAVASCRIPT
    // =====================================================

    // Use relative URLs since frontend and backend are on same server
    const API_BASE = window.location.origin;

    // Default filters
    let filters = {
      companyId: 'demo', // Default company
      dateFrom: getDateDaysAgo(30),
      dateTo: getTodayDate(),
      impactPeriod: 'monthly',
      mode: 'demo' // Use demo data by default (change to 'runs' when you have real invoice data)
    };

    // =====================================================
    // DEMO MODE TOGGLE FUNCTIONALITY (Admin Only)
    // =====================================================

    // Get current user info from localStorage
    const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
    const isAdmin = currentUser.role === 'admin';

    // Initialize demo mode state from localStorage (default: demo mode ON)
    let demoModeEnabled = localStorage.getItem('demoModeEnabled') !== 'false';

    // Show toggle only for admin users
    if (isAdmin) {
      const toggleContainer = document.getElementById('demoToggleContainer');
      if (toggleContainer) {
        toggleContainer.style.display = 'flex';
      }
      // Initialize toggle state
      const toggle = document.getElementById('demoModeToggle');
      if (toggle) {
        toggle.checked = !demoModeEnabled; // Checked = Real Data
      }
      updateDemoModeUI();
      // Set initial filter mode based on demo state
      filters.mode = demoModeEnabled ? 'demo' : 'runs';
    }

    function toggleDemoMode() {
      const toggle = document.getElementById('demoModeToggle');
      demoModeEnabled = !toggle.checked; // Unchecked = Demo, Checked = Real
      localStorage.setItem('demoModeEnabled', demoModeEnabled);
      updateDemoModeUI();
      // Update filters mode
      filters.mode = demoModeEnabled ? 'demo' : 'runs';
      // Reload dashboard with new mode
      loadDashboard();
      showToast(demoModeEnabled ? 'Switched to Demo Data' : 'Switched to Real Data', 'info');
    }

    function updateDemoModeUI() {
      const indicator = document.getElementById('demoModeIndicator');
      const modeText = document.getElementById('modeText');
      const demoLabel = document.getElementById('demoModeLabel');
      const realLabel = document.getElementById('realDataLabel');

      if (!indicator) return;

      if (demoModeEnabled) {
        indicator.className = 'demo-mode-indicator demo';
        modeText.textContent = 'Demo Mode';
        demoLabel.classList.add('active');
        realLabel.classList.remove('active');
      } else {
        indicator.className = 'demo-mode-indicator real';
        modeText.textContent = 'Live Data';
        demoLabel.classList.remove('active');
        realLabel.classList.add('active');
      }
    }

    // =====================================================

    // Helper: Get date N days ago
    function getDateDaysAgo(days) {
      const date = new Date();
      date.setDate(date.getDate() - days);
      return date.toISOString().split('T')[0];
    }

    // Helper: Get today's date
    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    // Helper: Format money
    function formatMoney(cents) {
      return '$' + (cents / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Helper: Format date
    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Helper: Format issue type
    function formatIssueType(type) {
      const types = {
        'PRICE_INCREASE': 'Price Increase',
        'QUANTITY_DRIFT': 'Quantity Drift',
        'NEW_FEE': 'New Fee',
        'DUPLICATE_CHARGE': 'Duplicate Charge',
        'ROUNDING_TAX_ANOMALY': 'Tax Anomaly'
      };
      return types[type] || type;
    }

    // Helper: Build query string
    function buildQueryString(filters) {
      const params = new URLSearchParams();
      params.set('companyId', filters.companyId);
      params.set('dateFrom', filters.dateFrom);
      params.set('dateTo', filters.dateTo);
      if (filters.vendorId) params.set('vendorId', filters.vendorId);
      if (filters.locationId) params.set('locationId', filters.locationId);
      if (filters.minConfidence) params.set('minConfidence', filters.minConfidence);
      if (filters.impactPeriod) params.set('impactPeriod', filters.impactPeriod);
      if (filters.mode) params.set('mode', filters.mode);
      return params.toString();
    }

    // Simple toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.9)' : type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
        color: white;
        border-radius: 12px;
        font-weight: 500;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: toastSlideIn 0.3s ease-out;
      `;
      toast.textContent = message;

      // Add animation style if not exists
      if (!document.getElementById('toast-style')) {
        const style = document.createElement('style');
        style.id = 'toast-style';
        style.textContent = `
          @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Fetch JSON from API
    async function fetchAPI(endpoint) {
      try {
        const token = localStorage.getItem('accessToken');
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        const res = await fetch(`${API_BASE}${endpoint}`, { headers });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Load metrics
    async function loadMetrics() {
      try {
        const data = await fetchAPI(`/api/dashboard/metrics?${buildQueryString(filters)}`);
        const metrics = data.metrics;

        document.getElementById('metricsRow').innerHTML = `
          <div class="metricTile">
            <div class="metricLabel">Total potential overbilling</div>
            <div class="metricValue">${formatMoney(metrics.totalPotentialOverbillingCents)}</div>
            <div class="metricSub">Across ${metrics.vendorsImpactedCount} vendors</div>
          </div>
          <div class="metricTile clickable" onclick="showLocationBreakdown()" title="Click to see breakdown by location">
            <div class="metricLabel">Invoices analyzed</div>
            <div class="metricValue">${metrics.invoicesAnalyzedCount.toLocaleString()}</div>
            <div class="metricSub">Across ${metrics.locationsCount} locations</div>
          </div>
          <div class="metricTile clickable" onclick="document.getElementById('issuesTable').scrollIntoView({behavior: 'smooth'})" title="Click to view flagged issues">
            <div class="metricLabel">Flagged issues</div>
            <div class="metricValue">${metrics.flaggedIssuesCount.toLocaleString()}</div>
            <div class="metricSub">High-confidence prioritized</div>
          </div>
          <div class="metricTile">
            <div class="metricLabel">Avg projected impact</div>
            <div class="metricValue">${formatMoney(metrics.avgMonthlyImpactCents)}</div>
            <div class="metricSub">MONTHLY view</div>
          </div>
        `;
      } catch (error) {
        document.getElementById('metricsRow').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load metrics</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Store vendor/location data for drill-down
    window.vendorsData = {};
    window.locationsData = {};

    // Load vendor breakdown
    async function loadVendors() {
      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/vendors?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('vendorBreakdown').innerHTML = '<div class="emptyState">No vendor data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.amountCents - a.amountCents).slice(0, 10);

        // Store for drill-down
        sorted.forEach((row, idx) => {
          window.vendorsData[`vendor_${idx}`] = row;
        });

        const html = sorted.map((row, idx) => `
          <div class="breakdownRow clickable-row" onclick="showVendorDrilldown(window.vendorsData['vendor_${idx}'])" title="Click to see all issues from ${row.name}">
            <div class="breakdownLeft">
              <div class="breakdownRank">${idx + 1}</div>
              <div class="breakdownName">${row.name}</div>
            </div>
            <div class="breakdownRight">
              <div class="breakdownAmount">${formatMoney(row.amountCents)}</div>
              <div class="breakdownMeta">${row.issuesCount} issues • ${row.invoicesCount} invoices <span class="drill-arrow">→</span></div>
            </div>
          </div>
        `).join('');

        document.getElementById('vendorBreakdown').innerHTML = html;
      } catch (error) {
        document.getElementById('vendorBreakdown').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load vendors</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load location breakdown
    async function loadLocations() {
      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/locations?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('locationBreakdown').innerHTML = '<div class="emptyState">No location data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.amountCents - a.amountCents).slice(0, 10);

        // Store for drill-down
        sorted.forEach((row, idx) => {
          window.locationsData[`location_${idx}`] = row;
        });

        const html = sorted.map((row, idx) => `
          <div class="breakdownRow clickable-row" onclick="showLocationDrilldown(window.locationsData['location_${idx}'])" title="Click to see all issues at ${row.name}">
            <div class="breakdownLeft">
              <div class="breakdownRank">${idx + 1}</div>
              <div class="breakdownName">${row.name}</div>
            </div>
            <div class="breakdownRight">
              <div class="breakdownAmount">${formatMoney(row.amountCents)}</div>
              <div class="breakdownMeta">${row.issuesCount} issues • ${row.invoicesCount} invoices <span class="drill-arrow">→</span></div>
            </div>
          </div>
        `).join('');

        document.getElementById('locationBreakdown').innerHTML = html;
      } catch (error) {
        document.getElementById('locationBreakdown').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load locations</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load flagged issues
    async function loadIssues() {
      try {
        const data = await fetchAPI(`/api/dashboard/issues?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('issuesTable').innerHTML = '<div class="emptyState">No flagged issues for this period</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.deltaCents - a.deltaCents);

        // Store issues data for proof modal
        window.issuesData = {};
        sorted.forEach((row, idx) => {
          window.issuesData[`issue_${idx}`] = row;
        });

        const html = `
          <table class="table">
            <thead>
              <tr>
                <th>Vendor</th>
                <th>Location</th>
                <th>Issue type</th>
                <th class="num">Current</th>
                <th class="num">Expected</th>
                <th class="num">Delta ($)</th>
                <th>Confidence</th>
                <th>Invoice date</th>
                <th style="text-align: center;">Proof</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map((row, idx) => `
                <tr>
                  <td class="cellMain">${row.vendorName}</td>
                  <td>${row.locationName}</td>
                  <td>${formatIssueType(row.issueType)}</td>
                  <td class="num">${formatMoney(row.currentChargeCents)}</td>
                  <td class="num">${formatMoney(row.expectedChargeCents)}</td>
                  <td class="num"><b>${formatMoney(row.deltaCents)}</b></td>
                  <td>
                    <span class="badge ${row.confidence === 'HIGH' ? 'badge-good' : 'badge-neutral'}">
                      ${row.confidence}
                    </span>
                  </td>
                  <td>${formatDate(row.invoiceDate)}</td>
                  <td style="text-align: center;">
                    <button class="btn-proof" onclick="showProof(window.issuesData['issue_${idx}'])">
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      See Proof
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        document.getElementById('issuesTable').innerHTML = html;
      } catch (error) {
        document.getElementById('issuesTable').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load issues</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load trial status for current user
    async function loadTrialStatus() {
      try {
        const response = await fetch(`${API_BASE}/auth/trial/status`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data && result.data.isTrial) {
            const trial = result.data;
            const banner = document.getElementById('trialBanner');
            const text = document.getElementById('trialStatusText');

            banner.style.display = 'block';

            // Build status message
            const daysText = trial.daysLeft === 1 ? '1 day' : `${trial.daysLeft} days`;
            const invoicesText = trial.invoicesLeft === 1 ? '1 invoice' : `${trial.invoicesLeft} invoices`;
            text.textContent = `🎁 FREE TRIAL: ${daysText} & ${invoicesText} remaining`;

            // Warning color when low
            if (trial.daysLeft <= 3 || trial.invoicesLeft <= 3) {
              banner.classList.add('warning');
            }
          }
        }
      } catch (error) {
        console.error('Failed to load trial status:', error);
        // Non-critical - don't show error to user
      }
    }

    // Open Action Items Modal
    function openActionItemsModal() {
      const modal = document.getElementById('actionItemsModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    // Close Action Items Modal
    function closeActionItemsModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('actionItemsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Open Actions Executed Modal
    function openActionsExecutedModal() {
      const modal = document.getElementById('actionsExecutedModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    // Close Actions Executed Modal
    function closeActionsExecutedModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('actionsExecutedModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // =====================================================
    // INTENT SIGNALS FUNCTIONS
    // =====================================================
    let intentSignalsData = [];
    let currentIntentFilter = 'all';

    // Open Intent Signals Modal
    function openIntentSignalsModal() {
      const modal = document.getElementById('intentSignalsModal');
      if (modal) {
        modal.classList.add('active');
        loadIntentSignals();
      }
    }

    // Close Intent Signals Modal
    function closeIntentSignalsModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('intentSignalsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Open Intent Config Modal
    function openIntentConfigModal() {
      const modal = document.getElementById('intentConfigModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    // Close Intent Config Modal
    function closeIntentConfigModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('intentConfigModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // Load Intent Signals from API
    async function loadIntentSignals() {
      try {
        const response = await fetch('/api/intent-signals/feed?limit=50', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
        });

        if (response.ok) {
          const data = await response.json();
          intentSignalsData = data.signals || [];
          updateIntentSignalsDisplay();
          updateIntentSummaryStats(data.summary || {});
        }
      } catch (error) {
        console.error('Error loading intent signals:', error);
      }
    }

    // Update Intent Summary Stats
    function updateIntentSummaryStats(summary) {
      document.getElementById('modalIntentNew').textContent = summary.new_count || 0;
      document.getElementById('modalIntentCritical').textContent = summary.critical_new || 0;
      document.getElementById('modalIntentHigh').textContent = summary.high_new || 0;

      const responseRate = summary.contacted_count && summary.total_signals
        ? Math.round((summary.contacted_count / summary.total_signals) * 100)
        : 0;
      document.getElementById('modalIntentContacted').textContent = responseRate + '%';

      // Update tile
      document.getElementById('tileIntentCount').textContent = (summary.new_count || 0) + ' New';
      const criticalCount = summary.critical_new || 0;
      document.getElementById('tileIntentCritical').textContent = criticalCount > 0
        ? criticalCount + ' Critical'
        : 'Monitoring active';

      // Add/remove critical indicator
      const tile = document.getElementById('intentSignalsTile');
      if (criticalCount > 0) {
        tile.classList.add('has-critical');
      } else {
        tile.classList.remove('has-critical');
      }
    }

    // Update Intent Signals Display
    function updateIntentSignalsDisplay() {
      const grid = document.getElementById('intentSignalsGrid');
      let filteredSignals = intentSignalsData;

      if (currentIntentFilter !== 'all') {
        if (currentIntentFilter === 'new') {
          filteredSignals = intentSignalsData.filter(s => s.status === 'new');
        } else if (currentIntentFilter === 'contacted') {
          filteredSignals = intentSignalsData.filter(s => s.status === 'contacted');
        } else {
          filteredSignals = intentSignalsData.filter(s => s.priority === currentIntentFilter);
        }
      }

      if (filteredSignals.length === 0) {
        grid.innerHTML = `
          <div class="intent-empty-state">
            <h3>No Intent Signals Yet</h3>
            <p>Configure your keywords and zip codes to start monitoring for buyer intent.</p>
            <button class="btn" onclick="openIntentConfigModal()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none;">Configure Keywords</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = filteredSignals.map(signal => renderIntentSignalCard(signal)).join('');
    }

    // Render a single intent signal card
    function renderIntentSignalCard(signal) {
      const freshnessClass = getFreshnessClass(signal.freshness_hours);
      const freshnessLabel = getFreshnessLabel(signal.freshness_hours);

      const contactHtml = signal.contact_name ? `
        <div class="intent-contact-info">
          <div class="contact-name">${escapeHtml(signal.contact_name)}</div>
          <div class="contact-title">${escapeHtml(signal.contact_title || 'Decision Maker')}</div>
          ${signal.contact_email ? `<div class="contact-email">${escapeHtml(signal.contact_email)}</div>` : ''}
        </div>
      ` : '';

      return `
        <div class="intent-signal-card priority-${signal.priority}" data-id="${signal.id}" data-priority="${signal.priority}" data-status="${signal.status}">
          <div class="intent-signal-content">
            <div class="intent-signal-header">
              <span class="intent-signal-company">${escapeHtml(signal.company_name)}</span>
              <span class="intent-signal-industry">${escapeHtml(signal.company_industry || 'Business')}</span>
              <span class="freshness-badge ${freshnessClass}">${freshnessLabel}</span>
            </div>
            <div class="intent-signal-location">
              ${escapeHtml(signal.company_city || '')}${signal.company_city && signal.company_state ? ', ' : ''}${escapeHtml(signal.company_state || '')} ${escapeHtml(signal.company_zip || '')}
            </div>
            <div class="intent-signal-keyword-box">
              <div class="intent-signal-keyword-label">Matched: ${escapeHtml(signal.matched_keyword)}</div>
              <div class="intent-signal-search-context">"${escapeHtml(signal.search_context || 'Searching for related products/services')}"</div>
            </div>
            ${contactHtml}
            <div class="intent-signal-meta">
              <span class="intent-signal-meta-item">
                <span style="color: #f97316;">●</span> ${signal.keyword_match_strength || 0}% match
              </span>
              <span class="intent-signal-meta-item">
                ${formatTimeAgo(signal.freshness_hours)} ago
              </span>
              ${signal.company_employee_count ? `
                <span class="intent-signal-meta-item">
                  ${signal.company_employee_count} employees
                </span>
              ` : ''}
            </div>
            <div class="intent-signal-actions">
              ${signal.status === 'new' ? `
                <button class="intent-signal-btn primary" onclick="markIntentContacted(${signal.id})">Mark Contacted</button>
              ` : `
                <span style="font-size: 11px; color: #22c55e;">✓ ${signal.status}</span>
              `}
              ${signal.contact_email ? `
                <button class="intent-signal-btn" onclick="emailIntentLead('${escapeHtml(signal.contact_email)}')">Email</button>
              ` : ''}
              ${signal.company_phone ? `
                <button class="intent-signal-btn" onclick="callIntentLead('${escapeHtml(signal.company_phone)}')">Call</button>
              ` : ''}
            </div>
          </div>
          <div class="intent-signal-score">
            <div>
              <div class="intent-signal-score-value">${signal.overall_score || 0}</div>
              <div class="intent-signal-score-label">Score</div>
            </div>
            <div style="margin-top: 12px;">
              <span class="freshness-badge ${signal.priority === 'critical' ? 'hot' : signal.priority === 'high' ? 'warm' : 'cooling'}" style="font-size: 9px;">${signal.priority.toUpperCase()}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Get freshness class based on hours
    function getFreshnessClass(hours) {
      if (hours <= 2) return 'hot';
      if (hours <= 8) return 'warm';
      if (hours <= 24) return 'cooling';
      return 'cold';
    }

    // Get freshness label
    function getFreshnessLabel(hours) {
      if (hours <= 2) return 'HOT';
      if (hours <= 8) return 'Warm';
      if (hours <= 24) return 'Cooling';
      return 'Cold';
    }

    // Format time ago
    function formatTimeAgo(hours) {
      if (hours < 1) {
        const mins = Math.round(hours * 60);
        return mins + ' min' + (mins !== 1 ? 's' : '');
      }
      if (hours < 24) {
        const h = Math.round(hours);
        return h + ' hour' + (h !== 1 ? 's' : '');
      }
      const days = Math.round(hours / 24);
      return days + ' day' + (days !== 1 ? 's' : '');
    }

    // Filter intent signals
    function filterIntentSignals(filter) {
      currentIntentFilter = filter;
      document.querySelectorAll('.intent-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      updateIntentSignalsDisplay();
    }

    // Mark signal as contacted
    async function markIntentContacted(signalId) {
      try {
        const response = await fetch(`/api/intent-signals/matches/${signalId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({ status: 'contacted' })
        });

        if (response.ok) {
          // Update local data
          const signal = intentSignalsData.find(s => s.id === signalId);
          if (signal) {
            signal.status = 'contacted';
          }
          updateIntentSignalsDisplay();
          loadIntentSignals(); // Refresh stats
          showToast('Signal marked as contacted', 'success');
        }
      } catch (error) {
        console.error('Error updating signal:', error);
        showToast('Failed to update signal', 'error');
      }
    }

    // Email intent lead
    function emailIntentLead(email) {
      window.location.href = `mailto:${email}?subject=Following up on your recent search`;
    }

    // Call intent lead
    function callIntentLead(phone) {
      window.location.href = `tel:${phone}`;
    }

    // Generate demo intent signals
    async function generateDemoIntentSignals() {
      try {
        const response = await fetch('/api/intent-signals/demo/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            keywords: ['restaurant equipment', 'commercial kitchen', 'food service supplies', 'pos system'],
            zip_codes: ['90210', '90211', '75201', '75202', '10001'],
            count: 8
          })
        });

        if (response.ok) {
          const result = await response.json();
          showToast(`Generated ${result.generated} demo signals!`, 'success');
          loadIntentSignals();
        } else {
          showToast('Failed to generate demo signals', 'error');
        }
      } catch (error) {
        console.error('Error generating demo signals:', error);
        showToast('Error generating demo signals', 'error');
      }
    }

    // Save intent config
    async function saveIntentConfig(event) {
      event.preventDefault();

      const configName = document.getElementById('configName').value;
      const keywordsRaw = document.getElementById('configKeywords').value;
      const zipCodesRaw = document.getElementById('configZipCodes').value;

      const keywords = keywordsRaw.split('\n').map(k => k.trim()).filter(k => k);
      const zipCodes = zipCodesRaw.split(',').map(z => z.trim()).filter(z => z);

      if (keywords.length === 0) {
        showToast('Please enter at least one keyword', 'error');
        return;
      }
      if (zipCodes.length === 0) {
        showToast('Please enter at least one zip code', 'error');
        return;
      }

      try {
        const response = await fetch('/api/intent-signals/configs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            config_name: configName,
            keywords: keywords,
            zip_codes: zipCodes,
            notify_critical: document.getElementById('notifyCritical').checked ? 1 : 0,
            notify_high: document.getElementById('notifyHigh').checked ? 1 : 0,
            notify_medium: document.getElementById('notifyMedium').checked ? 1 : 0,
            notify_low: document.getElementById('notifyLow').checked ? 1 : 0
          })
        });

        if (response.ok) {
          showToast('Configuration saved successfully!', 'success');
          closeIntentConfigModal();
          loadIntentSignals();
        } else {
          const err = await response.json();
          showToast(err.error || 'Failed to save configuration', 'error');
        }
      } catch (error) {
        console.error('Error saving config:', error);
        showToast('Error saving configuration', 'error');
      }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load intent signals on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Load intent signal summary for tile
      loadIntentSignalsSummary();
    });

    // Load just the summary for the tile (lighter weight)
    async function loadIntentSignalsSummary() {
      try {
        const response = await fetch('/api/intent-signals/summary', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
        });

        if (response.ok) {
          const summary = await response.json();
          updateIntentSummaryStats(summary);
        }
      } catch (error) {
        console.log('Intent signals not configured yet');
        document.getElementById('tileIntentCount').textContent = '0 New';
        document.getElementById('tileIntentCritical').textContent = 'Click to configure';
      }
    }

    // Scroll to Location Performance section
    function scrollToLocationPerformance() {
      const section = document.getElementById('locationPerformance');
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Scroll to Opportunity Pipeline section
    function scrollToOpportunityPipeline() {
      const section = document.getElementById('opportunityPipeline');
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Scroll to Flagged Issues section
    function scrollToFlaggedIssues() {
      const section = document.getElementById('issuesTable');
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Load all dashboard data
    async function loadDashboard() {
      // Update filters from inputs
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      if (dateFrom) filters.dateFrom = dateFrom;
      if (dateTo) filters.dateTo = dateTo;

      // Load all data in parallel
      await Promise.all([
        loadMetrics(),
        loadVendors(),
        loadLocations(),
        loadIssues()
      ]);
    }

    // Initialize with authentication and load dashboard
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // 1. Initialize authentication (blocks until complete)
        const user = await window.AuthManager.initialize();

        // 2. Check role access - VP dashboard requires admin, customer_admin, or demo_business role
        window.AuthManager.requireRole(['admin', 'customer_admin', 'demo_business']);

        // 3. Initialize navigation (depends on auth being ready)
        await window.initializeNavigation();

        // 4. Initialize date inputs
        document.getElementById('dateFrom').value = filters.dateFrom;
        document.getElementById('dateTo').value = filters.dateTo;

        // 5. Load trial status (if applicable)
        await loadTrialStatus();

        // 6. Load dashboard content
        loadDashboard();

        // 7. Load email monitors
        loadEmailMonitors();
        updateEmailMonitorTileBanner();

        // 8. Load inventory intelligence
        loadInventoryDashboard();
      } catch (error) {
        // AuthManager already handled redirect
        console.error('VP dashboard auth failed:', error);
      }
    });

    // =====================================================
    // INVENTORY INTELLIGENCE FUNCTIONS
    // =====================================================

    async function loadInventoryDashboard() {
      try {
        // Load dashboard data with all inventory info
        const response = await fetch(`${API_BASE}/api/bi/inventory/dashboard`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            renderInventoryStats(result.data);
            renderInventoryRecommendations(result.data.recommendations || []);
            renderStockoutAlerts(result.data.stockoutAlerts || []);
          }
        }
      } catch (error) {
        console.error('Failed to load inventory dashboard:', error);
        document.getElementById('inventoryRecommendations').innerHTML = `
          <div style="text-align: center; padding: 32px; color: var(--muted2);">
            <p>Unable to load inventory data.</p>
          </div>
        `;
      }
    }

    function renderInventoryStats(data) {
      const stats = data.stats || {};

      document.getElementById('invTotalItems').textContent = stats.total_items || 0;
      document.getElementById('invTotalValue').textContent = '$' + (stats.total_value_dollars || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
      document.getElementById('invLowStock').textContent = stats.low_stock_count || 0;

      // Health score
      const healthScore = data.healthScore || {};
      document.getElementById('invHealthScore').textContent = healthScore.grade || '-';

      // Update badge colors based on values
      const lowStockEl = document.getElementById('invLowStock');
      if ((stats.low_stock_count || 0) > 0) {
        lowStockEl.style.color = '#ef4444';
      } else {
        lowStockEl.style.color = '#10b981';
      }
    }

    function renderInventoryRecommendations(recommendations) {
      const container = document.getElementById('inventoryRecommendations');

      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 32px; color: var(--muted2);">
            <div style="font-size: 40px; margin-bottom: 12px;">✅</div>
            <h4 style="color: var(--text); margin-bottom: 8px;">All Caught Up!</h4>
            <p style="margin: 0;">No recommendations at this time. Your inventory is well-managed.</p>
          </div>
        `;
        document.getElementById('invCriticalBadge').textContent = '0 Critical';
        document.getElementById('invSavingsBadge').textContent = '$0 Savings';
        return;
      }

      // Count critical and total savings
      const criticalCount = recommendations.filter(r => r.priority === 'critical').length;
      const totalSavings = recommendations.reduce((sum, r) => sum + (r.potential_savings_cents || 0), 0);

      document.getElementById('invCriticalBadge').textContent = `${criticalCount} Critical`;
      document.getElementById('invSavingsBadge').textContent = '$' + (totalSavings / 100).toLocaleString();

      // Show top 5 recommendations
      const topRecs = recommendations.slice(0, 5);

      container.innerHTML = topRecs.map(rec => {
        const bgColor = rec.priority === 'critical' ? 'rgba(239, 68, 68, 0.1)' :
                       rec.priority === 'high' ? 'rgba(251, 191, 36, 0.1)' : 'var(--panel2)';
        const borderColor = rec.priority === 'critical' ? 'rgba(239, 68, 68, 0.3)' :
                           rec.priority === 'high' ? 'rgba(251, 191, 36, 0.3)' : 'var(--border)';
        const typeIcon = getRecommendationIcon(rec.recommendation_type);

        return `
          <div style="background: ${bgColor}; padding: 16px; border-radius: 10px; border: 1px solid ${borderColor}; display: flex; align-items: flex-start; gap: 12px;">
            <div style="font-size: 24px; flex-shrink: 0;">${typeIcon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;">${escapeHtml(rec.title)}</div>
              <div style="font-size: 13px; color: var(--muted2); line-height: 1.5;">${escapeHtml(rec.description)}</div>
              ${rec.potential_savings_cents > 0 ? `
                <div style="margin-top: 8px; font-size: 12px; color: #22c55e; font-weight: 600;">
                  💰 Potential savings: $${(rec.potential_savings_cents / 100).toLocaleString()}
                </div>
              ` : ''}
            </div>
            ${rec.suggested_quantity > 0 ? `
              <button onclick="actionInventoryRec(${rec.id}, ${rec.suggested_quantity})" class="btn" style="font-size: 12px; padding: 8px 12px; white-space: nowrap;">
                Order ${rec.suggested_quantity}
              </button>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderStockoutAlerts(alerts) {
      const container = document.getElementById('stockoutAlerts');

      if (!alerts || alerts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 24px; color: var(--muted2);">
            <p style="margin: 0;">✅ No stockout alerts at this time.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = alerts.slice(0, 5).map(alert => {
        const urgencyColor = alert.severity === 'critical' ? '#ef4444' :
                            alert.severity === 'warning' ? '#f59e0b' : '#64748b';

        return `
          <div style="background: var(--panel2); padding: 12px 16px; border-radius: 8px; border-left: 3px solid ${urgencyColor}; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
            <div>
              <div style="font-weight: 600; color: var(--text);">${escapeHtml(alert.product_name || alert.sku)}</div>
              <div style="font-size: 12px; color: var(--muted2);">
                ${alert.days_until_stockout} days until stockout • Current: ${alert.current_quantity} ${alert.unit || 'units'}
              </div>
            </div>
            <span style="background: ${urgencyColor}20; color: ${urgencyColor}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
              ${alert.severity}
            </span>
          </div>
        `;
      }).join('');
    }

    function getRecommendationIcon(type) {
      const icons = {
        'urgent_reorder': '🚨',
        'discount_opportunity': '💰',
        'supply_forecast': '📊',
        'holiday_prep': '🎄',
        'bulk_opportunity': '📦',
        'overstock_warning': '📈',
        'usage_spike': '⚡',
        'usage_drop': '📉'
      };
      return icons[type] || '📋';
    }

    async function runInventoryAnalysis() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Analyzing...';

        const response = await fetch(`${API_BASE}/api/bi/inventory/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          await loadInventoryDashboard();
          alert('Analysis complete! Inventory recommendations updated.');
        }
      } catch (error) {
        console.error('Failed to run analysis:', error);
        alert('Failed to run analysis. Please try again.');
      } finally {
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
      }
    }

    async function actionInventoryRec(id, quantity) {
      try {
        const response = await fetch(`${API_BASE}/api/bi/inventory/recommendations/${id}/action`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({ quantity_ordered: quantity })
        });

        if (response.ok) {
          loadInventoryDashboard();
        }
      } catch (error) {
        console.error('Failed to action recommendation:', error);
      }
    }

    // =====================================================
    // EMAIL MONITOR FUNCTIONS
    // =====================================================

    async function loadEmailMonitors() {
      try {
        const response = await fetch(`${API_BASE}/api/email-monitors`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const list = document.getElementById('emailMonitorsList');
          const statsBar = document.getElementById('emailAutopilotStats');

          // API returns result.data, not result.monitors
          const monitors = result.data || result.monitors || [];

          if (!monitors || monitors.length === 0) {
            // Show empty state (already in HTML)
            statsBar.style.display = 'none';
            list.innerHTML = document.querySelector('.emailAutopilotEmptyState')?.outerHTML ||
              '<div style="text-align: center; padding: 40px; color: var(--muted2);">No email monitors configured.</div>';
            return;
          }

          // Calculate aggregate stats
          let totalActive = 0;
          let totalEmailsProcessed = 0;
          let totalInvoicesCreated = 0;
          let lastCheckTime = null;

          monitors.forEach(m => {
            if (m.is_active) totalActive++;
            totalEmailsProcessed += m.emails_processed_count || 0;
            totalInvoicesCreated += m.invoices_created_count || 0;
            if (m.last_checked_at && (!lastCheckTime || new Date(m.last_checked_at) > new Date(lastCheckTime))) {
              lastCheckTime = m.last_checked_at;
            }
          });

          // Update stats bar
          statsBar.style.display = 'block';
          document.getElementById('statActiveMonitors').textContent = totalActive;
          document.getElementById('statEmailsProcessed').textContent = totalEmailsProcessed.toLocaleString();
          document.getElementById('statInvoicesCreated').textContent = totalInvoicesCreated.toLocaleString();
          document.getElementById('statLastCheck').textContent = lastCheckTime ?
            formatRelativeTime(lastCheckTime) : '-';

          // Render monitor cards with enhanced info
          list.innerHTML = monitors.map(monitor => {
            const statusColor = monitor.is_active ? '#10b981' : '#6b7280';
            const statusText = monitor.is_active ? 'Active' : 'Paused';
            const lastError = monitor.last_error ? `<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">⚠️ ${monitor.last_error}</div>` : '';

            return `
            <div style="background: var(--panel2); padding: 20px; border-radius: 8px; border: 1px solid ${monitor.is_active ? 'var(--border-gold)' : 'var(--border)'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; ${monitor.is_active ? 'box-shadow: 0 0 8px ' + statusColor : ''};"></span>
                    <span style="font-weight: 600; color: var(--text); font-size: 16px;">${escapeHtml(monitor.name)}</span>
                  </div>
                  <div style="font-size: 13px; color: var(--muted2); margin-bottom: 4px;">📧 ${escapeHtml(monitor.email_address)}</div>
                  <div style="font-size: 12px; color: var(--muted2);">
                    Last checked: ${monitor.last_checked_at ? formatRelativeTime(monitor.last_checked_at) : 'Never'}
                  </div>
                  ${lastError}
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center; min-width: 240px;">
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text);">${(monitor.emails_processed_count || 0).toLocaleString()}</div>
                    <div style="font-size: 11px; color: var(--muted2);">Emails</div>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: #10b981;">${(monitor.invoices_created_count || 0).toLocaleString()}</div>
                    <div style="font-size: 11px; color: var(--muted2);">Invoices</div>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--gold);">${monitor.check_frequency_minutes || 15}m</div>
                    <div style="font-size: 11px; color: var(--muted2);">Interval</div>
                  </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px; min-width: 120px;">
                  <button onclick="checkEmailNow(${monitor.id})" class="btn" style="font-size: 12px; padding: 8px 12px; background: #6366f1;">
                    ⚡ Check Now
                  </button>
                  <button onclick="viewMonitorActivity(${monitor.id}, '${escapeHtml(monitor.name)}')" class="btn" style="font-size: 12px; padding: 8px 12px; background: var(--panel);">
                    📊 Activity
                  </button>
                  <div style="display: flex; gap: 8px;">
                    <button onclick="toggleEmailMonitor(${monitor.id}, ${!monitor.is_active})" class="btn" style="flex: 1; font-size: 11px; padding: 6px 8px; background: ${monitor.is_active ? '#6b7280' : '#10b981'};">
                      ${monitor.is_active ? 'Pause' : 'Start'}
                    </button>
                    <button onclick="deleteEmailMonitor(${monitor.id}, '${escapeHtml(monitor.name)}')" class="btn" style="font-size: 11px; padding: 6px 8px; background: #dc2626;">
                      🗑️
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          }).join('');
        }
      } catch (error) {
        console.error('Failed to load email monitors:', error);
        document.getElementById('emailMonitorsList').innerHTML =
          '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load email monitors. Please refresh the page.</div>';
      }
    }

    // Helper: Format relative time (e.g., "5 mins ago")
    function formatRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    // Helper: Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update the email monitor stats in the dashboard tile banner
    async function updateEmailMonitorTileBanner() {
      try {
        const response = await fetch(`${API_BASE}/api/email-monitors`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const statsContainer = document.getElementById('emailMonitorStats');
        if (!statsContainer) return;

        if (response.ok) {
          const result = await response.json();
          const monitors = result.data || result.monitors || [];

          if (!monitors || monitors.length === 0) {
            statsContainer.innerHTML = `
              <div class="email-monitor-empty" style="color: var(--muted2); font-size: 13px;">
                No email monitors configured yet
              </div>
            `;
            return;
          }

          // Build the monitor list HTML
          const monitorsHtml = monitors.map(monitor => {
            const statusDot = monitor.is_active
              ? '<span style="width: 6px; height: 6px; background: #10b981; border-radius: 50%; box-shadow: 0 0 6px #10b981;"></span>'
              : '<span style="width: 6px; height: 6px; background: #6b7280; border-radius: 50%;"></span>';

            const lastChecked = monitor.last_checked_at ? formatRelativeTime(monitor.last_checked_at) : 'Never';
            const invoiceCount = monitor.invoices_created_count || 0;

            return `
              <div class="email-monitor-item">
                ${statusDot}
                <span class="monitor-email">${escapeHtml(monitor.email_address)}</span>
                <div class="monitor-stats">
                  <span class="monitor-stat">
                    <span class="monitor-stat-value">${invoiceCount}</span> invoices
                  </span>
                  <span class="monitor-stat">
                    Last: <span class="monitor-stat-value">${lastChecked}</span>
                  </span>
                </div>
              </div>
            `;
          }).join('');

          statsContainer.innerHTML = `<div class="email-monitor-list">${monitorsHtml}</div>`;
        }
      } catch (error) {
        console.error('Failed to load email monitor stats for tile:', error);
      }
    }

    function openAddEmailMonitor() {
      const modal = document.getElementById('addEmailMonitorModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    function closeAddEmailMonitor(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('addEmailMonitorModal');
      if (modal) {
        modal.classList.remove('active');
        // Clear form
        document.getElementById('newMonitorName').value = '';
        document.getElementById('newMonitorEmail').value = '';
        document.getElementById('newMonitorPassword').value = '';
        document.getElementById('newMonitorImapHost').value = '';
        document.getElementById('newMonitorImapPort').value = '993';
        document.getElementById('testConnectionResult').style.display = 'none';
      }
    }

    function openSetupGuide() {
      const modal = document.getElementById('setupGuideModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    function closeSetupGuide(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('setupGuideModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function closeMonitorActivity() {
      document.getElementById('monitorActivityModal').style.display = 'none';
    }

    // Check emails immediately for a monitor
    async function checkEmailNow(monitorId) {
      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}/check-now`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('Email check started! Refresh in a moment to see results.');
          setTimeout(loadEmailMonitors, 3000);
        } else {
          alert(`Failed to check: ${result.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // View activity log for a monitor
    async function viewMonitorActivity(monitorId, monitorName) {
      document.getElementById('monitorActivityTitle').textContent = `📊 ${monitorName} - Activity Log`;
      document.getElementById('monitorActivityModal').style.display = 'flex';
      document.getElementById('monitorActivityContent').innerHTML =
        '<div style="text-align: center; padding: 40px; color: var(--muted2);">Loading activity...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}/activity?limit=20`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const activity = result.data?.activity || [];

          if (activity.length === 0) {
            document.getElementById('monitorActivityContent').innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--muted2);">No activity yet. Emails will appear here once processed.</div>';
            return;
          }

          document.getElementById('monitorActivityContent').innerHTML = `
            <div style="display: grid; gap: 8px;">
              ${activity.map(item => {
                const statusColor = item.status === 'success' ? '#10b981' :
                                    item.status === 'error' ? '#ef4444' : '#6b7280';
                const statusIcon = item.status === 'success' ? '✓' :
                                   item.status === 'error' ? '✗' : '⏭️';
                return `
                  <div style="background: var(--panel2); padding: 12px 16px; border-radius: 6px; border-left: 3px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <span style="color: ${statusColor}; font-weight: 600;">${statusIcon}</span>
                        <span style="color: var(--text); margin-left: 8px;">${escapeHtml(item.email_subject || 'No subject')}</span>
                      </div>
                      <span style="color: var(--muted2); font-size: 12px;">${formatRelativeTime(item.processed_at)}</span>
                    </div>
                    ${item.invoices_created > 0 ? `<div style="font-size: 12px; color: #10b981; margin-top: 4px;">📄 Created ${item.invoices_created} invoice(s)</div>` : ''}
                    ${item.error_message ? `<div style="font-size: 12px; color: #ef4444; margin-top: 4px;">Error: ${escapeHtml(item.error_message)}</div>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('monitorActivityContent').innerHTML =
          `<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load activity: ${error.message}</div>`;
      }
    }

    async function detectIMAPSettings() {
      const email = document.getElementById('newMonitorEmail').value.trim();
      if (!email) return;

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/detect-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({ email })
        });

        if (response.ok) {
          const result = await response.json();
          if (result.settings) {
            document.getElementById('newMonitorImapHost').value = result.settings.imap_host;
            document.getElementById('newMonitorImapPort').value = result.settings.imap_port;
          }
        }
      } catch (error) {
        console.error('Failed to detect IMAP settings:', error);
      }
    }

    async function testIMAPConnection() {
      const email = document.getElementById('newMonitorEmail').value.trim();
      const password = document.getElementById('newMonitorPassword').value;
      const imapHost = document.getElementById('newMonitorImapHost').value.trim();
      const imapPort = document.getElementById('newMonitorImapPort').value;

      if (!email || !password || !imapHost) {
        alert('Please fill in email, password, and IMAP server first');
        return;
      }

      const resultDiv = document.getElementById('testConnectionResult');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div style="color: var(--muted);">Testing connection...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/test-connection`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            email_address: email,
            email_password: password,
            imap_host: imapHost,
            imap_port: parseInt(imapPort)
          })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">✓ Connection successful!</div>';
        } else {
          resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">✗ Connection failed: ${result.error}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">✗ Connection failed: ${error.message}</div>`;
      }
    }

    async function createEmailMonitor() {
      const name = document.getElementById('newMonitorName').value.trim();
      const email_address = document.getElementById('newMonitorEmail').value.trim();
      const email_password = document.getElementById('newMonitorPassword').value;
      const imap_host = document.getElementById('newMonitorImapHost').value.trim();
      const imap_port = parseInt(document.getElementById('newMonitorImapPort').value);

      if (!name || !email_address || !email_password || !imap_host) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            name,
            email_address,
            email_password,
            imap_host,
            imap_port,
            imap_secure: true,
            folder: 'INBOX',
            check_interval_minutes: 15
          })
        });

        const result = await response.json();

        if (result.success) {
          alert('Email monitor created successfully!');
          closeAddEmailMonitor();
          loadEmailMonitors();
        } else {
          alert(`Failed to create monitor: ${result.error}`);
        }
      } catch (error) {
        alert(`Error creating monitor: ${error.message}`);
      }
    }

    async function toggleEmailMonitor(monitorId, isActive) {
      try {
        const url = isActive ?
          `${API_BASE}/api/email-monitors/${monitorId}/start` :
          `${API_BASE}/api/email-monitors/${monitorId}/stop`;

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          loadEmailMonitors();
        } else {
          alert(`Failed to ${isActive ? 'start' : 'stop'} monitor: ${result.error}`);
          loadEmailMonitors();
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
        loadEmailMonitors();
      }
    }

    async function deleteEmailMonitor(monitorId, monitorName) {
      if (!confirm(`Are you sure you want to delete the email monitor "${monitorName}"?\n\nThis will stop monitoring this email and cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          loadEmailMonitors();
        } else {
          alert(`Failed to delete monitor: ${result.error}`);
        }
      } catch (error) {
        alert(`Error deleting monitor: ${error.message}`);
      }
    }

    // =====================================================
    // PAYROLL & EXPENSE ENTRY FUNCTIONS
    // =====================================================

    // Chart instances (for cleanup)
    let expenseBreakdownChart = null;
    let spendingTrendChart = null;

    // Open Manual Payroll Modal
    function openManualPayrollModal() {
      const modal = document.getElementById('manualPayrollModal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        // Focus on first input
        setTimeout(() => {
          document.getElementById('payrollStart')?.focus();
        }, 100);
      }
    }

    // Close Manual Payroll Modal
    function closeManualPayrollModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('manualPayrollModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    // Open Manual Expense Modal
    function openManualExpenseModal() {
      const modal = document.getElementById('manualExpenseModal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        // Focus on first input
        setTimeout(() => {
          document.getElementById('expenseCategory')?.focus();
        }, 100);
      }
    }

    // Close Manual Expense Modal
    function closeManualExpenseModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('manualExpenseModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    // Legacy functions (kept for compatibility)
    function openPayrollEntry() {
      openManualPayrollModal();
    }

    function openExpenseEntry() {
      openManualExpenseModal();
    }

    // Submit payroll entry
    async function submitPayroll(event) {
      event.preventDefault();

      const payrollData = {
        period_start: document.getElementById('payrollStart').value,
        period_end: document.getElementById('payrollEnd').value,
        gross_payroll_cents: Math.round(parseFloat(document.getElementById('payrollGross').value) * 100), // Convert to cents
        employee_count: parseInt(document.getElementById('payrollEmployees').value) || null,
        hours_worked: parseFloat(document.getElementById('payrollHours').value) || null,
        notes: document.getElementById('payrollNotes').value || null
      };

      const statusDiv = document.getElementById('payrollStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">Saving payroll entry...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/bi/payroll`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify(payrollData)
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">✓ Payroll entry saved successfully!</div>';
          // Reset form
          document.getElementById('payrollForm').reset();
          setDefaultDates();
          // Refresh charts
          loadFinancialCharts();
          // Clear status after 3 seconds
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
          statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${result.error || 'Failed to save payroll'}</div>`;
        }
      } catch (error) {
        console.error('Payroll submission error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    // Submit expense entry
    async function submitExpense(event) {
      event.preventDefault();

      const expenseDate = document.getElementById('expenseDate').value;
      const expenseData = {
        category: document.getElementById('expenseCategory').value,
        period_start: expenseDate,
        period_end: expenseDate,
        amount_cents: Math.round(parseFloat(document.getElementById('expenseAmount').value) * 100), // Convert to cents
        vendor_name: document.getElementById('expenseVendor').value || null,
        description: document.getElementById('expenseNotes').value || null
      };

      const statusDiv = document.getElementById('expenseStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">Saving expense entry...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/bi/expenses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify(expenseData)
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">✓ Expense entry saved successfully!</div>';
          // Reset form
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = getTodayDate();
          // Refresh charts
          loadFinancialCharts();
          // Clear status after 3 seconds
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
          statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${result.error || 'Failed to save expense'}</div>`;
        }
      } catch (error) {
        console.error('Expense submission error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    // View payroll history
    function viewPayrollHistory() {
      window.location.href = 'payroll-history.html';
    }

    // View expense history
    function viewExpenseHistory() {
      window.location.href = 'expense-history.html';
    }

    // Set default dates for forms
    function setDefaultDates() {
      const today = new Date();
      const twoWeeksAgo = new Date(today);
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);

      // Payroll defaults to last 2 weeks
      const payrollStart = document.getElementById('payrollStart');
      const payrollEnd = document.getElementById('payrollEnd');
      if (payrollStart) payrollStart.value = twoWeeksAgo.toISOString().split('T')[0];
      if (payrollEnd) payrollEnd.value = today.toISOString().split('T')[0];

      // Expense defaults to today
      const expenseDate = document.getElementById('expenseDate');
      if (expenseDate) expenseDate.value = today.toISOString().split('T')[0];
    }

    // =====================================================
    // FINANCIAL CHARTS FUNCTIONS
    // =====================================================

    async function loadFinancialCharts() {
      const period = document.getElementById('chartPeriod')?.value || 30;

      try {
        // Fetch financial summary data
        const response = await fetch(`${API_BASE}/api/bi/financial-summary?days=${period}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            renderFinancialSummary(result.data);
            renderExpenseBreakdownChart(result.data.breakdown || []);
            renderSpendingTrendChart(result.data.trend || []);
            renderBudgetComparison(result.data.budget || []);
          }
        } else {
          // If API not ready, show demo data
          renderDemoFinancialData();
        }
      } catch (error) {
        console.error('Failed to load financial charts:', error);
        // Show demo data on error
        renderDemoFinancialData();
      }
    }

    function renderFinancialSummary(data) {
      const totals = data.totals || {};
      document.getElementById('chartTotalExpenses').textContent = '$' + ((totals.expenses || 0) / 100).toLocaleString();
      document.getElementById('chartTotalPayroll').textContent = '$' + ((totals.payroll || 0) / 100).toLocaleString();
      document.getElementById('chartTotalInventory').textContent = '$' + ((totals.inventory || 0) / 100).toLocaleString();
      document.getElementById('chartTotalSavings').textContent = '$' + ((totals.savings || 0) / 100).toLocaleString();
    }

    function renderExpenseBreakdownChart(breakdown) {
      const ctx = document.getElementById('expenseBreakdownChart');
      if (!ctx) return;

      // Destroy existing chart
      if (expenseBreakdownChart) {
        expenseBreakdownChart.destroy();
      }

      const labels = breakdown.map(b => b.category);
      const values = breakdown.map(b => b.amount / 100);
      const colors = [
        '#fbbf24', // Gold - Payroll
        '#3b82f6', // Blue - Inventory
        '#10b981', // Green - Utilities
        '#ef4444', // Red - Rent
        '#8b5cf6', // Purple - Supplies
        '#f59e0b', // Orange - Other
      ];

      expenseBreakdownChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            data: values.length > 0 ? values : [1],
            backgroundColor: colors.slice(0, labels.length || 1),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(255,255,255,0.7)',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    function renderSpendingTrendChart(trend) {
      const ctx = document.getElementById('spendingTrendChart');
      if (!ctx) return;

      // Destroy existing chart
      if (spendingTrendChart) {
        spendingTrendChart.destroy();
      }

      const labels = trend.map(t => t.date);
      const values = trend.map(t => t.amount / 100);

      spendingTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            label: 'Spending',
            data: values.length > 0 ? values : [0],
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointBackgroundColor: '#fbbf24'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: {
                color: 'rgba(255,255,255,0.5)',
                font: { size: 10 },
                callback: value => '$' + value.toLocaleString()
              }
            }
          }
        }
      });
    }

    function renderBudgetComparison(budgetData) {
      const container = document.getElementById('budgetComparison');
      if (!container) return;

      if (!budgetData || budgetData.length === 0) {
        // Show demo budget data
        budgetData = [
          { category: 'Payroll', budget: 5000000, actual: 4800000 },
          { category: 'Inventory', budget: 2000000, actual: 2100000 },
          { category: 'Utilities', budget: 500000, actual: 450000 },
          { category: 'Rent', budget: 300000, actual: 300000 }
        ];
      }

      container.innerHTML = budgetData.map(item => {
        const budgetDollars = item.budget / 100;
        const actualDollars = item.actual / 100;
        const percentage = Math.min((item.actual / item.budget) * 100, 100);
        const isOver = item.actual > item.budget;
        const barColor = isOver ? '#ef4444' : '#10b981';

        return `
          <div style="background: var(--panel2); padding: 12px 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: var(--text); font-weight: 600; font-size: 13px;">${item.category}</span>
              <span style="color: ${isOver ? '#ef4444' : '#10b981'}; font-size: 12px; font-weight: 600;">
                $${actualDollars.toLocaleString()} / $${budgetDollars.toLocaleString()}
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width: ${percentage}%; background: ${barColor};"></div>
            </div>
            ${isOver ? `<div style="font-size: 11px; color: #ef4444; margin-top: 4px;">⚠️ Over budget by $${((item.actual - item.budget) / 100).toLocaleString()}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Demo data when API not ready
    function renderDemoFinancialData() {
      // Update summary with demo values
      document.getElementById('chartTotalExpenses').textContent = '$48,250';
      document.getElementById('chartTotalPayroll').textContent = '$32,500';
      document.getElementById('chartTotalInventory').textContent = '$12,800';
      document.getElementById('chartTotalSavings').textContent = '$2,340';

      // Demo expense breakdown
      renderExpenseBreakdownChart([
        { category: 'Payroll', amount: 3250000 },
        { category: 'Inventory', amount: 1280000 },
        { category: 'Utilities', amount: 450000 },
        { category: 'Rent', amount: 350000 },
        { category: 'Supplies', amount: 495000 }
      ]);

      // Demo spending trend (last 7 days)
      const today = new Date();
      const trendData = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        trendData.push({
          date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          amount: Math.floor(Math.random() * 500000) + 100000
        });
      }
      renderSpendingTrendChart(trendData);

      // Demo budget comparison
      renderBudgetComparison([
        { category: 'Payroll', budget: 3500000, actual: 3250000 },
        { category: 'Inventory', budget: 1500000, actual: 1280000 },
        { category: 'Utilities', budget: 400000, actual: 450000 },
        { category: 'Rent', budget: 350000, actual: 350000 }
      ]);
    }

    // Initialize financial features on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Set default dates for payroll and expense forms
      setTimeout(setDefaultDates, 100);

      // Load financial charts
      setTimeout(loadFinancialCharts, 500);
    });

    // =====================================================
    // PAYROLL FILE UPLOAD FUNCTIONS
    // =====================================================

    let selectedPayrollFile = null;

    function openPayrollUpload() {
      document.getElementById('payrollUploadModal').style.display = 'flex';
      clearPayrollFile();
    }

    function closePayrollUpload() {
      document.getElementById('payrollUploadModal').style.display = 'none';
      clearPayrollFile();
    }

    function clearPayrollFile() {
      selectedPayrollFile = null;
      document.getElementById('payrollFileInput').value = '';
      document.getElementById('payrollFileInfo').style.display = 'none';
      document.getElementById('payrollUploadBtn').disabled = true;
      document.getElementById('payrollUploadStatus').style.display = 'none';
    }

    function handlePayrollDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--gold)';
      document.getElementById('payrollDropZone').style.background = 'rgba(251, 191, 36, 0.05)';
    }

    function handlePayrollDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--border)';
      document.getElementById('payrollDropZone').style.background = 'transparent';
    }

    function handlePayrollDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--border)';
      document.getElementById('payrollDropZone').style.background = 'transparent';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processPayrollFile(files[0]);
      }
    }

    function handlePayrollFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) {
        processPayrollFile(files[0]);
      }
    }

    function processPayrollFile(file) {
      const validTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
        'application/vnd.ms-excel', // xls
        'text/csv',
        'application/pdf'
      ];
      const validExtensions = ['.xlsx', '.xls', '.csv', '.pdf'];
      const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

      if (!validExtensions.includes(ext)) {
        alert('Please upload an Excel (.xlsx, .xls), CSV, or PDF file.');
        return;
      }

      selectedPayrollFile = file;
      document.getElementById('payrollFileName').textContent = file.name;
      document.getElementById('payrollFileSize').textContent = formatFileSize(file.size);
      document.getElementById('payrollFileInfo').style.display = 'block';
      document.getElementById('payrollUploadBtn').disabled = false;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function uploadPayrollFile() {
      if (!selectedPayrollFile) {
        alert('Please select a file first.');
        return;
      }

      const statusDiv = document.getElementById('payrollUploadStatus');
      const uploadBtn = document.getElementById('payrollUploadBtn');

      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">📤 Uploading and processing file...</div>';
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Processing...';

      try {
        const ext = selectedPayrollFile.name.toLowerCase().substring(selectedPayrollFile.name.lastIndexOf('.'));
        let payrollData = null;

        // Parse the file based on type
        if (ext === '.xlsx' || ext === '.xls') {
          payrollData = await parseExcelPayroll(selectedPayrollFile);
        } else if (ext === '.csv') {
          payrollData = await parseCSVPayroll(selectedPayrollFile);
        } else if (ext === '.pdf') {
          payrollData = await parsePDFPayroll(selectedPayrollFile);
        }

        if (!payrollData || payrollData.entries.length === 0) {
          throw new Error('Could not extract payroll data from file. Please check the format or try a different export.');
        }

        // Get optional period dates
        const periodStart = document.getElementById('payrollUploadStart').value;
        const periodEnd = document.getElementById('payrollUploadEnd').value;
        const provider = document.getElementById('payrollProvider').value;

        // Send to API
        const response = await fetch(`${API_BASE}/api/bi/payroll/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            entries: payrollData.entries,
            provider: provider || payrollData.detectedProvider,
            period_start: periodStart || payrollData.periodStart,
            period_end: periodEnd || payrollData.periodEnd,
            filename: selectedPayrollFile.name,
            summary: payrollData.summary
          })
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
            <div style="color: #10b981; font-weight: 600;">✓ Payroll uploaded successfully!</div>
            <div style="color: var(--muted); font-size: 13px; margin-top: 8px;">
              Processed ${result.data?.entriesCreated || payrollData.entries.length} payroll entries.
              ${result.data?.totalAmount ? `Total: $${(result.data.totalAmount / 100).toLocaleString()}` : ''}
            </div>
          `;
          // Refresh charts after successful upload
          setTimeout(() => {
            loadFinancialCharts();
            closePayrollUpload();
          }, 2000);
        } else {
          throw new Error(result.error || 'Failed to upload payroll data');
        }
      } catch (error) {
        console.error('Payroll upload error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload & Process';
      }
    }

    // Parse Excel payroll files (ADP, Toast, Gusto, etc.)
    async function parseExcelPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            // Detect provider and parse accordingly
            const parsed = parsePayrollRows(rows, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse Excel file: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Parse CSV payroll files
    async function parseCSVPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const rows = text.split('\n').map(row => {
              // Handle quoted CSV values
              const result = [];
              let cell = '';
              let inQuotes = false;
              for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  result.push(cell.trim());
                  cell = '';
                } else {
                  cell += char;
                }
              }
              result.push(cell.trim());
              return result;
            });

            const parsed = parsePayrollRows(rows, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse CSV file: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    // Parse PDF payroll files (extract text and try to find amounts)
    async function parsePDFPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            if (typeof pdfjsLib === 'undefined') {
              // Fallback: just extract basic info
              resolve({
                entries: [{
                  description: 'Payroll from PDF',
                  gross_amount_cents: 0,
                  needs_manual_entry: true
                }],
                detectedProvider: 'pdf',
                summary: { message: 'PDF files require manual verification. Please review the extracted data.' }
              });
              return;
            }

            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }

            // Extract amounts from PDF text
            const parsed = extractPayrollFromText(fullText, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse PDF: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Common payroll parsing logic for Excel/CSV rows
    function parsePayrollRows(rows, filename) {
      const entries = [];
      let detectedProvider = null;
      let periodStart = null;
      let periodEnd = null;

      // Try to detect provider from filename or headers
      const lowerFilename = filename.toLowerCase();
      if (lowerFilename.includes('adp')) detectedProvider = 'adp';
      else if (lowerFilename.includes('toast')) detectedProvider = 'toast';
      else if (lowerFilename.includes('gusto')) detectedProvider = 'gusto';
      else if (lowerFilename.includes('quickbooks') || lowerFilename.includes('qb')) detectedProvider = 'quickbooks';
      else if (lowerFilename.includes('paychex')) detectedProvider = 'paychex';
      else if (lowerFilename.includes('square')) detectedProvider = 'square';

      // Find header row and important columns
      let headerRow = -1;
      let colMap = {};

      const possibleHeaders = {
        employee: ['employee', 'name', 'employee name', 'worker', 'team member'],
        gross: ['gross', 'gross pay', 'gross wages', 'total gross', 'earnings', 'total earnings', 'gross amount'],
        net: ['net', 'net pay', 'net wages', 'take home', 'net amount'],
        hours: ['hours', 'hours worked', 'total hours', 'reg hours', 'regular hours'],
        date: ['date', 'pay date', 'check date', 'period end', 'period ending'],
        department: ['department', 'dept', 'location', 'store']
      };

      for (let i = 0; i < Math.min(rows.length, 20); i++) {
        const row = rows[i];
        if (!row) continue;

        const rowLower = row.map(cell => String(cell || '').toLowerCase().trim());

        // Check if this looks like a header row
        let matchCount = 0;
        for (const [key, variants] of Object.entries(possibleHeaders)) {
          for (let j = 0; j < rowLower.length; j++) {
            if (variants.some(v => rowLower[j].includes(v))) {
              colMap[key] = j;
              matchCount++;
              break;
            }
          }
        }

        if (matchCount >= 2) {
          headerRow = i;
          break;
        }
      }

      // If no header found, try to parse as simple table
      if (headerRow === -1) {
        // Look for rows with dollar amounts
        for (const row of rows) {
          if (!row) continue;
          for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || '');
            const match = cell.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              const amount = parseFloat(match[1].replace(/,/g, ''));
              if (amount > 100 && amount < 1000000) { // Reasonable payroll amount
                entries.push({
                  description: row[0] || 'Payroll entry',
                  gross_amount_cents: Math.round(amount * 100)
                });
                break;
              }
            }
          }
        }
      } else {
        // Parse data rows after header
        for (let i = headerRow + 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.every(cell => !cell)) continue;

          const entry = {
            employee_name: colMap.employee !== undefined ? String(row[colMap.employee] || '') : null,
            gross_amount_cents: 0,
            net_amount_cents: 0,
            hours: 0,
            department: colMap.department !== undefined ? String(row[colMap.department] || '') : null
          };

          // Parse gross amount
          if (colMap.gross !== undefined) {
            const grossStr = String(row[colMap.gross] || '');
            const match = grossStr.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              entry.gross_amount_cents = Math.round(parseFloat(match[1].replace(/,/g, '')) * 100);
            }
          }

          // Parse net amount
          if (colMap.net !== undefined) {
            const netStr = String(row[colMap.net] || '');
            const match = netStr.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              entry.net_amount_cents = Math.round(parseFloat(match[1].replace(/,/g, '')) * 100);
            }
          }

          // Parse hours
          if (colMap.hours !== undefined) {
            const hoursStr = String(row[colMap.hours] || '');
            const match = hoursStr.match(/([\d.]+)/);
            if (match) {
              entry.hours = parseFloat(match[1]);
            }
          }

          // Parse date for period info
          if (colMap.date !== undefined && !periodEnd) {
            const dateStr = String(row[colMap.date] || '');
            const dateMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
            if (dateMatch) {
              const year = dateMatch[3].length === 2 ? '20' + dateMatch[3] : dateMatch[3];
              periodEnd = `${year}-${dateMatch[1].padStart(2, '0')}-${dateMatch[2].padStart(2, '0')}`;
            }
          }

          // Only add entries with valid amounts
          if (entry.gross_amount_cents > 0 || entry.net_amount_cents > 0) {
            entries.push(entry);
          }
        }
      }

      // Calculate summary
      const totalGross = entries.reduce((sum, e) => sum + (e.gross_amount_cents || 0), 0);
      const totalHours = entries.reduce((sum, e) => sum + (e.hours || 0), 0);

      return {
        entries,
        detectedProvider,
        periodStart,
        periodEnd,
        summary: {
          employeeCount: entries.length,
          totalGrossCents: totalGross,
          totalHours: totalHours,
          avgGrossCents: entries.length > 0 ? Math.round(totalGross / entries.length) : 0
        }
      };
    }

    // Extract payroll data from PDF text
    function extractPayrollFromText(text, filename) {
      const entries = [];
      let detectedProvider = null;

      // Detect provider from text
      const lowerText = text.toLowerCase();
      if (lowerText.includes('adp')) detectedProvider = 'adp';
      else if (lowerText.includes('toast')) detectedProvider = 'toast';
      else if (lowerText.includes('gusto')) detectedProvider = 'gusto';
      else if (lowerText.includes('quickbooks')) detectedProvider = 'quickbooks';
      else if (lowerText.includes('paychex')) detectedProvider = 'paychex';

      // Look for dollar amounts that could be payroll totals
      const amountPattern = /(?:gross|net|total|pay|wages|earnings)[:\s]*\$?([\d,]+\.?\d*)/gi;
      let match;
      while ((match = amountPattern.exec(text)) !== null) {
        const amount = parseFloat(match[1].replace(/,/g, ''));
        if (amount > 100 && amount < 1000000) {
          entries.push({
            description: match[0].substring(0, 50),
            gross_amount_cents: Math.round(amount * 100)
          });
        }
      }

      // If no structured data found, look for any large dollar amounts
      if (entries.length === 0) {
        const simplePattern = /\$([\d,]+\.?\d*)/g;
        while ((match = simplePattern.exec(text)) !== null) {
          const amount = parseFloat(match[1].replace(/,/g, ''));
          if (amount > 500 && amount < 500000) {
            entries.push({
              description: 'Payroll amount from PDF',
              gross_amount_cents: Math.round(amount * 100)
            });
          }
        }
      }

      const totalGross = entries.reduce((sum, e) => sum + (e.gross_amount_cents || 0), 0);

      return {
        entries,
        detectedProvider,
        summary: {
          extractedAmounts: entries.length,
          totalGrossCents: totalGross,
          source: 'pdf'
        }
      };
    }
  </script>

  <!-- Proof Modal -->
  <div class="modal-overlay" id="proofModal" onclick="closeProofModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="proofModalTitle">Invoice Proof</div>
        <button class="modal-close" onclick="closeProofModal()">&times;</button>
      </div>
      <div class="modal-body" id="proofModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Location Breakdown Modal -->
  <div class="modal-overlay" id="locationModal" onclick="closeLocationModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">📍 Invoices by Location</div>
        <button class="modal-close" onclick="closeLocationModal()">&times;</button>
      </div>
      <div class="modal-body" id="locationModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Vendor/Location Drill-down Modal -->
  <div class="modal-overlay" id="drilldownModal" onclick="closeDrilldownModal(event)">
    <div class="modal-content" style="max-width: 1000px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="drilldownModalTitle">Vendor Details</div>
        <button class="modal-close" onclick="closeDrilldownModal()">&times;</button>
      </div>
      <div class="modal-body" id="drilldownModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Action Items Modal -->
  <div class="modal-overlay" id="actionItemsModal" onclick="closeActionItemsModal(event)">
    <div class="modal-content" style="max-width: 900px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span>⚡</span> Action Items
          <span style="font-size: 11px; font-weight: 600; color: #fbbf24; background: rgba(251, 191, 36, 0.1); padding: 2px 8px; border-radius: 10px;" id="modalActionBadge">5 Pending</span>
        </div>
        <button class="modal-close" onclick="closeActionItemsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="action-items" id="modalActionItems">
          <div class="action-item urgent">
            <div class="action-item-icon" style="background: rgba(239, 68, 68, 0.1);">🚨</div>
            <div class="action-item-content">
              <div class="action-item-title">Review Sysco invoice discrepancy</div>
              <div class="action-item-meta">Downtown • Invoice #4521 • Due today</div>
            </div>
            <div class="action-item-value">$847</div>
            <button class="action-item-btn">Review</button>
          </div>
          <div class="action-item high">
            <div class="action-item-icon" style="background: rgba(245, 158, 11, 0.1);">📞</div>
            <div class="action-item-content">
              <div class="action-item-title">Call US Foods rep about price lock</div>
              <div class="action-item-meta">Westside • Contract renewal • Due in 2 days</div>
            </div>
            <div class="action-item-value">$1,200</div>
            <button class="action-item-btn">Schedule</button>
          </div>
          <div class="action-item medium">
            <div class="action-item-icon" style="background: rgba(59, 130, 246, 0.1);">📊</div>
            <div class="action-item-content">
              <div class="action-item-title">Compare produce vendor quotes</div>
              <div class="action-item-meta">All locations • 3 quotes received • Due this week</div>
            </div>
            <div class="action-item-value">$2,100</div>
            <button class="action-item-btn">Compare</button>
          </div>
          <div class="action-item low">
            <div class="action-item-icon" style="background: rgba(100, 116, 139, 0.1);">📝</div>
            <div class="action-item-content">
              <div class="action-item-title">Update vendor contact list</div>
              <div class="action-item-meta">All locations • Routine task • Due next week</div>
            </div>
            <div class="action-item-value">--</div>
            <button class="action-item-btn">Update</button>
          </div>
          <div class="action-item low">
            <div class="action-item-icon" style="background: rgba(100, 116, 139, 0.1);">📋</div>
            <div class="action-item-content">
              <div class="action-item-title">Review quarterly contract terms</div>
              <div class="action-item-meta">Downtown • Q1 review • Due next week</div>
            </div>
            <div class="action-item-value">--</div>
            <button class="action-item-btn">Review</button>
          </div>
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 13px; color: var(--muted);">Total Potential Savings: <span style="color: #22c55e; font-weight: 700;">$4,147</span></div>
          <button class="btn" style="background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: #1a1a1a; border: none;">View All Action Items</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Smart Actions Executed Modal -->
  <div class="modal-overlay" id="actionsExecutedModal" onclick="closeActionsExecutedModal(event)">
    <div class="modal-content" style="max-width: 1000px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span>💰</span> Smart Recommendations Executed
          <span class="verified-badge" style="font-size: 10px; background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 4px 10px; border-radius: 20px; font-weight: 700;">Invoice Verified</span>
        </div>
        <button class="modal-close" onclick="closeActionsExecutedModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="actions-results-summary" style="display: flex; gap: 24px; margin-bottom: 24px; padding: 16px; background: var(--panel2); border-radius: 12px;">
          <div class="actions-summary-stat" style="text-align: center;">
            <div class="actions-summary-value" style="font-size: 32px; font-weight: 800; color: var(--gold);" id="modalActionsCount">12</div>
            <div class="actions-summary-label" style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Actions Taken</div>
          </div>
          <div class="actions-summary-stat" style="text-align: center;">
            <div class="actions-summary-value" style="font-size: 32px; font-weight: 800; color: #22c55e;" id="modalSuccessRate">92%</div>
            <div class="actions-summary-label" style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Success Rate</div>
          </div>
          <div class="actions-summary-stat" style="text-align: center; flex: 1;">
            <div class="actions-summary-value" style="font-size: 32px; font-weight: 800; color: #22c55e;" id="modalTotalSavings">$6,287</div>
            <div class="actions-summary-label" style="font-size: 11px; color: var(--muted); text-transform: uppercase;">Total Verified Savings</div>
          </div>
        </div>

        <div class="actions-results-grid" id="modalActionsResultsGrid">
          <!-- Action Result 1 -->
          <div class="action-result-card">
            <div class="action-result-icon">🔄</div>
            <div class="action-result-details">
              <div class="action-result-name">Switched to bulk ordering for chicken breast</div>
              <div class="action-result-recommendation">Smart Recommendation: "Order 40lb cases instead of 10lb for 18% savings"</div>
              <div class="action-result-meta">
                <span>📍 Downtown Location</span>
                <span>📅 Executed Jan 3, 2026</span>
                <span>📄 Verified on 3 invoices</span>
              </div>
              <div class="action-result-timeline">
                <span class="timeline-label">Tracking: 4 weeks</span>
                <div class="timeline-bar">
                  <div class="timeline-progress" style="width: 100%;"></div>
                </div>
                <span class="timeline-label">Complete</span>
              </div>
            </div>
            <div class="action-result-impact">
              <div class="action-result-savings">+$1,847</div>
              <div class="action-result-verified">✓ Verified Savings</div>
            </div>
          </div>

          <!-- Action Result 2 -->
          <div class="action-result-card">
            <div class="action-result-icon">📦</div>
            <div class="action-result-details">
              <div class="action-result-name">Changed produce delivery to 2x/week</div>
              <div class="action-result-recommendation">Smart Recommendation: "Reduce delivery frequency to cut fees by $120/week"</div>
              <div class="action-result-meta">
                <span>📍 All Locations</span>
                <span>📅 Executed Dec 15, 2025</span>
                <span>📄 Verified on 8 invoices</span>
              </div>
              <div class="action-result-timeline">
                <span class="timeline-label">Tracking: 5 weeks</span>
                <div class="timeline-bar">
                  <div class="timeline-progress" style="width: 100%;"></div>
                </div>
                <span class="timeline-label">Complete</span>
              </div>
            </div>
            <div class="action-result-impact">
              <div class="action-result-savings">+$2,340</div>
              <div class="action-result-verified">✓ Verified Savings</div>
            </div>
          </div>

          <!-- Action Result 3 -->
          <div class="action-result-card">
            <div class="action-result-icon">💲</div>
            <div class="action-result-details">
              <div class="action-result-name">Negotiated price match with Sysco</div>
              <div class="action-result-recommendation">Smart Recommendation: "US Foods offering 12% lower price on dairy - negotiate match"</div>
              <div class="action-result-meta">
                <span>📍 Westside Branch</span>
                <span>📅 Executed Jan 8, 2026</span>
                <span>📄 Verified on 2 invoices</span>
              </div>
              <div class="action-result-timeline">
                <span class="timeline-label">Tracking: 2 weeks</span>
                <div class="timeline-bar">
                  <div class="timeline-progress" style="width: 50%;"></div>
                </div>
                <span class="timeline-label">In Progress</span>
              </div>
            </div>
            <div class="action-result-impact">
              <div class="action-result-savings">+$680</div>
              <div class="action-result-verified">✓ Partial Verified</div>
            </div>
          </div>

          <!-- Action Result 4 -->
          <div class="action-result-card">
            <div class="action-result-icon">🎯</div>
            <div class="action-result-details">
              <div class="action-result-name">Adjusted par levels based on sales data</div>
              <div class="action-result-recommendation">Smart Recommendation: "Reduce beef order by 15% - consistent overstock detected"</div>
              <div class="action-result-meta">
                <span>📍 Airport Store</span>
                <span>📅 Executed Dec 20, 2025</span>
                <span>📄 Verified on 6 invoices</span>
              </div>
              <div class="action-result-timeline">
                <span class="timeline-label">Tracking: 4 weeks</span>
                <div class="timeline-bar">
                  <div class="timeline-progress" style="width: 100%;"></div>
                </div>
                <span class="timeline-label">Complete</span>
              </div>
            </div>
            <div class="action-result-impact">
              <div class="action-result-savings">+$1,420</div>
              <div class="action-result-verified">✓ Verified Savings</div>
            </div>
          </div>
        </div>

        <div class="actions-total-impact" style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div class="total-impact-label" style="font-size: 14px; font-weight: 700; color: var(--text);">Total Verified Impact from Your Actions</div>
            <div style="font-size: 12px; color: #64748b; margin-top: 2px;">Measured from invoice data after executing recommendations</div>
          </div>
          <div class="total-impact-badge" style="display: flex; align-items: center; gap: 8px;">
            <span class="total-impact-value" style="font-size: 28px; font-weight: 800; color: #22c55e;">$6,287</span>
            <span style="color: #22c55e; font-size: 12px;">↑ Real savings</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Intent Signals Modal -->
  <div class="modal-overlay" id="intentSignalsModal" onclick="closeIntentSignalsModal(event)">
    <div class="modal-content" style="max-width: 1100px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">📡</span> Intent Signals
          <span class="verified-badge" style="font-size: 10px; background: rgba(249, 115, 22, 0.15); color: #f97316; padding: 4px 10px; border-radius: 20px; font-weight: 700;">Live Monitoring</span>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button class="btn" onclick="openIntentConfigModal()" style="background: var(--panel2); font-size: 12px; padding: 8px 14px;">Configure</button>
          <button class="btn" onclick="generateDemoIntentSignals()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none; font-size: 12px; padding: 8px 14px;">Generate Demo Signals</button>
          <button class="modal-close" onclick="closeIntentSignalsModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <!-- Summary Stats -->
        <div class="actions-results-summary" style="display: flex; gap: 24px; margin-bottom: 24px; padding: 16px; background: var(--panel2); border-radius: 12px;">
          <div class="intent-summary-stat">
            <div class="intent-summary-value" style="color: #f97316;" id="modalIntentNew">0</div>
            <div class="intent-summary-label">New Signals</div>
          </div>
          <div class="intent-summary-stat">
            <div class="intent-summary-value" style="color: #ef4444;" id="modalIntentCritical">0</div>
            <div class="intent-summary-label">Critical</div>
          </div>
          <div class="intent-summary-stat">
            <div class="intent-summary-value" style="color: #eab308;" id="modalIntentHigh">0</div>
            <div class="intent-summary-label">High Priority</div>
          </div>
          <div class="intent-summary-stat" style="flex: 1.5;">
            <div class="intent-summary-value" style="color: #22c55e;" id="modalIntentContacted">0%</div>
            <div class="intent-summary-label">Response Rate</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="intent-filters">
          <button class="intent-filter-btn active" data-filter="all" onclick="filterIntentSignals('all')">All</button>
          <button class="intent-filter-btn" data-filter="critical" onclick="filterIntentSignals('critical')">Critical</button>
          <button class="intent-filter-btn" data-filter="high" onclick="filterIntentSignals('high')">High</button>
          <button class="intent-filter-btn" data-filter="new" onclick="filterIntentSignals('new')">New</button>
          <button class="intent-filter-btn" data-filter="contacted" onclick="filterIntentSignals('contacted')">Contacted</button>
        </div>

        <!-- Signals Grid -->
        <div class="intent-signals-grid" id="intentSignalsGrid">
          <div class="intent-empty-state">
            <h3>No Intent Signals Yet</h3>
            <p>Configure your keywords and zip codes to start monitoring for buyer intent.</p>
            <button class="btn" onclick="openIntentConfigModal()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none;">Configure Keywords</button>
          </div>
        </div>

        <!-- Total Impact Footer -->
        <div class="actions-total-impact" style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div class="total-impact-label" style="font-size: 14px; font-weight: 700; color: var(--text);">Intent Signal Performance</div>
            <div style="font-size: 12px; color: #64748b; margin-top: 2px;">Signals expire after 48 hours - act fast on critical leads</div>
          </div>
          <div class="total-impact-badge" style="display: flex; align-items: center; gap: 16px;">
            <div style="text-align: center;">
              <div style="font-size: 18px; font-weight: 800; color: #f97316;" id="modalIntentAvgScore">--</div>
              <div style="font-size: 10px; color: #64748b;">Avg Score</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 18px; font-weight: 800; color: #22c55e;" id="modalIntentWonValue">$0</div>
              <div style="font-size: 10px; color: #64748b;">Won Value</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Intent Signal Configuration Modal -->
  <div class="modal-overlay" id="intentConfigModal" onclick="closeIntentConfigModal(event)">
    <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span>⚙️</span> Configure Intent Signals
        </div>
        <button class="modal-close" onclick="closeIntentConfigModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="intentConfigForm" onsubmit="saveIntentConfig(event)">
          <div style="display: grid; gap: 20px;">
            <div>
              <label style="display: block; font-size: 13px; color: var(--text); margin-bottom: 8px; font-weight: 600;">Configuration Name</label>
              <input type="text" id="configName" required placeholder="e.g., Restaurant Equipment Leads" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
            </div>

            <div>
              <label style="display: block; font-size: 13px; color: var(--text); margin-bottom: 8px; font-weight: 600;">Keywords to Monitor</label>
              <textarea id="configKeywords" rows="4" required placeholder="Enter keywords (one per line):&#10;restaurant equipment&#10;commercial kitchen&#10;food service supplies&#10;pos system" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; resize: vertical;"></textarea>
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">One keyword per line. More specific keywords = higher quality matches.</div>
            </div>

            <div>
              <label style="display: block; font-size: 13px; color: var(--text); margin-bottom: 8px; font-weight: 600;">Target Zip Codes</label>
              <input type="text" id="configZipCodes" required placeholder="e.g., 90210, 90211, 90212" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;">
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Comma-separated zip codes for your target territory.</div>
            </div>

            <div style="padding: 16px; background: rgba(249, 115, 22, 0.08); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 8px;">
              <div style="font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 12px;">Notification Preferences</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notifyCritical" checked style="width: 16px; height: 16px; accent-color: #f97316;">
                  <span style="font-size: 13px; color: var(--text);">Critical signals</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notifyHigh" checked style="width: 16px; height: 16px; accent-color: #f97316;">
                  <span style="font-size: 13px; color: var(--text);">High priority</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notifyMedium" style="width: 16px; height: 16px; accent-color: #f97316;">
                  <span style="font-size: 13px; color: var(--text);">Medium priority</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="notifyLow" style="width: 16px; height: 16px; accent-color: #f97316;">
                  <span style="font-size: 13px; color: var(--text);">Low priority</span>
                </label>
              </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px;">
              <button type="button" class="btn" onclick="closeIntentConfigModal()" style="background: var(--panel2);">Cancel</button>
              <button type="submit" class="btn" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none;">Save Configuration</button>
            </div>
          </div>
        </form>
        <div id="intentConfigStatus" style="margin-top: 12px; display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Manual Payroll Entry Modal -->
  <div class="modal-overlay" id="manualPayrollModal" onclick="closeManualPayrollModal(event)">
    <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span>💵</span> Manual Payroll Entry
        </div>
        <button class="modal-close" onclick="closeManualPayrollModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="payrollForm" onsubmit="submitPayroll(event)">
          <div style="display: grid; gap: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period Start</label>
                <input type="date" id="payrollStart" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period End</label>
                <input type="date" id="payrollEnd" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
            </div>
            <div>
              <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Gross Payroll ($)</label>
              <input type="number" id="grossPayroll" step="0.01" min="0" required placeholder="e.g. 15000.00" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Employee Count</label>
                <input type="number" id="employeeCount" min="1" placeholder="e.g. 12" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Total Hours</label>
                <input type="number" id="totalHours" step="0.5" min="0" placeholder="e.g. 480" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
            </div>
            <div>
              <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Notes (optional)</label>
              <textarea id="payrollNotes" rows="2" placeholder="Any additional notes..." style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" class="btn" onclick="viewPayrollHistory()" style="background: var(--panel2);">View History</button>
              <button type="submit" class="btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none;">Save Payroll Entry</button>
            </div>
          </div>
        </form>
        <div id="payrollStatus" style="margin-top: 12px; display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Manual Expense Entry Modal -->
  <div class="modal-overlay" id="manualExpenseModal" onclick="closeManualExpenseModal(event)">
    <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
          <span>🧾</span> Manual Expense Entry
        </div>
        <button class="modal-close" onclick="closeManualExpenseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="expenseForm" onsubmit="submitExpense(event)">
          <div style="display: grid; gap: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Category</label>
                <select id="expenseCategory" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  <option value="">Select category...</option>
                  <option value="inventory">Inventory / Supplies</option>
                  <option value="utilities">Utilities</option>
                  <option value="rent">Rent / Lease</option>
                  <option value="insurance">Insurance</option>
                  <option value="marketing">Marketing</option>
                  <option value="equipment">Equipment</option>
                  <option value="professional">Professional Services</option>
                  <option value="technology">Technology / Software</option>
                  <option value="travel">Travel</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Date</label>
                <input type="date" id="expenseDate" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
              </div>
            </div>
            <div>
              <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Amount ($)</label>
              <input type="number" id="expenseAmount" step="0.01" min="0" required placeholder="e.g. 1500.00" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
            </div>
            <div>
              <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Vendor / Description</label>
              <input type="text" id="expenseVendor" placeholder="e.g. Electric Company - Monthly Bill" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
            </div>
            <div>
              <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Notes (optional)</label>
              <textarea id="expenseNotes" rows="2" placeholder="Any additional notes..." style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" class="btn" onclick="viewExpenseHistory()" style="background: var(--panel2);">View History</button>
              <button type="submit" class="btn" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; color: #1a1a1a;">Save Expense Entry</button>
            </div>
          </div>
        </form>
        <div id="expenseStatus" style="margin-top: 12px; display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // PROOF MODAL FUNCTIONS
    // ========================================

    function showProof(issueData) {
      const modal = document.getElementById('proofModal');
      const title = document.getElementById('proofModalTitle');
      const body = document.getElementById('proofModalBody');

      title.textContent = `Proof: ${issueData.vendorName} - ${issueData.issueType}`;

      // Generate proof content with highlighted invoice preview
      body.innerHTML = `
        <div class="proof-summary">
          <div class="proof-stat">
            <div class="proof-stat-label">You're Being Charged</div>
            <div class="proof-stat-value">${formatMoney(issueData.currentChargeCents)}</div>
          </div>
          <div class="proof-stat">
            <div class="proof-stat-label">Should Be</div>
            <div class="proof-stat-value savings">${formatMoney(issueData.expectedChargeCents)}</div>
          </div>
          <div class="proof-stat">
            <div class="proof-stat-label">Your Savings</div>
            <div class="proof-stat-value delta">${formatMoney(issueData.deltaCents)}</div>
          </div>
        </div>

        <div class="invoice-preview">
          <div class="invoice-header">
            <div class="invoice-vendor">${issueData.vendorName}</div>
            <div class="invoice-meta">Invoice Date: ${formatDate(issueData.invoiceDate)} • Location: ${issueData.locationName}</div>
          </div>

          <div style="margin-top: 16px;">
            ${generateInvoiceLines(issueData)}
          </div>
        </div>

        <div class="issue-explanation">
          <div class="explanation-title">
            <span>💡</span>
            What We Found
          </div>
          <div class="explanation-text">
            ${generateExplanation(issueData)}
          </div>
          <div class="explanation-action">
            <strong>Recommended Action:</strong> ${generateRecommendation(issueData)}
          </div>
        </div>
      `;

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeProofModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('proofModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function generateInvoiceLines(issue) {
      // Generate sample invoice lines with the flagged item highlighted
      const lines = [];

      // Add some context lines before the flagged item
      lines.push(`
        <div class="invoice-line">
          <div class="line-desc">Standard Service Fee</div>
          <div class="line-qty">1 x</div>
          <div class="line-amount">$45.00</div>
        </div>
      `);

      // The flagged line item
      lines.push(`
        <div class="invoice-line highlighted">
          <div>
            <div class="line-desc">${issue.itemDescription || issue.issueType}</div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ${issue.sku || 'SKU: N/A'} • ${issue.locationName}
            </div>
          </div>
          <div class="line-qty">${issue.quantity || 1} x</div>
          <div>
            <div class="line-amount flagged">${formatMoney(issue.currentChargeCents)}</div>
            <div class="line-expected">Should be: ${formatMoney(issue.expectedChargeCents)}</div>
          </div>
        </div>
      `);

      // Add a line after
      lines.push(`
        <div class="invoice-line">
          <div class="line-desc">Delivery/Handling</div>
          <div class="line-qty">1 x</div>
          <div class="line-amount">$25.00</div>
        </div>
      `);

      // Total line
      const total = (issue.currentChargeCents / 100) + 70; // sample total
      lines.push(`
        <div class="invoice-line" style="border-bottom: none; margin-top: 12px; padding-top: 12px; border-top: 2px solid #1a1a1a;">
          <div class="line-desc" style="font-weight: 700;">TOTAL</div>
          <div></div>
          <div class="line-amount" style="font-size: 16px;">$${total.toFixed(2)}</div>
        </div>
      `);

      return lines.join('');
    }

    function generateExplanation(issue) {
      const typeExplanations = {
        'price_increase': `We detected a <strong>price increase</strong> on this line item compared to your contract or historical pricing. The vendor is charging ${formatMoney(issue.currentChargeCents)} but based on your agreement, it should be ${formatMoney(issue.expectedChargeCents)}.`,
        'overcharge': `This item is being <strong>overcharged</strong> by ${formatMoney(issue.deltaCents)}. Our analysis compared this against your MLA contract pricing and found a discrepancy.`,
        'quantity_error': `We found a <strong>quantity discrepancy</strong>. The invoice shows more units than what was actually delivered or ordered.`,
        'duplicate_charge': `This appears to be a <strong>duplicate charge</strong>. We found a similar line item on a previous invoice within this billing cycle.`,
        'contract_violation': `This charge <strong>violates your contract terms</strong>. Based on your MLA, this item should be priced at ${formatMoney(issue.expectedChargeCents)}.`,
        'default': `We identified a pricing discrepancy of <strong>${formatMoney(issue.deltaCents)}</strong> on this invoice. The current charge of ${formatMoney(issue.currentChargeCents)} exceeds the expected amount of ${formatMoney(issue.expectedChargeCents)}.`
      };

      return typeExplanations[issue.issueType] || typeExplanations['default'];
    }

    function generateRecommendation(issue) {
      const recommendations = {
        'price_increase': 'Contact your vendor representative and reference your contract pricing. Request a credit memo for the overcharge.',
        'overcharge': 'File a dispute with your vendor citing the contract rate. Include this proof documentation.',
        'quantity_error': 'Verify delivery receipts and request an invoice adjustment for the correct quantity.',
        'duplicate_charge': 'Contact accounts payable at the vendor and request removal of the duplicate charge.',
        'contract_violation': 'Escalate to your account manager with your MLA documentation. Request immediate correction.',
        'default': 'Review with your vendor and request a credit for the difference. Keep this proof for your records.'
      };

      return recommendations[issue.issueType] || recommendations['default'];
    }

    // ========================================
    // LOCATION MODAL FUNCTIONS
    // ========================================

    function showLocationBreakdown() {
      const modal = document.getElementById('locationModal');
      const body = document.getElementById('locationModalBody');

      body.innerHTML = '<div class="loadingState">Loading location data...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load location data
      loadLocationModalData();
    }

    async function loadLocationModalData() {
      const body = document.getElementById('locationModalBody');

      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/locations?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          body.innerHTML = '<div class="emptyState">No location data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.invoicesCount - a.invoicesCount);

        const html = `
          <div style="margin-bottom: 20px; padding: 16px; background: var(--panel2); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Total Locations</div>
              <div style="font-size: 28px; font-weight: 800; color: var(--text-bright);">${sorted.length}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Total Invoices</div>
              <div style="font-size: 28px; font-weight: 800; color: var(--gold);">${sorted.reduce((sum, r) => sum + (r.invoicesCount || 0), 0).toLocaleString()}</div>
            </div>
          </div>

          <div class="location-list">
            ${sorted.map((row, idx) => `
              <div class="location-item">
                <div>
                  <div class="location-name">
                    <span style="color: var(--muted); margin-right: 8px;">#${idx + 1}</span>
                    ${row.name}
                  </div>
                  <div class="location-meta">
                    ${row.issuesCount || 0} flagged issues • ${formatMoney(row.amountCents || 0)} potential savings
                  </div>
                </div>
                <div class="location-stats">
                  <div class="location-invoices">${(row.invoicesCount || 0).toLocaleString()}</div>
                  <div class="location-savings">invoices analyzed</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        body.innerHTML = html;
      } catch (error) {
        body.innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load locations</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    function closeLocationModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('locationModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeProofModal();
        closeLocationModal();
        closeDrilldownModal();
      }
    });

    // ========================================
    // VENDOR/LOCATION DRILL-DOWN FUNCTIONS
    // ========================================

    async function showVendorDrilldown(vendorData) {
      const modal = document.getElementById('drilldownModal');
      const title = document.getElementById('drilldownModalTitle');
      const body = document.getElementById('drilldownModalBody');

      title.innerHTML = `<span style="color: var(--muted);">🏢</span> ${vendorData.name}`;
      body.innerHTML = '<div class="loadingState">Loading vendor details...</div>';

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load issues for this vendor
      await loadDrilldownContent('vendor', vendorData);
    }

    async function showLocationDrilldown(locationData) {
      const modal = document.getElementById('drilldownModal');
      const title = document.getElementById('drilldownModalTitle');
      const body = document.getElementById('drilldownModalBody');

      title.innerHTML = `<span style="color: var(--muted);">📍</span> ${locationData.name}`;
      body.innerHTML = '<div class="loadingState">Loading location details...</div>';

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load issues for this location
      await loadDrilldownContent('location', locationData);
    }

    async function loadDrilldownContent(type, data) {
      const body = document.getElementById('drilldownModalBody');

      try {
        // Fetch issues filtered by vendor or location
        const filterParam = type === 'vendor' ? `vendorName=${encodeURIComponent(data.name)}` : `locationName=${encodeURIComponent(data.name)}`;
        const issuesData = await fetchAPI(`/api/dashboard/issues?${buildQueryString(filters)}&${filterParam}`);
        const issues = issuesData.rows || [];

        // Calculate summary stats
        const totalSavings = issues.reduce((sum, i) => sum + (i.deltaCents || 0), 0);
        const highConfidence = issues.filter(i => i.confidence === 'HIGH').length;

        // Build drill-down content
        body.innerHTML = `
          <div class="drilldown-header">
            <div>
              <div class="drilldown-title">${data.name}</div>
              <div class="drilldown-subtitle">
                ${type === 'vendor' ? 'Vendor' : 'Location'} • ${data.invoicesCount || 0} invoices analyzed
              </div>
            </div>
            <div class="drilldown-stats">
              <div class="drilldown-stat">
                <div class="drilldown-stat-value">${formatMoney(data.amountCents || totalSavings)}</div>
                <div class="drilldown-stat-label">Potential Savings</div>
              </div>
              <div class="drilldown-stat">
                <div class="drilldown-stat-value" style="color: var(--text);">${issues.length}</div>
                <div class="drilldown-stat-label">Flagged Issues</div>
              </div>
              <div class="drilldown-stat">
                <div class="drilldown-stat-value" style="color: #10b981;">${highConfidence}</div>
                <div class="drilldown-stat-label">High Confidence</div>
              </div>
            </div>
          </div>

          ${issues.length > 0 ? `
            <div class="drilldown-tabs">
              <button class="drilldown-tab active" onclick="filterDrilldownIssues('all', this)">All Issues (${issues.length})</button>
              <button class="drilldown-tab" onclick="filterDrilldownIssues('high', this)">High Confidence (${highConfidence})</button>
              <button class="drilldown-tab" onclick="filterDrilldownIssues('price', this)">Price Issues</button>
              <button class="drilldown-tab" onclick="filterDrilldownIssues('overcharge', this)">Overcharges</button>
            </div>

            <div class="drilldown-issues" id="drilldownIssuesList">
              ${renderDrilldownIssues(issues)}
            </div>
          ` : `
            <div class="emptyState" style="padding: 48px;">
              <div style="font-size: 48px; margin-bottom: 16px;">✨</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Issues Found</div>
              <div style="color: var(--muted);">All invoices from this ${type} are within expected pricing.</div>
            </div>
          `}
        `;

        // Store issues for filtering
        window.currentDrilldownIssues = issues;
      } catch (error) {
        body.innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load details</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    function renderDrilldownIssues(issues) {
      if (!issues || issues.length === 0) {
        return '<div class="emptyState">No issues match this filter</div>';
      }

      return issues.map((issue, idx) => `
        <div class="drilldown-issue" data-confidence="${issue.confidence}" data-type="${issue.issueType}">
          <div class="issue-info">
            <div class="issue-type">
              ${formatIssueType(issue.issueType)}
              <span class="badge ${issue.confidence === 'HIGH' ? 'badge-good' : 'badge-neutral'}" style="margin-left: 8px;">
                ${issue.confidence}
              </span>
            </div>
            <div class="issue-meta">
              ${issue.vendorName || ''} ${issue.locationName ? '• ' + issue.locationName : ''} • Invoice: ${formatDate(issue.invoiceDate)}
            </div>
          </div>
          <div class="issue-amount">
            <div class="issue-current">${formatMoney(issue.currentChargeCents)}</div>
            <div class="issue-delta">Save ${formatMoney(issue.deltaCents)}</div>
          </div>
          <button class="btn-proof" onclick="showProofFromDrilldown(${idx})">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            See Proof
          </button>
        </div>
      `).join('');
    }

    function filterDrilldownIssues(filter, btn) {
      // Update active tab
      document.querySelectorAll('.drilldown-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      const issues = window.currentDrilldownIssues || [];
      let filtered = issues;

      switch (filter) {
        case 'high':
          filtered = issues.filter(i => i.confidence === 'HIGH');
          break;
        case 'price':
          filtered = issues.filter(i => i.issueType?.includes('price') || i.issueType?.includes('increase'));
          break;
        case 'overcharge':
          filtered = issues.filter(i => i.issueType?.includes('overcharge') || i.issueType?.includes('charge'));
          break;
      }

      document.getElementById('drilldownIssuesList').innerHTML = renderDrilldownIssues(filtered);
    }

    function showProofFromDrilldown(idx) {
      const issues = window.currentDrilldownIssues || [];
      if (issues[idx]) {
        showProof(issues[idx]);
      }
    }

    function closeDrilldownModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('drilldownModal').classList.remove('active');
      document.body.style.overflow = '';
    }
  </script>
</body>
</html>
