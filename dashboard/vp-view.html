<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Dashboard - Revenue Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       PREMIUM EXECUTIVE DASHBOARD STYLES
       Revenue Radar - Business Dashboard
       ======================================== */

    :root {
      /* Premium Dark Palette */
      --bg: #0a0f1a;
      --bg-gradient: linear-gradient(135deg, #0a0f1a 0%, #0f172a 100%);
      --panel: #111525;
      --panel2: #0f1320;
      --panel-glass: rgba(17, 21, 37, 0.7);

      /* Borders & Dividers */
      --border: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(251, 191, 36, 0.25);
      --border-gold: rgba(251, 191, 36, 0.3);

      /* Text */
      --text: rgba(255, 255, 255, 0.95);
      --text-bright: #ffffff;
      --muted: rgba(255, 255, 255, 0.7);
      --muted2: rgba(255, 255, 255, 0.5);

      /* Gold Accents */
      --gold: #fbbf24;
      --gold-dark: #f59e0b;
      --gold-darker: #d97706;
      --gold-glow: rgba(251, 191, 36, 0.15);

      /* Status Colors */
      --good: rgba(120, 255, 190, 0.18);
      --warn: rgba(255, 210, 120, 0.18);
      --error: rgba(255, 90, 90, 0.18);
    }

    /* ========================================
       BASE RESET & TYPOGRAPHY
       ======================================== */

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      margin: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at top, rgba(30, 41, 59, 0.3) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(30, 58, 138, 0.1) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text);
      line-height: 1.5;
    }

    /* ========================================
       LAYOUT
       ======================================== */

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .pageBody {
      width: min(1400px, 94vw);
      margin: 24px auto 48px;
      display: grid;
      gap: 20px;
    }

    /* ========================================
       HEADER
       ======================================== */

    .header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .headerTitle {
      font-size: 24px;
      letter-spacing: 0.3px;
      font-weight: 800;
      color: var(--text-bright);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      margin-bottom: 8px;
    }

    .headerSub {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .headerRight {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* ========================================
       CARDS
       ======================================== */

    .card {
      background: linear-gradient(135deg, rgba(17, 21, 37, 0.6) 0%, rgba(15, 19, 32, 0.8) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 1px 4px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      border-color: var(--border-hover);
      box-shadow:
        0 6px 24px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    /* ========================================
       METRICS ROW
       ======================================== */

    .metricsRow {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 18px;
    }

    .metricTile {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px 18px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .metricTile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold) 0%, var(--gold-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .metricTile:hover {
      border-color: var(--border-gold);
      background: rgba(15, 23, 42, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(251, 191, 36, 0.15);
    }

    .metricTile:hover::before {
      opacity: 1;
    }

    .metricLabel {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .metricValue {
      font-size: 28px;
      font-weight: 900;
      color: var(--text-bright);
      margin-top: 8px;
      letter-spacing: 0.3px;
      line-height: 1.2;
      font-family: 'Montserrat', 'Inter', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .metricSub {
      font-size: 12px;
      color: var(--muted2);
      font-weight: 700;
      margin-top: 8px;
      opacity: 0.75;
    }

    /* ========================================
       GRID LAYOUTS
       ======================================== */

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* ========================================
       SECTION HEADERS
       ======================================== */

    .sectionHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .sectionTitle {
      font-size: 14px;
      font-weight: 800;
      color: var(--text-bright);
      letter-spacing: 0.3px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    /* ========================================
       BREAKDOWN LISTS
       ======================================== */

    .breakdownList {
      display: grid;
      gap: 10px;
    }

    .breakdownRow {
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .breakdownRow:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.05);
      transform: translateX(3px);
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.1);
    }

    .breakdownRow-active {
      outline: 2px solid var(--border-gold);
      outline-offset: -1px;
      background: rgba(251, 191, 36, 0.08);
    }

    .breakdownLeft {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }

    .breakdownRank {
      width: 22px;
      color: var(--muted2);
      font-size: 13px;
      font-weight: 800;
      text-align: center;
    }

    .breakdownName {
      font-size: 14px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text);
    }

    .breakdownRight {
      text-align: right;
    }

    .breakdownAmount {
      font-weight: 800;
      font-size: 15px;
      color: var(--text-bright);
    }

    .breakdownMeta {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 4px;
      font-weight: 600;
    }

    /* ========================================
       TABLES
       ======================================== */

    .tableWrap {
      overflow-x: auto;
      border-radius: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--border);
      padding: 14px 12px;
      vertical-align: middle;
      transition: background 0.2s;
    }

    .table th {
      color: var(--muted);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.2);
    }

    .table tbody tr:hover {
      background: rgba(251, 191, 36, 0.03);
    }

    .cellMain {
      font-weight: 700;
      color: var(--text-bright);
    }

    .num {
      text-align: right;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .clickable {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }

    .clickable:hover {
      color: var(--gold);
    }

    /* ========================================
       BUTTONS
       ======================================== */

    .btn {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.08);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
    }

    .btn-ghost {
      background: transparent;
      box-shadow: none;
    }

    /* ========================================
       FORM INPUTS
       ======================================== */

    .select {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }

    .select:hover,
    .select:focus {
      border-color: var(--border-gold);
      background: rgba(255, 255, 255, 0.05);
      outline: none;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    input[type="date"] {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      color-scheme: dark;
    }

    input[type="date"]:hover,
    input[type="date"]:focus {
      border-color: var(--border-gold);
      background: rgba(255, 255, 255, 0.05);
      outline: none;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    /* ========================================
       BADGES
       ======================================== */

    .badge {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-neutral {
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
    }

    .badge-good {
      background: var(--good);
      border-color: rgba(120, 255, 190, 0.3);
      color: rgba(120, 255, 190, 0.95);
    }

    .badge-warn {
      background: var(--warn);
      border-color: rgba(255, 210, 120, 0.3);
      color: rgba(255, 210, 120, 0.95);
    }

    /* ========================================
       STATES
       ======================================== */

    .emptyState {
      color: var(--muted);
      font-size: 13px;
      padding: 24px 16px;
      text-align: center;
      font-weight: 600;
    }

    .errorState {
      border: 1px solid rgba(255, 90, 90, 0.4);
      background: rgba(255, 90, 90, 0.08);
      padding: 16px;
      border-radius: 14px;
    }

    .errorTitle {
      font-weight: 800;
      margin-bottom: 8px;
      color: rgba(255, 90, 90, 0.95);
    }

    .errorMsg {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .loadingState {
      color: var(--muted);
      font-size: 13px;
      padding: 24px 16px;
      text-align: center;
      font-weight: 600;
    }

    /* ========================================
       CLICKABLE METRIC TILES
       ======================================== */

    .metricTile.clickable {
      cursor: pointer;
    }

    .metricTile.clickable .metricSub {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metricTile.clickable .metricSub::after {
      content: '‚Üí';
      opacity: 0;
      transform: translateX(-4px);
      transition: all 0.2s ease;
    }

    .metricTile.clickable:hover .metricSub::after {
      opacity: 1;
      transform: translateX(0);
    }

    /* ========================================
       SEE PROOF BUTTON
       ======================================== */

    .btn-proof {
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-proof:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    /* ========================================
       PROOF MODAL
       ======================================== */

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 1;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      font-size: 24px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      padding: 24px;
    }

    /* Proof Details */
    .proof-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .proof-stat {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .proof-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .proof-stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .proof-stat-value.savings {
      color: #10b981;
    }

    .proof-stat-value.delta {
      color: var(--gold);
    }

    /* Invoice Preview */
    .invoice-preview {
      background: #ffffff;
      border-radius: 8px;
      padding: 24px;
      color: #1a1a1a;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .invoice-header {
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 16px;
      margin-bottom: 16px;
    }

    .invoice-vendor {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a1a;
    }

    .invoice-meta {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
    }

    .invoice-line {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 16px;
      padding: 8px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .invoice-line.highlighted {
      background: linear-gradient(90deg, rgba(251, 191, 36, 0.3) 0%, rgba(251, 191, 36, 0.1) 100%);
      margin: 0 -12px;
      padding: 12px;
      border: 2px solid #f59e0b;
      border-radius: 6px;
      position: relative;
    }

    .invoice-line.highlighted::before {
      content: '‚ö†Ô∏è FLAGGED';
      position: absolute;
      top: -10px;
      left: 12px;
      background: #f59e0b;
      color: #1a1a1a;
      font-size: 10px;
      font-weight: 800;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .line-desc {
      font-weight: 500;
    }

    .line-qty {
      color: #6b7280;
    }

    .line-amount {
      font-weight: 700;
      text-align: right;
    }

    .line-amount.flagged {
      color: #dc2626;
      text-decoration: line-through;
    }

    .line-expected {
      color: #059669;
      font-weight: 700;
    }

    /* Issue Explanation */
    .issue-explanation {
      background: var(--panel2);
      border: 1px solid var(--border-gold);
      border-radius: 12px;
      padding: 20px;
    }

    .explanation-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--gold);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .explanation-text {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .explanation-action {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .explanation-action strong {
      color: var(--text);
    }

    /* Location Modal */
    .location-list {
      display: grid;
      gap: 12px;
    }

    .location-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .location-item:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.05);
    }

    .location-name {
      font-weight: 700;
      color: var(--text);
    }

    .location-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .location-stats {
      text-align: right;
    }

    .location-invoices {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-bright);
    }

    .location-savings {
      font-size: 12px;
      color: #10b981;
      font-weight: 600;
    }

    /* ========================================
       RESPONSIVE DESIGN
       ======================================== */

    @media (max-width: 1100px) {
      .metricsRow {
        grid-template-columns: 1fr 1fr;
      }
      .grid2 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .pageBody {
        width: 96vw;
        gap: 16px;
      }

      .header {
        padding: 14px 16px;
      }

      .metricsRow {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 16px;
      }

      .tableWrap {
        overflow-x: auto;
      }
    }

    /* Trial Banner Styles */
    .trial-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #1a1a1a;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
      display: none;
    }

    .trial-banner.warning {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .trial-banner-text {
      font-size: 15px;
    }

    /* ========================================
       QUICK ACTION TILES
       ======================================== */

    .quick-action-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-decoration: none;
      color: var(--text);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      font-family: inherit;
      font-size: inherit;
    }

    .quick-action-tile:hover {
      border-color: var(--border-gold);
      background: rgba(251, 191, 36, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(251, 191, 36, 0.15);
    }

    .quick-action-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .quick-action-label {
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      color: var(--muted);
    }

    .quick-action-tile:hover .quick-action-label {
      color: var(--text);
    }

    /* ========================================
       PROGRESS BARS
       ======================================== */

    .progress-bar-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="pageBody">
      <!-- Header Section -->
      <div class="header">
        <div class="headerTitle">Business Dashboard</div>
        <div class="headerSub">
          <span id="companyName">Revenue Radar</span>
          <span class="muted">‚Ä¢</span>
          <span class="muted">Analyzing invoice discrepancies and overbilling</span>
        </div>
        <div class="headerRight">
          <label style="color: var(--muted); font-size: 13px; font-weight: 600;">
            From:
            <input type="date" id="dateFrom" style="margin-left: 8px;">
          </label>
          <label style="color: var(--muted); font-size: 13px; font-weight: 600;">
            To:
            <input type="date" id="dateTo" style="margin-left: 8px;">
          </label>
          <button class="btn" onclick="loadDashboard()">Apply Filters</button>
        </div>
      </div>

      <!-- Trial Status Banner -->
      <div id="trialBanner" class="trial-banner">
        <span id="trialStatusText" class="trial-banner-text"></span>
      </div>

      <!-- Metrics Row -->
      <div class="card">
        <div class="metricsRow" id="metricsRow">
          <div class="loadingState">Loading metrics...</div>
        </div>
      </div>

      <!-- Quick Action Tiles -->
      <div class="card" style="padding: 16px;">
        <div class="sectionHeader" style="margin-bottom: 16px;">
          <div class="sectionTitle">‚ö° Quick Actions</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
          <a href="inventory.html" class="quick-action-tile">
            <div class="quick-action-icon">üì¶</div>
            <div class="quick-action-label">Inventory</div>
          </a>
          <a href="business-analytics.html" class="quick-action-tile">
            <div class="quick-action-icon">üìä</div>
            <div class="quick-action-label">Analytics</div>
          </a>
          <a href="upload-invoice.html" class="quick-action-tile">
            <div class="quick-action-icon">üìÑ</div>
            <div class="quick-action-label">Upload Invoice</div>
          </a>
          <a href="connect-email.html" class="quick-action-tile">
            <div class="quick-action-icon">üìß</div>
            <div class="quick-action-label">Connect Email</div>
          </a>
          <button onclick="openPayrollEntry()" class="quick-action-tile">
            <div class="quick-action-icon">üíµ</div>
            <div class="quick-action-label">Add Payroll</div>
          </button>
          <button onclick="openExpenseEntry()" class="quick-action-tile">
            <div class="quick-action-icon">üßæ</div>
            <div class="quick-action-label">Add Expense</div>
          </button>
          <button onclick="openPayrollUpload()" class="quick-action-tile">
            <div class="quick-action-icon">üì§</div>
            <div class="quick-action-label">Upload Payroll</div>
          </button>
        </div>
      </div>

      <!-- Financial Overview Charts -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">üìà Financial Overview</div>
          <div style="display: flex; gap: 8px;">
            <select id="chartPeriod" onchange="loadFinancialCharts()" style="background: var(--panel2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 6px; font-size: 13px;">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
          </div>
        </div>
        <div class="divider"></div>

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px; background: var(--panel2); border-bottom: 1px solid var(--border);">
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Expenses</div>
            <div style="font-size: 24px; font-weight: 700; color: #ef4444;" id="chartTotalExpenses">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Payroll</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--gold);" id="chartTotalPayroll">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Inventory Spend</div>
            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="chartTotalInventory">$0</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 11px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Savings Found</div>
            <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="chartTotalSavings">$0</div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
          <!-- Expense Breakdown Chart -->
          <div>
            <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Expense Breakdown</h4>
            <div style="position: relative; height: 200px; width: 100%;">
              <canvas id="expenseBreakdownChart"></canvas>
            </div>
          </div>
          <!-- Spending Trend Chart -->
          <div>
            <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Spending Trend</h4>
            <div style="position: relative; height: 200px; width: 100%;">
              <canvas id="spendingTrendChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Budget vs Actual -->
        <div style="padding: 0 20px 20px;">
          <h4 style="margin: 0 0 16px 0; color: var(--text); font-size: 14px;">Budget vs Actual</h4>
          <div id="budgetComparison" style="display: grid; gap: 12px;">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>

      <!-- Payroll & Expense Entry Section -->
      <div class="grid2">
        <!-- Payroll Entry Card -->
        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">üíµ Payroll Entry</div>
            <button class="btn" onclick="viewPayrollHistory()" style="background: var(--panel2); font-size: 13px;">View History</button>
          </div>
          <div class="divider"></div>
          <div style="padding: 20px;">
            <form id="payrollForm" onsubmit="submitPayroll(event)">
              <div style="display: grid; gap: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period Start</label>
                    <input type="date" id="payrollStart" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period End</label>
                    <input type="date" id="payrollEnd" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Gross Payroll ($)</label>
                  <input type="number" id="grossPayroll" step="0.01" min="0" required placeholder="e.g. 15000.00" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Employee Count</label>
                    <input type="number" id="employeeCount" min="1" placeholder="e.g. 12" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Total Hours</label>
                    <input type="number" id="totalHours" step="0.5" min="0" placeholder="e.g. 480" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Notes (optional)</label>
                  <textarea id="payrollNotes" rows="2" placeholder="Any additional notes..." style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Payroll Entry</button>
              </div>
            </form>
            <div id="payrollStatus" style="margin-top: 12px; display: none;"></div>
          </div>
        </div>

        <!-- Expense Entry Card -->
        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">üßæ Expense Entry</div>
            <button class="btn" onclick="viewExpenseHistory()" style="background: var(--panel2); font-size: 13px;">View History</button>
          </div>
          <div class="divider"></div>
          <div style="padding: 20px;">
            <form id="expenseForm" onsubmit="submitExpense(event)">
              <div style="display: grid; gap: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Category</label>
                    <select id="expenseCategory" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                      <option value="">Select category...</option>
                      <option value="inventory">Inventory / Supplies</option>
                      <option value="utilities">Utilities</option>
                      <option value="rent">Rent / Lease</option>
                      <option value="insurance">Insurance</option>
                      <option value="marketing">Marketing</option>
                      <option value="equipment">Equipment</option>
                      <option value="professional">Professional Services</option>
                      <option value="technology">Technology / Software</option>
                      <option value="travel">Travel</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Date</label>
                    <input type="date" id="expenseDate" required style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Amount ($)</label>
                  <input type="number" id="expenseAmount" step="0.01" min="0" required placeholder="e.g. 1500.00" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Vendor / Description</label>
                  <input type="text" id="expenseVendor" placeholder="e.g. Electric Company - Monthly Bill" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                </div>
                <div>
                  <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Notes (optional)</label>
                  <textarea id="expenseNotes" rows="2" placeholder="Any additional notes..." style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); resize: vertical;"></textarea>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Save Expense Entry</button>
              </div>
            </form>
            <div id="expenseStatus" style="margin-top: 12px; display: none;"></div>
          </div>
        </div>
      </div>

      <!-- Vendor and Location Breakdown -->
      <div class="grid2">
        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">Potential overbilling by vendor</div>
          </div>
          <div class="divider"></div>
          <div class="breakdownList" id="vendorBreakdown">
            <div class="loadingState">Loading vendors...</div>
          </div>
        </div>

        <div class="card">
          <div class="sectionHeader">
            <div class="sectionTitle">Potential overbilling by location</div>
          </div>
          <div class="divider"></div>
          <div class="breakdownList" id="locationBreakdown">
            <div class="loadingState">Loading locations...</div>
          </div>
        </div>
      </div>

      <!-- Flagged Issues Table -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">Flagged issues</div>
          <div class="muted">High-confidence prioritized</div>
        </div>
        <div class="divider"></div>
        <div class="tableWrap" id="issuesTable">
          <div class="loadingState">Loading issues...</div>
        </div>
      </div>

      <!-- Email Invoice Autopilot Section -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">üìß Email Invoice Autopilot</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn" onclick="openSetupGuide()" style="background: var(--panel2); font-size: 13px;">Setup Guide</button>
            <button class="btn" onclick="openAddEmailMonitor()">+ Add Email Monitor</button>
          </div>
        </div>
        <div class="divider"></div>

        <!-- Quick Stats Bar -->
        <div id="emailAutopilotStats" style="display: none; padding: 16px; background: var(--panel2); border-bottom: 1px solid var(--border);">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold);" id="statActiveMonitors">0</div>
              <div style="font-size: 12px; color: var(--muted2);">Active Monitors</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--text);" id="statEmailsProcessed">0</div>
              <div style="font-size: 12px; color: var(--muted2);">Emails Processed</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="statInvoicesCreated">0</div>
              <div style="font-size: 12px; color: var(--muted2);">Invoices Created</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: var(--text);" id="statLastCheck">-</div>
              <div style="font-size: 12px; color: var(--muted2);">Last Check</div>
            </div>
          </div>
        </div>

        <div style="padding: 16px;">
          <div id="emailMonitorsList" style="display: grid; gap: 12px;">
            <div class="emailAutopilotEmptyState" style="text-align: center; padding: 48px 24px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üì¨</div>
              <h3 style="color: var(--text); margin-bottom: 8px; font-size: 18px;">Automate Your Invoice Processing</h3>
              <p style="color: var(--muted2); margin-bottom: 24px; max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                Connect your email inbox and we'll automatically scan for invoices, extract the data,
                and flag any pricing discrepancies - saving you hours of manual work.
              </p>
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="openAddEmailMonitor()">+ Add Email Monitor</button>
                <button class="btn" onclick="openSetupGuide()" style="background: var(--panel2);">How It Works</button>
              </div>
              <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                <div style="color: var(--muted2); font-size: 13px; margin-bottom: 12px;">Works with all major email providers:</div>
                <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; color: var(--muted);">
                  <span>Gmail</span>
                  <span>‚Ä¢</span>
                  <span>Outlook/Office 365</span>
                  <span>‚Ä¢</span>
                  <span>Yahoo</span>
                  <span>‚Ä¢</span>
                  <span>GoDaddy</span>
                  <span>‚Ä¢</span>
                  <span>Any IMAP</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Inventory Intelligence Section -->
      <div class="card">
        <div class="sectionHeader">
          <div class="sectionTitle">üì¶ Inventory Intelligence</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn" onclick="window.location.href='inventory.html'" style="background: var(--panel2); font-size: 13px;">Full Inventory</button>
            <button class="btn" onclick="runInventoryAnalysis()">Run Analysis</button>
          </div>
        </div>
        <div class="divider"></div>

        <!-- Inventory Stats Row -->
        <div id="inventoryStatsRow" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px; background: var(--panel2); border-bottom: 1px solid var(--border);">
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--text);" id="invTotalItems">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Total Items</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: var(--gold);" id="invTotalValue">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Inventory Value</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #ef4444;" id="invLowStock">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Low Stock Items</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="invHealthScore">-</div>
            <div style="font-size: 12px; color: var(--muted2);">Health Score</div>
          </div>
        </div>

        <!-- Recommendations Cards -->
        <div style="padding: 20px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <h4 style="margin: 0; color: var(--text); font-size: 15px;">üéØ Smart Recommendations</h4>
            <div style="display: flex; gap: 8px;">
              <span class="badge" id="invCriticalBadge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">0 Critical</span>
              <span class="badge" id="invSavingsBadge" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">$0 Savings</span>
            </div>
          </div>
          <div id="inventoryRecommendations" style="display: grid; gap: 12px;">
            <div style="text-align: center; padding: 32px; color: var(--muted2);">
              <div style="font-size: 40px; margin-bottom: 12px;">üìä</div>
              <p style="margin: 0 0 16px 0;">Loading inventory recommendations...</p>
            </div>
          </div>
        </div>

        <!-- Stockout Alerts -->
        <div style="padding: 0 20px 20px;">
          <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 15px;">‚ö†Ô∏è Stockout Alerts</h4>
          <div id="stockoutAlerts" style="display: grid; gap: 8px;">
            <div style="text-align: center; padding: 24px; color: var(--muted2);">
              <p style="margin: 0;">No stockout alerts at this time.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Email Monitor Modal -->
  <div id="addEmailMonitorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">Add Email Monitor</h2>
        <button onclick="closeAddEmailMonitor()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>

      <div style="display: grid; gap: 20px;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Monitor Name *</label>
          <input type="text" id="newMonitorName" placeholder="e.g., Main Invoice Inbox" required style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          <small style="display: block; color: var(--muted2); margin-top: 4px;">Friendly name to identify this monitor</small>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Email Address *</label>
          <input type="email" id="newMonitorEmail" placeholder="invoices@yourcompany.com" required onblur="detectIMAPSettings()" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          <small style="display: block; color: var(--muted2); margin-top: 4px;">Email account to monitor for invoices</small>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Email Password/App Password *</label>
          <input type="password" id="newMonitorPassword" placeholder="Your email password" required style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          <small style="display: block; color: var(--gold); margin-top: 4px;">‚ö†Ô∏è For Gmail/Yahoo/Outlook, use App Password (not regular password)</small>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">IMAP Server *</label>
            <input type="text" id="newMonitorImapHost" placeholder="imap.gmail.com" required style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">IMAP Port</label>
            <input type="number" id="newMonitorImapPort" placeholder="993" value="993" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          </div>
        </div>

        <div style="text-align: center;">
          <button onclick="testIMAPConnection()" type="button" class="btn" style="background: #6366f1;">üîå Test Connection</button>
          <div id="testConnectionResult" style="margin-top: 12px; display: none;"></div>
        </div>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button onclick="createEmailMonitor()" class="btn" style="flex: 1;">Create Monitor</button>
        <button onclick="closeAddEmailMonitor()" class="btn" style="flex: 1; background: var(--panel2);">Cancel</button>
      </div>

      <div id="newMonitorStatus" style="margin-top: 16px; display: none;"></div>
    </div>
  </div>

  <!-- Setup Guide Modal -->
  <div id="setupGuideModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 700px; width: 90%; margin: 40px auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üìß Email Autopilot Setup Guide</h2>
        <button onclick="closeSetupGuide()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>

      <!-- How It Works -->
      <div style="background: var(--gold-glow); border: 1px solid var(--border-gold); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 12px 0; color: var(--gold); font-size: 16px;">How Email Autopilot Works</h3>
        <ol style="margin: 0; padding-left: 20px; color: var(--text); line-height: 1.8;">
          <li>Connect your invoice email inbox (where vendors send invoices)</li>
          <li>Our system automatically scans for new invoice emails</li>
          <li>AI extracts invoice data from PDFs and email content</li>
          <li>Invoices are analyzed for price increases and discrepancies</li>
          <li>You get notified of potential overbilling issues</li>
        </ol>
      </div>

      <!-- Provider-Specific Instructions -->
      <div style="margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 16px;">Setup by Email Provider</h3>

        <div style="display: grid; gap: 12px;">
          <!-- Gmail -->
          <details style="background: var(--panel2); border-radius: 8px; border: 1px solid var(--border);">
            <summary style="padding: 16px; cursor: pointer; font-weight: 600; color: var(--text);">
              Gmail / Google Workspace
            </summary>
            <div style="padding: 0 16px 16px; color: var(--muted);">
              <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li>Go to <a href="https://myaccount.google.com/security" target="_blank" style="color: var(--gold);">Google Account Security</a></li>
                <li>Enable 2-Step Verification (if not already enabled)</li>
                <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: var(--gold);">App Passwords</a></li>
                <li>Select "Mail" and your device, then click "Generate"</li>
                <li>Copy the 16-character password (use this in the form, not your regular password)</li>
              </ol>
              <div style="margin-top: 12px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                <strong style="color: var(--gold);">IMAP Settings:</strong><br>
                Server: imap.gmail.com | Port: 993 | Security: SSL/TLS
              </div>
            </div>
          </details>

          <!-- Outlook -->
          <details style="background: var(--panel2); border-radius: 8px; border: 1px solid var(--border);">
            <summary style="padding: 16px; cursor: pointer; font-weight: 600; color: var(--text);">
              Outlook / Office 365 / Hotmail
            </summary>
            <div style="padding: 0 16px 16px; color: var(--muted);">
              <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li>Go to <a href="https://account.microsoft.com/security" target="_blank" style="color: var(--gold);">Microsoft Account Security</a></li>
                <li>Enable Two-step verification</li>
                <li>Under "App passwords", create a new app password</li>
                <li>Use this generated password (not your regular password)</li>
              </ol>
              <div style="margin-top: 12px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                <strong style="color: var(--gold);">IMAP Settings:</strong><br>
                Server: outlook.office365.com | Port: 993 | Security: SSL/TLS
              </div>
            </div>
          </details>

          <!-- Yahoo -->
          <details style="background: var(--panel2); border-radius: 8px; border: 1px solid var(--border);">
            <summary style="padding: 16px; cursor: pointer; font-weight: 600; color: var(--text);">
              Yahoo Mail
            </summary>
            <div style="padding: 0 16px 16px; color: var(--muted);">
              <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li>Go to <a href="https://login.yahoo.com/account/security" target="_blank" style="color: var(--gold);">Yahoo Account Security</a></li>
                <li>Click "Generate app password"</li>
                <li>Select "Other App" and enter "Revenue Radar"</li>
                <li>Copy the generated password</li>
              </ol>
              <div style="margin-top: 12px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                <strong style="color: var(--gold);">IMAP Settings:</strong><br>
                Server: imap.mail.yahoo.com | Port: 993 | Security: SSL/TLS
              </div>
            </div>
          </details>

          <!-- GoDaddy -->
          <details style="background: var(--panel2); border-radius: 8px; border: 1px solid var(--border);">
            <summary style="padding: 16px; cursor: pointer; font-weight: 600; color: var(--text);">
              GoDaddy Workspace Email
            </summary>
            <div style="padding: 0 16px 16px; color: var(--muted);">
              <p style="margin: 0 0 12px 0;">GoDaddy Workspace allows direct IMAP access with your regular email password.</p>
              <div style="padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                <strong style="color: var(--gold);">IMAP Settings:</strong><br>
                Server: imap.secureserver.net | Port: 993 | Security: SSL/TLS
              </div>
            </div>
          </details>

          <!-- Other -->
          <details style="background: var(--panel2); border-radius: 8px; border: 1px solid var(--border);">
            <summary style="padding: 16px; cursor: pointer; font-weight: 600; color: var(--text);">
              Other Email Providers
            </summary>
            <div style="padding: 0 16px 16px; color: var(--muted);">
              <p style="margin: 0 0 12px 0;">For other providers, you'll need:</p>
              <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li>IMAP server address (usually imap.yourdomain.com)</li>
                <li>Port number (usually 993 for SSL or 143 for non-SSL)</li>
                <li>Your email address and password</li>
              </ul>
              <p style="margin: 12px 0 0 0;">Check your email provider's help documentation for IMAP settings, or contact their support.</p>
            </div>
          </details>
        </div>
      </div>

      <!-- Tips -->
      <div style="background: var(--panel2); border-radius: 8px; padding: 20px; border: 1px solid var(--border);">
        <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">üí° Pro Tips for Multi-Location Owners</h3>
        <ul style="margin: 0; padding-left: 20px; color: var(--muted); line-height: 1.8;">
          <li><strong style="color: var(--text);">Dedicated invoice email:</strong> Set up invoices@yourcompany.com and ask vendors to send there</li>
          <li><strong style="color: var(--text);">Multiple monitors:</strong> Create one monitor per location for better tracking</li>
          <li><strong style="color: var(--text);">Forward invoices:</strong> Set up email forwarding rules to consolidate invoices</li>
          <li><strong style="color: var(--text);">Check frequency:</strong> Invoices are scanned every 15 minutes by default</li>
        </ul>
      </div>

      <div style="margin-top: 24px; text-align: center;">
        <button onclick="closeSetupGuide(); openAddEmailMonitor();" class="btn">Ready to Connect Email</button>
      </div>
    </div>
  </div>

  <!-- Monitor Activity Modal -->
  <div id="monitorActivityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 800px; width: 90%; margin: 40px auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;" id="monitorActivityTitle">Monitor Activity</h2>
        <button onclick="closeMonitorActivity()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>
      <div id="monitorActivityContent" style="max-height: 500px; overflow-y: auto;">
        <div style="text-align: center; padding: 40px; color: var(--muted2);">Loading activity...</div>
      </div>
    </div>
  </div>

  <!-- Payroll Upload Modal -->
  <div id="payrollUploadModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: var(--panel); border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; margin: 40px auto; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üì§ Upload Payroll File</h2>
        <button onclick="closePayrollUpload()" style="background: none; border: none; color: var(--muted); font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>

      <!-- Supported Formats Info -->
      <div style="background: var(--gold-glow); border: 1px solid var(--border-gold); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 8px 0; color: var(--gold); font-size: 14px;">Supported Formats</h4>
        <p style="margin: 0; color: var(--muted); font-size: 13px; line-height: 1.6;">
          Upload payroll exports from <strong style="color: var(--text);">ADP, Toast, Gusto, QuickBooks, Paychex, Square</strong> and more.
          We accept <strong style="color: var(--text);">.xlsx, .xls, .csv, and .pdf</strong> files.
        </p>
      </div>

      <!-- Upload Zone -->
      <div id="payrollDropZone" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px;"
           ondragover="handlePayrollDragOver(event)" ondragleave="handlePayrollDragLeave(event)" ondrop="handlePayrollDrop(event)" onclick="document.getElementById('payrollFileInput').click()">
        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
        <div style="color: var(--text); font-weight: 600; margin-bottom: 8px;">Drop your payroll file here</div>
        <div style="color: var(--muted2); font-size: 13px;">or click to browse</div>
        <input type="file" id="payrollFileInput" accept=".xlsx,.xls,.csv,.pdf" style="display: none;" onchange="handlePayrollFileSelect(event)">
      </div>

      <!-- Selected File Info -->
      <div id="payrollFileInfo" style="display: none; background: var(--panel2); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="color: var(--text); font-weight: 600;" id="payrollFileName">-</div>
            <div style="color: var(--muted2); font-size: 12px;" id="payrollFileSize">-</div>
          </div>
          <button onclick="clearPayrollFile()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px;">Remove</button>
        </div>
      </div>

      <!-- Payroll Provider Selection -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Payroll Provider (Optional)</label>
        <select id="payrollProvider" style="width: 100%; padding: 12px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;">
          <option value="">Auto-detect</option>
          <option value="adp">ADP</option>
          <option value="toast">Toast</option>
          <option value="gusto">Gusto</option>
          <option value="quickbooks">QuickBooks</option>
          <option value="paychex">Paychex</option>
          <option value="square">Square Payroll</option>
          <option value="other">Other</option>
        </select>
        <small style="display: block; color: var(--muted2); margin-top: 4px;">Helps us parse your file more accurately</small>
      </div>

      <!-- Pay Period (Optional) -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period Start (Optional)</label>
          <input type="date" id="payrollUploadStart" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
        </div>
        <div>
          <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px;">Period End (Optional)</label>
          <input type="date" id="payrollUploadEnd" style="width: 100%; padding: 10px; background: var(--panel2); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
        </div>
      </div>

      <!-- Upload Button -->
      <div style="display: flex; gap: 12px;">
        <button onclick="uploadPayrollFile()" id="payrollUploadBtn" class="btn" style="flex: 1;" disabled>
          Upload & Process
        </button>
        <button onclick="closePayrollUpload()" class="btn" style="flex: 1; background: var(--panel2);">Cancel</button>
      </div>

      <!-- Upload Status -->
      <div id="payrollUploadStatus" style="margin-top: 16px; display: none;"></div>
    </div>
  </div>

  <!-- Chart.js for Financial Analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- Authentication Manager - Load FIRST -->
  <script src="/dashboard/auth-manager.js"></script>
  <!-- Shared Navigation - Load SECOND -->
  <script src="/dashboard/shared-nav.js"></script>

  <script>
    // =====================================================
    // VP DASHBOARD - JAVASCRIPT
    // =====================================================

    // Use relative URLs since frontend and backend are on same server
    const API_BASE = window.location.origin;

    // Default filters
    let filters = {
      companyId: 'demo', // Default company
      dateFrom: getDateDaysAgo(30),
      dateTo: getTodayDate(),
      impactPeriod: 'monthly',
      mode: 'demo' // Use demo data by default (change to 'runs' when you have real invoice data)
    };

    // Helper: Get date N days ago
    function getDateDaysAgo(days) {
      const date = new Date();
      date.setDate(date.getDate() - days);
      return date.toISOString().split('T')[0];
    }

    // Helper: Get today's date
    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    // Helper: Format money
    function formatMoney(cents) {
      return '$' + (cents / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Helper: Format date
    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Helper: Format issue type
    function formatIssueType(type) {
      const types = {
        'PRICE_INCREASE': 'Price Increase',
        'QUANTITY_DRIFT': 'Quantity Drift',
        'NEW_FEE': 'New Fee',
        'DUPLICATE_CHARGE': 'Duplicate Charge',
        'ROUNDING_TAX_ANOMALY': 'Tax Anomaly'
      };
      return types[type] || type;
    }

    // Helper: Build query string
    function buildQueryString(filters) {
      const params = new URLSearchParams();
      params.set('companyId', filters.companyId);
      params.set('dateFrom', filters.dateFrom);
      params.set('dateTo', filters.dateTo);
      if (filters.vendorId) params.set('vendorId', filters.vendorId);
      if (filters.locationId) params.set('locationId', filters.locationId);
      if (filters.minConfidence) params.set('minConfidence', filters.minConfidence);
      if (filters.impactPeriod) params.set('impactPeriod', filters.impactPeriod);
      if (filters.mode) params.set('mode', filters.mode);
      return params.toString();
    }

    // Fetch JSON from API
    async function fetchAPI(endpoint) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Load metrics
    async function loadMetrics() {
      try {
        const data = await fetchAPI(`/api/dashboard/metrics?${buildQueryString(filters)}`);
        const metrics = data.metrics;

        document.getElementById('metricsRow').innerHTML = `
          <div class="metricTile">
            <div class="metricLabel">Total potential overbilling</div>
            <div class="metricValue">${formatMoney(metrics.totalPotentialOverbillingCents)}</div>
            <div class="metricSub">Across ${metrics.vendorsImpactedCount} vendors</div>
          </div>
          <div class="metricTile clickable" onclick="showLocationBreakdown()" title="Click to see breakdown by location">
            <div class="metricLabel">Invoices analyzed</div>
            <div class="metricValue">${metrics.invoicesAnalyzedCount.toLocaleString()}</div>
            <div class="metricSub">Across ${metrics.locationsCount} locations</div>
          </div>
          <div class="metricTile clickable" onclick="document.getElementById('issuesTable').scrollIntoView({behavior: 'smooth'})" title="Click to view flagged issues">
            <div class="metricLabel">Flagged issues</div>
            <div class="metricValue">${metrics.flaggedIssuesCount.toLocaleString()}</div>
            <div class="metricSub">High-confidence prioritized</div>
          </div>
          <div class="metricTile">
            <div class="metricLabel">Avg projected impact</div>
            <div class="metricValue">${formatMoney(metrics.avgMonthlyImpactCents)}</div>
            <div class="metricSub">MONTHLY view</div>
          </div>
        `;
      } catch (error) {
        document.getElementById('metricsRow').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load metrics</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load vendor breakdown
    async function loadVendors() {
      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/vendors?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('vendorBreakdown').innerHTML = '<div class="emptyState">No vendor data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.amountCents - a.amountCents).slice(0, 10);
        const html = sorted.map((row, idx) => `
          <div class="breakdownRow">
            <div class="breakdownLeft">
              <div class="breakdownRank">${idx + 1}</div>
              <div class="breakdownName">${row.name}</div>
            </div>
            <div class="breakdownRight">
              <div class="breakdownAmount">${formatMoney(row.amountCents)}</div>
              <div class="breakdownMeta">${row.issuesCount} issues ‚Ä¢ ${row.invoicesCount} invoices</div>
            </div>
          </div>
        `).join('');

        document.getElementById('vendorBreakdown').innerHTML = html;
      } catch (error) {
        document.getElementById('vendorBreakdown').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load vendors</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load location breakdown
    async function loadLocations() {
      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/locations?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('locationBreakdown').innerHTML = '<div class="emptyState">No location data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.amountCents - a.amountCents).slice(0, 10);
        const html = sorted.map((row, idx) => `
          <div class="breakdownRow">
            <div class="breakdownLeft">
              <div class="breakdownRank">${idx + 1}</div>
              <div class="breakdownName">${row.name}</div>
            </div>
            <div class="breakdownRight">
              <div class="breakdownAmount">${formatMoney(row.amountCents)}</div>
              <div class="breakdownMeta">${row.issuesCount} issues ‚Ä¢ ${row.invoicesCount} invoices</div>
            </div>
          </div>
        `).join('');

        document.getElementById('locationBreakdown').innerHTML = html;
      } catch (error) {
        document.getElementById('locationBreakdown').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load locations</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load flagged issues
    async function loadIssues() {
      try {
        const data = await fetchAPI(`/api/dashboard/issues?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          document.getElementById('issuesTable').innerHTML = '<div class="emptyState">No flagged issues for this period</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.deltaCents - a.deltaCents);

        // Store issues data for proof modal
        window.issuesData = {};
        sorted.forEach((row, idx) => {
          window.issuesData[`issue_${idx}`] = row;
        });

        const html = `
          <table class="table">
            <thead>
              <tr>
                <th>Vendor</th>
                <th>Location</th>
                <th>Issue type</th>
                <th class="num">Current</th>
                <th class="num">Expected</th>
                <th class="num">Delta ($)</th>
                <th>Confidence</th>
                <th>Invoice date</th>
                <th style="text-align: center;">Proof</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map((row, idx) => `
                <tr>
                  <td class="cellMain">${row.vendorName}</td>
                  <td>${row.locationName}</td>
                  <td>${formatIssueType(row.issueType)}</td>
                  <td class="num">${formatMoney(row.currentChargeCents)}</td>
                  <td class="num">${formatMoney(row.expectedChargeCents)}</td>
                  <td class="num"><b>${formatMoney(row.deltaCents)}</b></td>
                  <td>
                    <span class="badge ${row.confidence === 'HIGH' ? 'badge-good' : 'badge-neutral'}">
                      ${row.confidence}
                    </span>
                  </td>
                  <td>${formatDate(row.invoiceDate)}</td>
                  <td style="text-align: center;">
                    <button class="btn-proof" onclick="showProof(window.issuesData['issue_${idx}'])">
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      See Proof
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        document.getElementById('issuesTable').innerHTML = html;
      } catch (error) {
        document.getElementById('issuesTable').innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load issues</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    // Load trial status for current user
    async function loadTrialStatus() {
      try {
        const response = await fetch(`${API_BASE}/auth/trial/status`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data && result.data.isTrial) {
            const trial = result.data;
            const banner = document.getElementById('trialBanner');
            const text = document.getElementById('trialStatusText');

            banner.style.display = 'block';

            // Build status message
            const daysText = trial.daysLeft === 1 ? '1 day' : `${trial.daysLeft} days`;
            const invoicesText = trial.invoicesLeft === 1 ? '1 invoice' : `${trial.invoicesLeft} invoices`;
            text.textContent = `üéÅ FREE TRIAL: ${daysText} & ${invoicesText} remaining`;

            // Warning color when low
            if (trial.daysLeft <= 3 || trial.invoicesLeft <= 3) {
              banner.classList.add('warning');
            }
          }
        }
      } catch (error) {
        console.error('Failed to load trial status:', error);
        // Non-critical - don't show error to user
      }
    }

    // Load all dashboard data
    async function loadDashboard() {
      // Update filters from inputs
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      if (dateFrom) filters.dateFrom = dateFrom;
      if (dateTo) filters.dateTo = dateTo;

      // Load all data in parallel
      await Promise.all([
        loadMetrics(),
        loadVendors(),
        loadLocations(),
        loadIssues()
      ]);
    }

    // Initialize with authentication and load dashboard
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // 1. Initialize authentication (blocks until complete)
        const user = await window.AuthManager.initialize();

        // 2. Check role access - VP dashboard requires admin, customer_admin, or demo_business role
        window.AuthManager.requireRole(['admin', 'customer_admin', 'demo_business']);

        // 3. Initialize navigation (depends on auth being ready)
        await window.initializeNavigation();

        // 4. Initialize date inputs
        document.getElementById('dateFrom').value = filters.dateFrom;
        document.getElementById('dateTo').value = filters.dateTo;

        // 5. Load trial status (if applicable)
        await loadTrialStatus();

        // 6. Load dashboard content
        loadDashboard();

        // 7. Load email monitors
        loadEmailMonitors();

        // 8. Load inventory intelligence
        loadInventoryDashboard();
      } catch (error) {
        // AuthManager already handled redirect
        console.error('VP dashboard auth failed:', error);
      }
    });

    // =====================================================
    // INVENTORY INTELLIGENCE FUNCTIONS
    // =====================================================

    async function loadInventoryDashboard() {
      try {
        // Load dashboard data with all inventory info
        const response = await fetch(`${API_BASE}/api/bi/inventory/dashboard`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            renderInventoryStats(result.data);
            renderInventoryRecommendations(result.data.recommendations || []);
            renderStockoutAlerts(result.data.stockoutAlerts || []);
          }
        }
      } catch (error) {
        console.error('Failed to load inventory dashboard:', error);
        document.getElementById('inventoryRecommendations').innerHTML = `
          <div style="text-align: center; padding: 32px; color: var(--muted2);">
            <p>Unable to load inventory data.</p>
          </div>
        `;
      }
    }

    function renderInventoryStats(data) {
      const stats = data.stats || {};

      document.getElementById('invTotalItems').textContent = stats.total_items || 0;
      document.getElementById('invTotalValue').textContent = '$' + (stats.total_value_dollars || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
      document.getElementById('invLowStock').textContent = stats.low_stock_count || 0;

      // Health score
      const healthScore = data.healthScore || {};
      document.getElementById('invHealthScore').textContent = healthScore.grade || '-';

      // Update badge colors based on values
      const lowStockEl = document.getElementById('invLowStock');
      if ((stats.low_stock_count || 0) > 0) {
        lowStockEl.style.color = '#ef4444';
      } else {
        lowStockEl.style.color = '#10b981';
      }
    }

    function renderInventoryRecommendations(recommendations) {
      const container = document.getElementById('inventoryRecommendations');

      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 32px; color: var(--muted2);">
            <div style="font-size: 40px; margin-bottom: 12px;">‚úÖ</div>
            <h4 style="color: var(--text); margin-bottom: 8px;">All Caught Up!</h4>
            <p style="margin: 0;">No recommendations at this time. Your inventory is well-managed.</p>
          </div>
        `;
        document.getElementById('invCriticalBadge').textContent = '0 Critical';
        document.getElementById('invSavingsBadge').textContent = '$0 Savings';
        return;
      }

      // Count critical and total savings
      const criticalCount = recommendations.filter(r => r.priority === 'critical').length;
      const totalSavings = recommendations.reduce((sum, r) => sum + (r.potential_savings_cents || 0), 0);

      document.getElementById('invCriticalBadge').textContent = `${criticalCount} Critical`;
      document.getElementById('invSavingsBadge').textContent = '$' + (totalSavings / 100).toLocaleString();

      // Show top 5 recommendations
      const topRecs = recommendations.slice(0, 5);

      container.innerHTML = topRecs.map(rec => {
        const bgColor = rec.priority === 'critical' ? 'rgba(239, 68, 68, 0.1)' :
                       rec.priority === 'high' ? 'rgba(251, 191, 36, 0.1)' : 'var(--panel2)';
        const borderColor = rec.priority === 'critical' ? 'rgba(239, 68, 68, 0.3)' :
                           rec.priority === 'high' ? 'rgba(251, 191, 36, 0.3)' : 'var(--border)';
        const typeIcon = getRecommendationIcon(rec.recommendation_type);

        return `
          <div style="background: ${bgColor}; padding: 16px; border-radius: 10px; border: 1px solid ${borderColor}; display: flex; align-items: flex-start; gap: 12px;">
            <div style="font-size: 24px; flex-shrink: 0;">${typeIcon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 4px;">${escapeHtml(rec.title)}</div>
              <div style="font-size: 13px; color: var(--muted2); line-height: 1.5;">${escapeHtml(rec.description)}</div>
              ${rec.potential_savings_cents > 0 ? `
                <div style="margin-top: 8px; font-size: 12px; color: #22c55e; font-weight: 600;">
                  üí∞ Potential savings: $${(rec.potential_savings_cents / 100).toLocaleString()}
                </div>
              ` : ''}
            </div>
            ${rec.suggested_quantity > 0 ? `
              <button onclick="actionInventoryRec(${rec.id}, ${rec.suggested_quantity})" class="btn" style="font-size: 12px; padding: 8px 12px; white-space: nowrap;">
                Order ${rec.suggested_quantity}
              </button>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderStockoutAlerts(alerts) {
      const container = document.getElementById('stockoutAlerts');

      if (!alerts || alerts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 24px; color: var(--muted2);">
            <p style="margin: 0;">‚úÖ No stockout alerts at this time.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = alerts.slice(0, 5).map(alert => {
        const urgencyColor = alert.severity === 'critical' ? '#ef4444' :
                            alert.severity === 'warning' ? '#f59e0b' : '#64748b';

        return `
          <div style="background: var(--panel2); padding: 12px 16px; border-radius: 8px; border-left: 3px solid ${urgencyColor}; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
            <div>
              <div style="font-weight: 600; color: var(--text);">${escapeHtml(alert.product_name || alert.sku)}</div>
              <div style="font-size: 12px; color: var(--muted2);">
                ${alert.days_until_stockout} days until stockout ‚Ä¢ Current: ${alert.current_quantity} ${alert.unit || 'units'}
              </div>
            </div>
            <span style="background: ${urgencyColor}20; color: ${urgencyColor}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
              ${alert.severity}
            </span>
          </div>
        `;
      }).join('');
    }

    function getRecommendationIcon(type) {
      const icons = {
        'urgent_reorder': 'üö®',
        'discount_opportunity': 'üí∞',
        'supply_forecast': 'üìä',
        'holiday_prep': 'üéÑ',
        'bulk_opportunity': 'üì¶',
        'overstock_warning': 'üìà',
        'usage_spike': '‚ö°',
        'usage_drop': 'üìâ'
      };
      return icons[type] || 'üìã';
    }

    async function runInventoryAnalysis() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Analyzing...';

        const response = await fetch(`${API_BASE}/api/bi/inventory/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          await loadInventoryDashboard();
          alert('Analysis complete! Inventory recommendations updated.');
        }
      } catch (error) {
        console.error('Failed to run analysis:', error);
        alert('Failed to run analysis. Please try again.');
      } finally {
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = 'Run Analysis';
      }
    }

    async function actionInventoryRec(id, quantity) {
      try {
        const response = await fetch(`${API_BASE}/api/bi/inventory/recommendations/${id}/action`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({ quantity_ordered: quantity })
        });

        if (response.ok) {
          loadInventoryDashboard();
        }
      } catch (error) {
        console.error('Failed to action recommendation:', error);
      }
    }

    // =====================================================
    // EMAIL MONITOR FUNCTIONS
    // =====================================================

    async function loadEmailMonitors() {
      try {
        const response = await fetch(`${API_BASE}/api/email-monitors`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const list = document.getElementById('emailMonitorsList');
          const statsBar = document.getElementById('emailAutopilotStats');

          // API returns result.data, not result.monitors
          const monitors = result.data || result.monitors || [];

          if (!monitors || monitors.length === 0) {
            // Show empty state (already in HTML)
            statsBar.style.display = 'none';
            list.innerHTML = document.querySelector('.emailAutopilotEmptyState')?.outerHTML ||
              '<div style="text-align: center; padding: 40px; color: var(--muted2);">No email monitors configured.</div>';
            return;
          }

          // Calculate aggregate stats
          let totalActive = 0;
          let totalEmailsProcessed = 0;
          let totalInvoicesCreated = 0;
          let lastCheckTime = null;

          monitors.forEach(m => {
            if (m.is_active) totalActive++;
            totalEmailsProcessed += m.emails_processed_count || 0;
            totalInvoicesCreated += m.invoices_created_count || 0;
            if (m.last_checked_at && (!lastCheckTime || new Date(m.last_checked_at) > new Date(lastCheckTime))) {
              lastCheckTime = m.last_checked_at;
            }
          });

          // Update stats bar
          statsBar.style.display = 'block';
          document.getElementById('statActiveMonitors').textContent = totalActive;
          document.getElementById('statEmailsProcessed').textContent = totalEmailsProcessed.toLocaleString();
          document.getElementById('statInvoicesCreated').textContent = totalInvoicesCreated.toLocaleString();
          document.getElementById('statLastCheck').textContent = lastCheckTime ?
            formatRelativeTime(lastCheckTime) : '-';

          // Render monitor cards with enhanced info
          list.innerHTML = monitors.map(monitor => {
            const statusColor = monitor.is_active ? '#10b981' : '#6b7280';
            const statusText = monitor.is_active ? 'Active' : 'Paused';
            const lastError = monitor.last_error ? `<div style="color: #ef4444; font-size: 12px; margin-top: 4px;">‚ö†Ô∏è ${monitor.last_error}</div>` : '';

            return `
            <div style="background: var(--panel2); padding: 20px; border-radius: 8px; border: 1px solid ${monitor.is_active ? 'var(--border-gold)' : 'var(--border)'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; ${monitor.is_active ? 'box-shadow: 0 0 8px ' + statusColor : ''};"></span>
                    <span style="font-weight: 600; color: var(--text); font-size: 16px;">${escapeHtml(monitor.name)}</span>
                  </div>
                  <div style="font-size: 13px; color: var(--muted2); margin-bottom: 4px;">üìß ${escapeHtml(monitor.email_address)}</div>
                  <div style="font-size: 12px; color: var(--muted2);">
                    Last checked: ${monitor.last_checked_at ? formatRelativeTime(monitor.last_checked_at) : 'Never'}
                  </div>
                  ${lastError}
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center; min-width: 240px;">
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--text);">${(monitor.emails_processed_count || 0).toLocaleString()}</div>
                    <div style="font-size: 11px; color: var(--muted2);">Emails</div>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: #10b981;">${(monitor.invoices_created_count || 0).toLocaleString()}</div>
                    <div style="font-size: 11px; color: var(--muted2);">Invoices</div>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--gold);">${monitor.check_frequency_minutes || 15}m</div>
                    <div style="font-size: 11px; color: var(--muted2);">Interval</div>
                  </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px; min-width: 120px;">
                  <button onclick="checkEmailNow(${monitor.id})" class="btn" style="font-size: 12px; padding: 8px 12px; background: #6366f1;">
                    ‚ö° Check Now
                  </button>
                  <button onclick="viewMonitorActivity(${monitor.id}, '${escapeHtml(monitor.name)}')" class="btn" style="font-size: 12px; padding: 8px 12px; background: var(--panel);">
                    üìä Activity
                  </button>
                  <div style="display: flex; gap: 8px;">
                    <button onclick="toggleEmailMonitor(${monitor.id}, ${!monitor.is_active})" class="btn" style="flex: 1; font-size: 11px; padding: 6px 8px; background: ${monitor.is_active ? '#6b7280' : '#10b981'};">
                      ${monitor.is_active ? 'Pause' : 'Start'}
                    </button>
                    <button onclick="deleteEmailMonitor(${monitor.id}, '${escapeHtml(monitor.name)}')" class="btn" style="font-size: 11px; padding: 6px 8px; background: #dc2626;">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          }).join('');
        }
      } catch (error) {
        console.error('Failed to load email monitors:', error);
        document.getElementById('emailMonitorsList').innerHTML =
          '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load email monitors. Please refresh the page.</div>';
      }
    }

    // Helper: Format relative time (e.g., "5 mins ago")
    function formatRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    // Helper: Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function openAddEmailMonitor() {
      document.getElementById('addEmailMonitorModal').style.display = 'flex';
    }

    function closeAddEmailMonitor() {
      document.getElementById('addEmailMonitorModal').style.display = 'none';
      // Clear form
      document.getElementById('newMonitorName').value = '';
      document.getElementById('newMonitorEmail').value = '';
      document.getElementById('newMonitorPassword').value = '';
      document.getElementById('newMonitorImapHost').value = '';
      document.getElementById('newMonitorImapPort').value = '993';
      document.getElementById('testConnectionResult').style.display = 'none';
    }

    function openSetupGuide() {
      document.getElementById('setupGuideModal').style.display = 'flex';
    }

    function closeSetupGuide() {
      document.getElementById('setupGuideModal').style.display = 'none';
    }

    function closeMonitorActivity() {
      document.getElementById('monitorActivityModal').style.display = 'none';
    }

    // Check emails immediately for a monitor
    async function checkEmailNow(monitorId) {
      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}/check-now`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('Email check started! Refresh in a moment to see results.');
          setTimeout(loadEmailMonitors, 3000);
        } else {
          alert(`Failed to check: ${result.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // View activity log for a monitor
    async function viewMonitorActivity(monitorId, monitorName) {
      document.getElementById('monitorActivityTitle').textContent = `üìä ${monitorName} - Activity Log`;
      document.getElementById('monitorActivityModal').style.display = 'flex';
      document.getElementById('monitorActivityContent').innerHTML =
        '<div style="text-align: center; padding: 40px; color: var(--muted2);">Loading activity...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}/activity?limit=20`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const activity = result.data?.activity || [];

          if (activity.length === 0) {
            document.getElementById('monitorActivityContent').innerHTML =
              '<div style="text-align: center; padding: 40px; color: var(--muted2);">No activity yet. Emails will appear here once processed.</div>';
            return;
          }

          document.getElementById('monitorActivityContent').innerHTML = `
            <div style="display: grid; gap: 8px;">
              ${activity.map(item => {
                const statusColor = item.status === 'success' ? '#10b981' :
                                    item.status === 'error' ? '#ef4444' : '#6b7280';
                const statusIcon = item.status === 'success' ? '‚úì' :
                                   item.status === 'error' ? '‚úó' : '‚è≠Ô∏è';
                return `
                  <div style="background: var(--panel2); padding: 12px 16px; border-radius: 6px; border-left: 3px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <span style="color: ${statusColor}; font-weight: 600;">${statusIcon}</span>
                        <span style="color: var(--text); margin-left: 8px;">${escapeHtml(item.email_subject || 'No subject')}</span>
                      </div>
                      <span style="color: var(--muted2); font-size: 12px;">${formatRelativeTime(item.processed_at)}</span>
                    </div>
                    ${item.invoices_created > 0 ? `<div style="font-size: 12px; color: #10b981; margin-top: 4px;">üìÑ Created ${item.invoices_created} invoice(s)</div>` : ''}
                    ${item.error_message ? `<div style="font-size: 12px; color: #ef4444; margin-top: 4px;">Error: ${escapeHtml(item.error_message)}</div>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('monitorActivityContent').innerHTML =
          `<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load activity: ${error.message}</div>`;
      }
    }

    async function detectIMAPSettings() {
      const email = document.getElementById('newMonitorEmail').value.trim();
      if (!email) return;

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/detect-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({ email })
        });

        if (response.ok) {
          const result = await response.json();
          if (result.settings) {
            document.getElementById('newMonitorImapHost').value = result.settings.imap_host;
            document.getElementById('newMonitorImapPort').value = result.settings.imap_port;
          }
        }
      } catch (error) {
        console.error('Failed to detect IMAP settings:', error);
      }
    }

    async function testIMAPConnection() {
      const email = document.getElementById('newMonitorEmail').value.trim();
      const password = document.getElementById('newMonitorPassword').value;
      const imapHost = document.getElementById('newMonitorImapHost').value.trim();
      const imapPort = document.getElementById('newMonitorImapPort').value;

      if (!email || !password || !imapHost) {
        alert('Please fill in email, password, and IMAP server first');
        return;
      }

      const resultDiv = document.getElementById('testConnectionResult');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div style="color: var(--muted);">Testing connection...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/test-connection`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            email_address: email,
            email_password: password,
            imap_host: imapHost,
            imap_port: parseInt(imapPort)
          })
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">‚úì Connection successful!</div>';
        } else {
          resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">‚úó Connection failed: ${result.error}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div style="color: #ef4444; font-weight: 600;">‚úó Connection failed: ${error.message}</div>`;
      }
    }

    async function createEmailMonitor() {
      const name = document.getElementById('newMonitorName').value.trim();
      const email_address = document.getElementById('newMonitorEmail').value.trim();
      const email_password = document.getElementById('newMonitorPassword').value;
      const imap_host = document.getElementById('newMonitorImapHost').value.trim();
      const imap_port = parseInt(document.getElementById('newMonitorImapPort').value);

      if (!name || !email_address || !email_password || !imap_host) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            name,
            email_address,
            email_password,
            imap_host,
            imap_port,
            imap_secure: true,
            folder: 'INBOX',
            check_interval_minutes: 15
          })
        });

        const result = await response.json();

        if (result.success) {
          alert('Email monitor created successfully!');
          closeAddEmailMonitor();
          loadEmailMonitors();
        } else {
          alert(`Failed to create monitor: ${result.error}`);
        }
      } catch (error) {
        alert(`Error creating monitor: ${error.message}`);
      }
    }

    async function toggleEmailMonitor(monitorId, isActive) {
      try {
        const url = isActive ?
          `${API_BASE}/api/email-monitors/${monitorId}/start` :
          `${API_BASE}/api/email-monitors/${monitorId}/stop`;

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          loadEmailMonitors();
        } else {
          alert(`Failed to ${isActive ? 'start' : 'stop'} monitor: ${result.error}`);
          loadEmailMonitors();
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
        loadEmailMonitors();
      }
    }

    async function deleteEmailMonitor(monitorId, monitorName) {
      if (!confirm(`Are you sure you want to delete the email monitor "${monitorName}"?\n\nThis will stop monitoring this email and cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/email-monitors/${monitorId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        const result = await response.json();

        if (result.success) {
          loadEmailMonitors();
        } else {
          alert(`Failed to delete monitor: ${result.error}`);
        }
      } catch (error) {
        alert(`Error deleting monitor: ${error.message}`);
      }
    }

    // =====================================================
    // PAYROLL & EXPENSE ENTRY FUNCTIONS
    // =====================================================

    // Chart instances (for cleanup)
    let expenseBreakdownChart = null;
    let spendingTrendChart = null;

    // Open payroll entry form (scroll to it)
    function openPayrollEntry() {
      const payrollForm = document.getElementById('payrollForm');
      if (payrollForm) {
        payrollForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Focus on first input
        setTimeout(() => {
          document.getElementById('payrollStart')?.focus();
        }, 300);
      }
    }

    // Open expense entry form (scroll to it)
    function openExpenseEntry() {
      const expenseForm = document.getElementById('expenseForm');
      if (expenseForm) {
        expenseForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Focus on first input
        setTimeout(() => {
          document.getElementById('expenseCategory')?.focus();
        }, 300);
      }
    }

    // Submit payroll entry
    async function submitPayroll(event) {
      event.preventDefault();

      const payrollData = {
        period_start: document.getElementById('payrollStart').value,
        period_end: document.getElementById('payrollEnd').value,
        gross_payroll_cents: Math.round(parseFloat(document.getElementById('payrollGross').value) * 100), // Convert to cents
        employee_count: parseInt(document.getElementById('payrollEmployees').value) || null,
        hours_worked: parseFloat(document.getElementById('payrollHours').value) || null,
        notes: document.getElementById('payrollNotes').value || null
      };

      const statusDiv = document.getElementById('payrollStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">Saving payroll entry...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/bi/payroll`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify(payrollData)
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">‚úì Payroll entry saved successfully!</div>';
          // Reset form
          document.getElementById('payrollForm').reset();
          setDefaultDates();
          // Refresh charts
          loadFinancialCharts();
          // Clear status after 3 seconds
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
          statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${result.error || 'Failed to save payroll'}</div>`;
        }
      } catch (error) {
        console.error('Payroll submission error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    // Submit expense entry
    async function submitExpense(event) {
      event.preventDefault();

      const expenseDate = document.getElementById('expenseDate').value;
      const expenseData = {
        category: document.getElementById('expenseCategory').value,
        period_start: expenseDate,
        period_end: expenseDate,
        amount_cents: Math.round(parseFloat(document.getElementById('expenseAmount').value) * 100), // Convert to cents
        vendor_name: document.getElementById('expenseVendor').value || null,
        description: document.getElementById('expenseNotes').value || null
      };

      const statusDiv = document.getElementById('expenseStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">Saving expense entry...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/bi/expenses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify(expenseData)
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">‚úì Expense entry saved successfully!</div>';
          // Reset form
          document.getElementById('expenseForm').reset();
          document.getElementById('expenseDate').value = getTodayDate();
          // Refresh charts
          loadFinancialCharts();
          // Clear status after 3 seconds
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
          statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${result.error || 'Failed to save expense'}</div>`;
        }
      } catch (error) {
        console.error('Expense submission error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      }
    }

    // View payroll history
    function viewPayrollHistory() {
      window.location.href = 'payroll-history.html';
    }

    // View expense history
    function viewExpenseHistory() {
      window.location.href = 'expense-history.html';
    }

    // Set default dates for forms
    function setDefaultDates() {
      const today = new Date();
      const twoWeeksAgo = new Date(today);
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);

      // Payroll defaults to last 2 weeks
      const payrollStart = document.getElementById('payrollStart');
      const payrollEnd = document.getElementById('payrollEnd');
      if (payrollStart) payrollStart.value = twoWeeksAgo.toISOString().split('T')[0];
      if (payrollEnd) payrollEnd.value = today.toISOString().split('T')[0];

      // Expense defaults to today
      const expenseDate = document.getElementById('expenseDate');
      if (expenseDate) expenseDate.value = today.toISOString().split('T')[0];
    }

    // =====================================================
    // FINANCIAL CHARTS FUNCTIONS
    // =====================================================

    async function loadFinancialCharts() {
      const period = document.getElementById('chartPeriod')?.value || 30;

      try {
        // Fetch financial summary data
        const response = await fetch(`${API_BASE}/api/bi/financial-summary?days=${period}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            renderFinancialSummary(result.data);
            renderExpenseBreakdownChart(result.data.breakdown || []);
            renderSpendingTrendChart(result.data.trend || []);
            renderBudgetComparison(result.data.budget || []);
          }
        } else {
          // If API not ready, show demo data
          renderDemoFinancialData();
        }
      } catch (error) {
        console.error('Failed to load financial charts:', error);
        // Show demo data on error
        renderDemoFinancialData();
      }
    }

    function renderFinancialSummary(data) {
      const totals = data.totals || {};
      document.getElementById('chartTotalExpenses').textContent = '$' + ((totals.expenses || 0) / 100).toLocaleString();
      document.getElementById('chartTotalPayroll').textContent = '$' + ((totals.payroll || 0) / 100).toLocaleString();
      document.getElementById('chartTotalInventory').textContent = '$' + ((totals.inventory || 0) / 100).toLocaleString();
      document.getElementById('chartTotalSavings').textContent = '$' + ((totals.savings || 0) / 100).toLocaleString();
    }

    function renderExpenseBreakdownChart(breakdown) {
      const ctx = document.getElementById('expenseBreakdownChart');
      if (!ctx) return;

      // Destroy existing chart
      if (expenseBreakdownChart) {
        expenseBreakdownChart.destroy();
      }

      const labels = breakdown.map(b => b.category);
      const values = breakdown.map(b => b.amount / 100);
      const colors = [
        '#fbbf24', // Gold - Payroll
        '#3b82f6', // Blue - Inventory
        '#10b981', // Green - Utilities
        '#ef4444', // Red - Rent
        '#8b5cf6', // Purple - Supplies
        '#f59e0b', // Orange - Other
      ];

      expenseBreakdownChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            data: values.length > 0 ? values : [1],
            backgroundColor: colors.slice(0, labels.length || 1),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(255,255,255,0.7)',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    function renderSpendingTrendChart(trend) {
      const ctx = document.getElementById('spendingTrendChart');
      if (!ctx) return;

      // Destroy existing chart
      if (spendingTrendChart) {
        spendingTrendChart.destroy();
      }

      const labels = trend.map(t => t.date);
      const values = trend.map(t => t.amount / 100);

      spendingTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            label: 'Spending',
            data: values.length > 0 ? values : [0],
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointBackgroundColor: '#fbbf24'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: {
                color: 'rgba(255,255,255,0.5)',
                font: { size: 10 },
                callback: value => '$' + value.toLocaleString()
              }
            }
          }
        }
      });
    }

    function renderBudgetComparison(budgetData) {
      const container = document.getElementById('budgetComparison');
      if (!container) return;

      if (!budgetData || budgetData.length === 0) {
        // Show demo budget data
        budgetData = [
          { category: 'Payroll', budget: 5000000, actual: 4800000 },
          { category: 'Inventory', budget: 2000000, actual: 2100000 },
          { category: 'Utilities', budget: 500000, actual: 450000 },
          { category: 'Rent', budget: 300000, actual: 300000 }
        ];
      }

      container.innerHTML = budgetData.map(item => {
        const budgetDollars = item.budget / 100;
        const actualDollars = item.actual / 100;
        const percentage = Math.min((item.actual / item.budget) * 100, 100);
        const isOver = item.actual > item.budget;
        const barColor = isOver ? '#ef4444' : '#10b981';

        return `
          <div style="background: var(--panel2); padding: 12px 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: var(--text); font-weight: 600; font-size: 13px;">${item.category}</span>
              <span style="color: ${isOver ? '#ef4444' : '#10b981'}; font-size: 12px; font-weight: 600;">
                $${actualDollars.toLocaleString()} / $${budgetDollars.toLocaleString()}
              </span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width: ${percentage}%; background: ${barColor};"></div>
            </div>
            ${isOver ? `<div style="font-size: 11px; color: #ef4444; margin-top: 4px;">‚ö†Ô∏è Over budget by $${((item.actual - item.budget) / 100).toLocaleString()}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Demo data when API not ready
    function renderDemoFinancialData() {
      // Update summary with demo values
      document.getElementById('chartTotalExpenses').textContent = '$48,250';
      document.getElementById('chartTotalPayroll').textContent = '$32,500';
      document.getElementById('chartTotalInventory').textContent = '$12,800';
      document.getElementById('chartTotalSavings').textContent = '$2,340';

      // Demo expense breakdown
      renderExpenseBreakdownChart([
        { category: 'Payroll', amount: 3250000 },
        { category: 'Inventory', amount: 1280000 },
        { category: 'Utilities', amount: 450000 },
        { category: 'Rent', amount: 350000 },
        { category: 'Supplies', amount: 495000 }
      ]);

      // Demo spending trend (last 7 days)
      const today = new Date();
      const trendData = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        trendData.push({
          date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          amount: Math.floor(Math.random() * 500000) + 100000
        });
      }
      renderSpendingTrendChart(trendData);

      // Demo budget comparison
      renderBudgetComparison([
        { category: 'Payroll', budget: 3500000, actual: 3250000 },
        { category: 'Inventory', budget: 1500000, actual: 1280000 },
        { category: 'Utilities', budget: 400000, actual: 450000 },
        { category: 'Rent', budget: 350000, actual: 350000 }
      ]);
    }

    // Initialize financial features on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Set default dates for payroll and expense forms
      setTimeout(setDefaultDates, 100);

      // Load financial charts
      setTimeout(loadFinancialCharts, 500);
    });

    // =====================================================
    // PAYROLL FILE UPLOAD FUNCTIONS
    // =====================================================

    let selectedPayrollFile = null;

    function openPayrollUpload() {
      document.getElementById('payrollUploadModal').style.display = 'flex';
      clearPayrollFile();
    }

    function closePayrollUpload() {
      document.getElementById('payrollUploadModal').style.display = 'none';
      clearPayrollFile();
    }

    function clearPayrollFile() {
      selectedPayrollFile = null;
      document.getElementById('payrollFileInput').value = '';
      document.getElementById('payrollFileInfo').style.display = 'none';
      document.getElementById('payrollUploadBtn').disabled = true;
      document.getElementById('payrollUploadStatus').style.display = 'none';
    }

    function handlePayrollDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--gold)';
      document.getElementById('payrollDropZone').style.background = 'rgba(251, 191, 36, 0.05)';
    }

    function handlePayrollDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--border)';
      document.getElementById('payrollDropZone').style.background = 'transparent';
    }

    function handlePayrollDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('payrollDropZone').style.borderColor = 'var(--border)';
      document.getElementById('payrollDropZone').style.background = 'transparent';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processPayrollFile(files[0]);
      }
    }

    function handlePayrollFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) {
        processPayrollFile(files[0]);
      }
    }

    function processPayrollFile(file) {
      const validTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
        'application/vnd.ms-excel', // xls
        'text/csv',
        'application/pdf'
      ];
      const validExtensions = ['.xlsx', '.xls', '.csv', '.pdf'];
      const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

      if (!validExtensions.includes(ext)) {
        alert('Please upload an Excel (.xlsx, .xls), CSV, or PDF file.');
        return;
      }

      selectedPayrollFile = file;
      document.getElementById('payrollFileName').textContent = file.name;
      document.getElementById('payrollFileSize').textContent = formatFileSize(file.size);
      document.getElementById('payrollFileInfo').style.display = 'block';
      document.getElementById('payrollUploadBtn').disabled = false;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function uploadPayrollFile() {
      if (!selectedPayrollFile) {
        alert('Please select a file first.');
        return;
      }

      const statusDiv = document.getElementById('payrollUploadStatus');
      const uploadBtn = document.getElementById('payrollUploadBtn');

      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--gold);">üì§ Uploading and processing file...</div>';
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Processing...';

      try {
        const ext = selectedPayrollFile.name.toLowerCase().substring(selectedPayrollFile.name.lastIndexOf('.'));
        let payrollData = null;

        // Parse the file based on type
        if (ext === '.xlsx' || ext === '.xls') {
          payrollData = await parseExcelPayroll(selectedPayrollFile);
        } else if (ext === '.csv') {
          payrollData = await parseCSVPayroll(selectedPayrollFile);
        } else if (ext === '.pdf') {
          payrollData = await parsePDFPayroll(selectedPayrollFile);
        }

        if (!payrollData || payrollData.entries.length === 0) {
          throw new Error('Could not extract payroll data from file. Please check the format or try a different export.');
        }

        // Get optional period dates
        const periodStart = document.getElementById('payrollUploadStart').value;
        const periodEnd = document.getElementById('payrollUploadEnd').value;
        const provider = document.getElementById('payrollProvider').value;

        // Send to API
        const response = await fetch(`${API_BASE}/api/bi/payroll/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            entries: payrollData.entries,
            provider: provider || payrollData.detectedProvider,
            period_start: periodStart || payrollData.periodStart,
            period_end: periodEnd || payrollData.periodEnd,
            filename: selectedPayrollFile.name,
            summary: payrollData.summary
          })
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `
            <div style="color: #10b981; font-weight: 600;">‚úì Payroll uploaded successfully!</div>
            <div style="color: var(--muted); font-size: 13px; margin-top: 8px;">
              Processed ${result.data?.entriesCreated || payrollData.entries.length} payroll entries.
              ${result.data?.totalAmount ? `Total: $${(result.data.totalAmount / 100).toLocaleString()}` : ''}
            </div>
          `;
          // Refresh charts after successful upload
          setTimeout(() => {
            loadFinancialCharts();
            closePayrollUpload();
          }, 2000);
        } else {
          throw new Error(result.error || 'Failed to upload payroll data');
        }
      } catch (error) {
        console.error('Payroll upload error:', error);
        statusDiv.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload & Process';
      }
    }

    // Parse Excel payroll files (ADP, Toast, Gusto, etc.)
    async function parseExcelPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            // Detect provider and parse accordingly
            const parsed = parsePayrollRows(rows, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse Excel file: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Parse CSV payroll files
    async function parseCSVPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const rows = text.split('\n').map(row => {
              // Handle quoted CSV values
              const result = [];
              let cell = '';
              let inQuotes = false;
              for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  result.push(cell.trim());
                  cell = '';
                } else {
                  cell += char;
                }
              }
              result.push(cell.trim());
              return result;
            });

            const parsed = parsePayrollRows(rows, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse CSV file: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }

    // Parse PDF payroll files (extract text and try to find amounts)
    async function parsePDFPayroll(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            if (typeof pdfjsLib === 'undefined') {
              // Fallback: just extract basic info
              resolve({
                entries: [{
                  description: 'Payroll from PDF',
                  gross_amount_cents: 0,
                  needs_manual_entry: true
                }],
                detectedProvider: 'pdf',
                summary: { message: 'PDF files require manual verification. Please review the extracted data.' }
              });
              return;
            }

            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }

            // Extract amounts from PDF text
            const parsed = extractPayrollFromText(fullText, file.name);
            resolve(parsed);
          } catch (err) {
            reject(new Error('Failed to parse PDF: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    // Common payroll parsing logic for Excel/CSV rows
    function parsePayrollRows(rows, filename) {
      const entries = [];
      let detectedProvider = null;
      let periodStart = null;
      let periodEnd = null;

      // Try to detect provider from filename or headers
      const lowerFilename = filename.toLowerCase();
      if (lowerFilename.includes('adp')) detectedProvider = 'adp';
      else if (lowerFilename.includes('toast')) detectedProvider = 'toast';
      else if (lowerFilename.includes('gusto')) detectedProvider = 'gusto';
      else if (lowerFilename.includes('quickbooks') || lowerFilename.includes('qb')) detectedProvider = 'quickbooks';
      else if (lowerFilename.includes('paychex')) detectedProvider = 'paychex';
      else if (lowerFilename.includes('square')) detectedProvider = 'square';

      // Find header row and important columns
      let headerRow = -1;
      let colMap = {};

      const possibleHeaders = {
        employee: ['employee', 'name', 'employee name', 'worker', 'team member'],
        gross: ['gross', 'gross pay', 'gross wages', 'total gross', 'earnings', 'total earnings', 'gross amount'],
        net: ['net', 'net pay', 'net wages', 'take home', 'net amount'],
        hours: ['hours', 'hours worked', 'total hours', 'reg hours', 'regular hours'],
        date: ['date', 'pay date', 'check date', 'period end', 'period ending'],
        department: ['department', 'dept', 'location', 'store']
      };

      for (let i = 0; i < Math.min(rows.length, 20); i++) {
        const row = rows[i];
        if (!row) continue;

        const rowLower = row.map(cell => String(cell || '').toLowerCase().trim());

        // Check if this looks like a header row
        let matchCount = 0;
        for (const [key, variants] of Object.entries(possibleHeaders)) {
          for (let j = 0; j < rowLower.length; j++) {
            if (variants.some(v => rowLower[j].includes(v))) {
              colMap[key] = j;
              matchCount++;
              break;
            }
          }
        }

        if (matchCount >= 2) {
          headerRow = i;
          break;
        }
      }

      // If no header found, try to parse as simple table
      if (headerRow === -1) {
        // Look for rows with dollar amounts
        for (const row of rows) {
          if (!row) continue;
          for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || '');
            const match = cell.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              const amount = parseFloat(match[1].replace(/,/g, ''));
              if (amount > 100 && amount < 1000000) { // Reasonable payroll amount
                entries.push({
                  description: row[0] || 'Payroll entry',
                  gross_amount_cents: Math.round(amount * 100)
                });
                break;
              }
            }
          }
        }
      } else {
        // Parse data rows after header
        for (let i = headerRow + 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.every(cell => !cell)) continue;

          const entry = {
            employee_name: colMap.employee !== undefined ? String(row[colMap.employee] || '') : null,
            gross_amount_cents: 0,
            net_amount_cents: 0,
            hours: 0,
            department: colMap.department !== undefined ? String(row[colMap.department] || '') : null
          };

          // Parse gross amount
          if (colMap.gross !== undefined) {
            const grossStr = String(row[colMap.gross] || '');
            const match = grossStr.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              entry.gross_amount_cents = Math.round(parseFloat(match[1].replace(/,/g, '')) * 100);
            }
          }

          // Parse net amount
          if (colMap.net !== undefined) {
            const netStr = String(row[colMap.net] || '');
            const match = netStr.match(/\$?([\d,]+\.?\d*)/);
            if (match) {
              entry.net_amount_cents = Math.round(parseFloat(match[1].replace(/,/g, '')) * 100);
            }
          }

          // Parse hours
          if (colMap.hours !== undefined) {
            const hoursStr = String(row[colMap.hours] || '');
            const match = hoursStr.match(/([\d.]+)/);
            if (match) {
              entry.hours = parseFloat(match[1]);
            }
          }

          // Parse date for period info
          if (colMap.date !== undefined && !periodEnd) {
            const dateStr = String(row[colMap.date] || '');
            const dateMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
            if (dateMatch) {
              const year = dateMatch[3].length === 2 ? '20' + dateMatch[3] : dateMatch[3];
              periodEnd = `${year}-${dateMatch[1].padStart(2, '0')}-${dateMatch[2].padStart(2, '0')}`;
            }
          }

          // Only add entries with valid amounts
          if (entry.gross_amount_cents > 0 || entry.net_amount_cents > 0) {
            entries.push(entry);
          }
        }
      }

      // Calculate summary
      const totalGross = entries.reduce((sum, e) => sum + (e.gross_amount_cents || 0), 0);
      const totalHours = entries.reduce((sum, e) => sum + (e.hours || 0), 0);

      return {
        entries,
        detectedProvider,
        periodStart,
        periodEnd,
        summary: {
          employeeCount: entries.length,
          totalGrossCents: totalGross,
          totalHours: totalHours,
          avgGrossCents: entries.length > 0 ? Math.round(totalGross / entries.length) : 0
        }
      };
    }

    // Extract payroll data from PDF text
    function extractPayrollFromText(text, filename) {
      const entries = [];
      let detectedProvider = null;

      // Detect provider from text
      const lowerText = text.toLowerCase();
      if (lowerText.includes('adp')) detectedProvider = 'adp';
      else if (lowerText.includes('toast')) detectedProvider = 'toast';
      else if (lowerText.includes('gusto')) detectedProvider = 'gusto';
      else if (lowerText.includes('quickbooks')) detectedProvider = 'quickbooks';
      else if (lowerText.includes('paychex')) detectedProvider = 'paychex';

      // Look for dollar amounts that could be payroll totals
      const amountPattern = /(?:gross|net|total|pay|wages|earnings)[:\s]*\$?([\d,]+\.?\d*)/gi;
      let match;
      while ((match = amountPattern.exec(text)) !== null) {
        const amount = parseFloat(match[1].replace(/,/g, ''));
        if (amount > 100 && amount < 1000000) {
          entries.push({
            description: match[0].substring(0, 50),
            gross_amount_cents: Math.round(amount * 100)
          });
        }
      }

      // If no structured data found, look for any large dollar amounts
      if (entries.length === 0) {
        const simplePattern = /\$([\d,]+\.?\d*)/g;
        while ((match = simplePattern.exec(text)) !== null) {
          const amount = parseFloat(match[1].replace(/,/g, ''));
          if (amount > 500 && amount < 500000) {
            entries.push({
              description: 'Payroll amount from PDF',
              gross_amount_cents: Math.round(amount * 100)
            });
          }
        }
      }

      const totalGross = entries.reduce((sum, e) => sum + (e.gross_amount_cents || 0), 0);

      return {
        entries,
        detectedProvider,
        summary: {
          extractedAmounts: entries.length,
          totalGrossCents: totalGross,
          source: 'pdf'
        }
      };
    }
  </script>

  <!-- Proof Modal -->
  <div class="modal-overlay" id="proofModal" onclick="closeProofModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="proofModalTitle">Invoice Proof</div>
        <button class="modal-close" onclick="closeProofModal()">&times;</button>
      </div>
      <div class="modal-body" id="proofModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Location Breakdown Modal -->
  <div class="modal-overlay" id="locationModal" onclick="closeLocationModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">üìç Invoices by Location</div>
        <button class="modal-close" onclick="closeLocationModal()">&times;</button>
      </div>
      <div class="modal-body" id="locationModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // PROOF MODAL FUNCTIONS
    // ========================================

    function showProof(issueData) {
      const modal = document.getElementById('proofModal');
      const title = document.getElementById('proofModalTitle');
      const body = document.getElementById('proofModalBody');

      title.textContent = `Proof: ${issueData.vendorName} - ${issueData.issueType}`;

      // Generate proof content with highlighted invoice preview
      body.innerHTML = `
        <div class="proof-summary">
          <div class="proof-stat">
            <div class="proof-stat-label">You're Being Charged</div>
            <div class="proof-stat-value">${formatMoney(issueData.currentChargeCents)}</div>
          </div>
          <div class="proof-stat">
            <div class="proof-stat-label">Should Be</div>
            <div class="proof-stat-value savings">${formatMoney(issueData.expectedChargeCents)}</div>
          </div>
          <div class="proof-stat">
            <div class="proof-stat-label">Your Savings</div>
            <div class="proof-stat-value delta">${formatMoney(issueData.deltaCents)}</div>
          </div>
        </div>

        <div class="invoice-preview">
          <div class="invoice-header">
            <div class="invoice-vendor">${issueData.vendorName}</div>
            <div class="invoice-meta">Invoice Date: ${formatDate(issueData.invoiceDate)} ‚Ä¢ Location: ${issueData.locationName}</div>
          </div>

          <div style="margin-top: 16px;">
            ${generateInvoiceLines(issueData)}
          </div>
        </div>

        <div class="issue-explanation">
          <div class="explanation-title">
            <span>üí°</span>
            What We Found
          </div>
          <div class="explanation-text">
            ${generateExplanation(issueData)}
          </div>
          <div class="explanation-action">
            <strong>Recommended Action:</strong> ${generateRecommendation(issueData)}
          </div>
        </div>
      `;

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeProofModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('proofModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function generateInvoiceLines(issue) {
      // Generate sample invoice lines with the flagged item highlighted
      const lines = [];

      // Add some context lines before the flagged item
      lines.push(`
        <div class="invoice-line">
          <div class="line-desc">Standard Service Fee</div>
          <div class="line-qty">1 x</div>
          <div class="line-amount">$45.00</div>
        </div>
      `);

      // The flagged line item
      lines.push(`
        <div class="invoice-line highlighted">
          <div>
            <div class="line-desc">${issue.itemDescription || issue.issueType}</div>
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              ${issue.sku || 'SKU: N/A'} ‚Ä¢ ${issue.locationName}
            </div>
          </div>
          <div class="line-qty">${issue.quantity || 1} x</div>
          <div>
            <div class="line-amount flagged">${formatMoney(issue.currentChargeCents)}</div>
            <div class="line-expected">Should be: ${formatMoney(issue.expectedChargeCents)}</div>
          </div>
        </div>
      `);

      // Add a line after
      lines.push(`
        <div class="invoice-line">
          <div class="line-desc">Delivery/Handling</div>
          <div class="line-qty">1 x</div>
          <div class="line-amount">$25.00</div>
        </div>
      `);

      // Total line
      const total = (issue.currentChargeCents / 100) + 70; // sample total
      lines.push(`
        <div class="invoice-line" style="border-bottom: none; margin-top: 12px; padding-top: 12px; border-top: 2px solid #1a1a1a;">
          <div class="line-desc" style="font-weight: 700;">TOTAL</div>
          <div></div>
          <div class="line-amount" style="font-size: 16px;">$${total.toFixed(2)}</div>
        </div>
      `);

      return lines.join('');
    }

    function generateExplanation(issue) {
      const typeExplanations = {
        'price_increase': `We detected a <strong>price increase</strong> on this line item compared to your contract or historical pricing. The vendor is charging ${formatMoney(issue.currentChargeCents)} but based on your agreement, it should be ${formatMoney(issue.expectedChargeCents)}.`,
        'overcharge': `This item is being <strong>overcharged</strong> by ${formatMoney(issue.deltaCents)}. Our analysis compared this against your MLA contract pricing and found a discrepancy.`,
        'quantity_error': `We found a <strong>quantity discrepancy</strong>. The invoice shows more units than what was actually delivered or ordered.`,
        'duplicate_charge': `This appears to be a <strong>duplicate charge</strong>. We found a similar line item on a previous invoice within this billing cycle.`,
        'contract_violation': `This charge <strong>violates your contract terms</strong>. Based on your MLA, this item should be priced at ${formatMoney(issue.expectedChargeCents)}.`,
        'default': `We identified a pricing discrepancy of <strong>${formatMoney(issue.deltaCents)}</strong> on this invoice. The current charge of ${formatMoney(issue.currentChargeCents)} exceeds the expected amount of ${formatMoney(issue.expectedChargeCents)}.`
      };

      return typeExplanations[issue.issueType] || typeExplanations['default'];
    }

    function generateRecommendation(issue) {
      const recommendations = {
        'price_increase': 'Contact your vendor representative and reference your contract pricing. Request a credit memo for the overcharge.',
        'overcharge': 'File a dispute with your vendor citing the contract rate. Include this proof documentation.',
        'quantity_error': 'Verify delivery receipts and request an invoice adjustment for the correct quantity.',
        'duplicate_charge': 'Contact accounts payable at the vendor and request removal of the duplicate charge.',
        'contract_violation': 'Escalate to your account manager with your MLA documentation. Request immediate correction.',
        'default': 'Review with your vendor and request a credit for the difference. Keep this proof for your records.'
      };

      return recommendations[issue.issueType] || recommendations['default'];
    }

    // ========================================
    // LOCATION MODAL FUNCTIONS
    // ========================================

    function showLocationBreakdown() {
      const modal = document.getElementById('locationModal');
      const body = document.getElementById('locationModalBody');

      body.innerHTML = '<div class="loadingState">Loading location data...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load location data
      loadLocationModalData();
    }

    async function loadLocationModalData() {
      const body = document.getElementById('locationModalBody');

      try {
        const data = await fetchAPI(`/api/dashboard/breakdown/locations?${buildQueryString(filters)}`);
        const rows = data.rows || [];

        if (rows.length === 0) {
          body.innerHTML = '<div class="emptyState">No location data available</div>';
          return;
        }

        const sorted = rows.sort((a, b) => b.invoicesCount - a.invoicesCount);

        const html = `
          <div style="margin-bottom: 20px; padding: 16px; background: var(--panel2); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Total Locations</div>
              <div style="font-size: 28px; font-weight: 800; color: var(--text-bright);">${sorted.length}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Total Invoices</div>
              <div style="font-size: 28px; font-weight: 800; color: var(--gold);">${sorted.reduce((sum, r) => sum + (r.invoicesCount || 0), 0).toLocaleString()}</div>
            </div>
          </div>

          <div class="location-list">
            ${sorted.map((row, idx) => `
              <div class="location-item">
                <div>
                  <div class="location-name">
                    <span style="color: var(--muted); margin-right: 8px;">#${idx + 1}</span>
                    ${row.name}
                  </div>
                  <div class="location-meta">
                    ${row.issuesCount || 0} flagged issues ‚Ä¢ ${formatMoney(row.amountCents || 0)} potential savings
                  </div>
                </div>
                <div class="location-stats">
                  <div class="location-invoices">${(row.invoicesCount || 0).toLocaleString()}</div>
                  <div class="location-savings">invoices analyzed</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        body.innerHTML = html;
      } catch (error) {
        body.innerHTML = `
          <div class="errorState">
            <div class="errorTitle">Failed to load locations</div>
            <div class="errorMsg">${error.message}</div>
          </div>
        `;
      }
    }

    function closeLocationModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('locationModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeProofModal();
        closeLocationModal();
      }
    });
  </script>
</body>
</html>
